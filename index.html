<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>DentalOS PWA</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1020">
  <style>
    body{margin:0;font-family:"Vazirmatn","IRANSans",sans-serif;color:#eaf3ff;background:linear-gradient(180deg,rgba(255,255,255,.02),#0b1020 100%);overflow:hidden}
    header{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.05);backdrop-filter:blur(12px);padding:8px 16px}
    .version{background:#00e5ff;color:#0b1020;padding:2px 6px;border-radius:8px;font-size:12px}
    .title{font-weight:bold}
    .status-dot{width:10px;height:10px;border-radius:50%;margin-left:8px}
    main{padding:16px}
    #form{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    #form input{background:rgba(255,255,255,.08);color:#eaf3ff;border:none;border-radius:8px;padding:8px}
    #form button{background:#00e5ff;color:#0b1020;border:none;border-radius:8px;padding:8px;font-weight:bold;cursor:pointer}
    .explain{font-size:14px;color:#b6c2d1;margin:12px 0}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead{background:rgba(255,255,255,.05)}
    th,td{padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1)}
    footer{position:fixed;bottom:0;width:100%;padding:8px 0;text-align:center;font-size:12px;color:#b6c2d1;background:rgba(255,255,255,.05)}
  </style>
</head>
<body>
<header>
  <span class="version">v1</span>
  <span class="title">DentalOS • PWA</span>
  <span class="status-dot" id="status"></span>
</header>

<main>
  <div id="form">
    <label>نام خدمت</label>
    <input id="serviceName" type="text" placeholder="مثلاً: کامپوزیت">
    <label>قیمت (تومان)</label>
    <input id="servicePrice" type="number" placeholder="مثلاً: 5000000">
    <button id="addButton">افزودن/ثبت</button>
  </div>
  <p id="explain" class="explain">تغییراتی که منشی یا شما ثبت کنید، بلافاصله روی تمام گوشی‌ها نمایش داده می‌شود. در حالت آفلاین، در صف ذخیره می‌شود و با اتصال، خودکار اعمال می‌گردد.</p>
  <div id="list">
    <h3>لیست قیمت‌ها</h3>
    <table>
      <thead>
        <tr><th>نام خدمت</th><th>قیمت (تومان)</th><th>ویرایش</th></tr>
      </thead>
      <tbody id="pricesBody"></tbody>
    </table>
  </div>
</main>

<footer>
  DentalOS • PWA • Supabase Realtime • Backup & Auto-Update
</footer>

<!-- کتابخانهٔ Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
/*** تنظیمات Supabase: این مقادیر را با آدرس و کلید پروژهٔ خودتان جایگزین کنید ***/
const SUPABASE_URL = 'https://YOUR_SUPABASE_URL.supabase.co';
const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/*** عناصر و متغیرها ***/
const statusDot   = document.getElementById('status');
const nameInput   = document.getElementById('serviceName');
const priceInput  = document.getElementById('servicePrice');
const addButton   = document.getElementById('addButton');
const pricesBody  = document.getElementById('pricesBody');

let isOnline    = navigator.onLine;
let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');

/*** به‌روزرسانی وضعیت اتصال و همگام‌سازی صف آفلاین ***/
function updateStatus(){
  isOnline = navigator.onLine;
  statusDot.style.backgroundColor = isOnline ? '#00e559' : '#b6c2d1';
  if(isOnline) syncOfflineQueue();
}
window.addEventListener('online', updateStatus);
window.addEventListener('offline', updateStatus);
updateStatus();

/*** بارگذاری و نمایش قیمت‌ها از جدول Supabase ***/
async function loadPrices(){
  const { data, error } = await supabase.from('prices').select().order('id');
  if(!error) renderPrices(data || []);
}
function renderPrices(prices){
  pricesBody.innerHTML = '';
  prices.forEach(row=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.name}</td><td>${row.price.toLocaleString('fa')}</td><td><button data-id="${row.id}">ویرایش</button></td>`;
    pricesBody.appendChild(tr);
  });
}
loadPrices();

/*** ثبت قیمت جدید ***/
addButton.onclick = async ()=>{
  const name  = nameInput.value.trim();
  const price = parseInt(priceInput.value,10);
  if(!name || isNaN(price)){
    alert('لطفاً نام خدمت و قیمت را وارد کنید.');
    return;
  }
  const record = { name, price };
  if(isOnline){
    await supabase.from('prices').insert(record);
  }else{
    offlineQueue.push({ type:'insert', data: record });
    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
  }
  nameInput.value  = '';
  priceInput.value = '';
};

/*** همگام‌سازی صف آفلاین ***/
async function syncOfflineQueue(){
  if(!offlineQueue.length) return;
  const queue = [...offlineQueue];
  offlineQueue = [];
  localStorage.setItem('offlineQueue', JSON.stringify([]));
  for(const item of queue){
    if(item.type === 'insert'){
      await supabase.from('prices').insert(item.data);
    }
    // می‌توانید انواع دیگر عملیات را نیز اضافه کنید
  }
}

/*** اشتراک در رویدادهای لحظه‌ای ***/
supabase.from('prices').on('*', payload => {
  loadPrices();
}).subscribe();
</script>

<!-- ثبت و به‌روزرسانی سرویس‌ورکر -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', async ()=>{
    try{
      const reg = await navigator.serviceWorker.register('/service-worker.js',{scope:'/'});
      // در صورت وجود نسخهٔ جدید، بروزرسانی کنید
      if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        nw && nw.addEventListener('statechange', ()=>{
          if(nw.state === 'installed' && navigator.serviceWorker.controller){
            nw.postMessage({type:'SKIP_WAITING'});
            nw.addEventListener('statechange', ()=>{
              if(nw.state === 'activated') location.reload();
            });
          }
        });
      });
    }catch(err){ console.error('ثبت سرویس‌ورکر شکست خورد:',err); }
  });
}
</script>
<!-- فایل بک‌آپ و همگام‌سازی (در صورت نیاز) -->
<script src="/backup.js"></script>
</body>
</html>
