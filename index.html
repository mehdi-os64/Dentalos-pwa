<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>DentMaster 2025 â€¢ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ (Ø¢Ù†Ù„Ø§ÛŒÙ† + Ø¢ÙÙ„Ø§ÛŒÙ† + Ø¨Ú©â€ŒØ¢Ù¾)</title>

<!-- Ø±Ù†Ú¯ Ù†ÙˆØ§Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ùˆ PWA -->
<meta name="theme-color" content="#0b1020" />
<link rel="manifest" href="/manifest.webmanifest" />

<!-- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ â€“ Ø§Ú¯Ø± Ø¯Ø§Ø±ÛŒ) -->
<link rel="apple-touch-icon" href="/icons/tooth-192.png" />

<style>
  :root{
    --bg:#0b1020;--glass:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
    --stroke:rgba(255,255,255,.18);--text:#eaf3ff;--muted:#b6c2d1;--accent:#00e5ff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;font-family:ui-rounded,"Vazirmatn","IRANSans",system-ui,-apple-system,Segoe UI,Roboto;
    color:var(--text);
    background:
      radial-gradient(60rem 60rem at 10% -10%, rgba(61,110,255,.25), transparent 60%),
      radial-gradient(50rem 50rem at 110% 10%, rgba(0,230,230,.18), transparent 60%),
      linear-gradient(180deg,#0a0f1f 0%,#0b1020 40%,#0e1226 100%);
    overflow:hidden;
  }
  .wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;padding:14px}

  .top{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    backdrop-filter:blur(18px) saturate(140%);-webkit-backdrop-filter:blur(18px) saturate(140%);
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    border:1px solid var(--stroke);border-radius:16px;padding:10px 12px;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .badge{font-weight:900;background:rgba(255,255,255,.12);border:1px solid var(--stroke);padding:4px 8px;border-radius:10px}
  .dot{width:10px;height:10px;border-radius:50%;background:#f43;box-shadow:0 0 0 2px rgba(255,255,255,.15) inset}
  .dot.online{background:#16c784}
  .ver{font-size:12px;opacity:.85}

  .card{
    border:1px solid var(--stroke);border-radius:16px;padding:12px;background:var(--glass);
    backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .row > *{flex:1 1 180px}
  input{width:100%;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;padding:10px 12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
  .btn.accent{background:linear-gradient(135deg,#7ad8ff,#7ef2e0);color:#001018;border-color:transparent}

  .help{font-size:12px;opacity:.85}
  .tbl{overflow:auto;height:100%}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:center;padding:12px}
  th{opacity:.8}
  tr{background:rgba(255,255,255,.06);border:1px solid var(--stroke)}
  tr td:first-child,tr th:first-child{border-radius:12px 0 0 12px}
  tr td:last-child,tr th:last-child{border-radius:0 12px 12px 0}
  .muted{opacity:.7}
  .mini{font-size:12px;opacity:.8}
  .footer{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
</style>
</head>
<body>
<div class="wrap">
  <!-- Ù‡Ø¯Ø± -->
  <div class="top">
    <div class="brand">
      <div class="dot" id="netDot" title="ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡"></div>
      <div style="font-weight:900;font-size:18px">DentMaster 2025</div>
      <span class="badge">Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</span>
      <span class="ver">v1</span>
    </div>
    <div class="row" style="flex:0 0 auto;gap:8px">
      <button class="btn" id="btnSync">â†º Ø³ÛŒÙ†Ú© Ø¢ÙÙ„Ø§ÛŒÙ†â€ŒÙ‡Ø§</button>
      <button class="btn" id="btnBackup">â¬‡ï¸ Ø¨Ú©â€ŒØ¢Ù¾ (JSON)</button>
      <button class="btn" id="btnUploadBackup" title="Ù†ÛŒØ§Ø² Ø¨Ù‡ Bucket: backups Ø¯Ø± Supabase">â˜ï¸ Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾</button>
      <button class="btn" id="btnRefresh">ğŸ”„ Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù¾Ø¯ÛŒØª</button>
    </div>
  </div>

  <!-- ÙØ±Ù… -->
  <div class="card">
    <div class="row">
      <input id="title" placeholder="Ù†Ø§Ù… Ø®Ø¯Ù…Øª (Ù…Ø«Ù„Ø§Ù‹: Ú©Ø§Ù…Ù¾ÙˆØ²ÛŒØª)" />
      <input id="price" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)" inputmode="numeric" />
      <button class="btn accent" id="btnAdd">Ø§ÙØ²ÙˆØ¯Ù†/Ø«Ø¨Øª</button>
    </div>
    <p class="help" style="margin:.6rem 0 0">
      ØªØºÛŒÛŒØ±Ø§Øª Ø´Ù…Ø§ ÛŒØ§ Ù…Ù†Ø´ÛŒ Ø±ÙˆÛŒ ØªÙ…Ø§Ù… Ú¯ÙˆØ´ÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª <b>Realtime</b> Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§Ú¯Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ø§Ø´ÛŒØŒ Ø¯Ø± ØµÙ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ø§ Ø§ØªØµØ§Ù„ØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø³ÛŒÙ†Ú© Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
    </p>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ -->
  <div class="card tbl">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div><b>Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</b> â€¢ <span class="mini">ØªØ¹Ø¯Ø§Ø¯ <span id="count">0</span> Ù…ÙˆØ±Ø¯</span></div>
      <div class="mini muted" id="syncInfo">â€”</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Ù†Ø§Ù… Ø®Ø¯Ù…Øª</th>
          <th>Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</th>
          <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
        </tr>
      </thead>
      <tbody id="list">
        <tr><td colspan="3" class="muted">Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ÙÙˆØªØ± -->
  <div class="footer">
    <span class="mini muted">DentalOS â€¢ PWA â€¢ Supabase Realtime â€¢ Backup & Autoâ€‘Update</span>
    <span class="mini" id="lastSaved">â€”</span>
  </div>
</div>

<!-- Ø±Ø¬ÛŒØ³ØªØ± Ø³Ø±ÙˆÛŒØ³â€ŒÙˆØ±Ú©Ø± Ø¨Ø§ Auto-Update -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
      // Ø§Ú¯Ø± ÙˆØ±Ú©Ø± Ø¬Ø¯ÛŒØ¯ Ø¢Ù…Ø§Ø¯Ù‡Ù” replace Ø´Ø¯
      function activateWaiting(sw){ sw && sw.postMessage({type:'SKIP_WAITING'}); }
      if (reg.waiting) activateWaiting(reg.waiting);
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw && nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            activateWaiting(nw);
            nw.addEventListener('statechange', () => {
              if (nw.state === 'activated') location.reload();
            });
          }
        });
      });
      // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Background Sync (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
      if ('sync' in reg) {
        window._dos_requestSync = async ()=>{ try{ await reg.sync.register('sync-prices'); }catch{} };
      }
    } catch (e) { console.warn('SW register failed', e); }
  });
}
</script>

<!-- Supabase + Ù…Ù†Ø·Ù‚ Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¨Ú©â€ŒØ¢Ù¾ -->
<script type="module">
/* ====== Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase (ESM CDN) ====== */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* === ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ù…Ø§ === */
const SUPABASE_URL = "https://poubooxbvvzbwyjlfmaj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvdWJvb3hidnZ6Ynd5amxmbWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDgxODUsImV4cCI6MjA3MTMyNDE4NX0.aaLn3sqzRr87zFegPqJyrrsbLrK5IF9JpdDjezpsTrQ";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* === DOM === */
const $ = s => document.querySelector(s);
const list = $("#list");
const countEl = $("#count");
const dot = $("#netDot");
const info = $("#syncInfo");
const lastSaved = $("#lastSaved");

/* === Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø² Ø¢ÙÙ„Ø§ÛŒÙ† === */
const DB = {
  get(k, d){ try{ return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(d)); }catch{ return d; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const KEY_CACHE = "PRICES_CACHE_V1";      // Ù„ÛŒØ³Øª Ú©Ø´ Ù…Ø­Ù„ÛŒ
const KEY_OUTBOX = "PRICES_OUTBOX_V1";    // ØµÙ Ø¹Ù…Ù„ÛŒØ§Øª Ø¢ÙÙ„Ø§ÛŒÙ†

/* === ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡ === */
function updateDot(){
  dot.classList.toggle('online', navigator.onLine);
  dot.title = navigator.onLine ? "Ø¢Ù†Ù„Ø§ÛŒÙ†" : "Ø¢ÙÙ„Ø§ÛŒÙ†";
}
addEventListener('online',  ()=>{ updateDot(); flushOutbox(); });
addEventListener('offline', ()=>{ updateDot(); });

/* === UI === */
function rials(x){
  if (x == null || x === "") return "";
  const s = String(x).replace(/[^\d]/g,'');
  return s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
function render(rows){
  list.innerHTML = "";
  if (!rows?.length){ list.innerHTML = `<tr><td colspan="3" class="muted">Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`; countEl.textContent = "0"; return; }
  countEl.textContent = rows.length;
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHTML(r.title || r.name || "")}</td>
      <td>${rials(r.price || r.amount || r.fee || "")}</td>
      <td>
        <button class="btn" data-edit="${r.id ?? ""}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn" data-del="${r.id ?? ""}" style="margin-inline-start:6px">Ø­Ø°Ù</button>
      </td>`;
    list.appendChild(tr);
  });
  // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´/Ø­Ø°Ù
  list.querySelectorAll('[data-edit]').forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute('data-edit');
      const row = (DB.get(KEY_CACHE,[])).find(x=> String(x.id)===String(id));
      if(!row) return;
      $("#title").value = row.title || row.name || "";
      $("#price").value = row.price || row.amount || "";
      $("#btnAdd").dataset.editing = id;
      $("#btnAdd").textContent = "Ø°Ø®ÛŒØ±Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´";
    };
  });
  list.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = ()=> removeItem(b.getAttribute('data-del'));
  });
}
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* === Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Supabase Ø¨Ø§ ÙÙÙ„Ø³â€ŒØ¨Ú© Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ === */
async function loadRemote(){
  let q = supabase.from('prices').select('*');
  // Ø§Ø¨ØªØ¯Ø§ created_atØŒ Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ Ø¨ÛŒÙØª Ø±ÙˆÛŒ id
  let { data, error } = await q.order('created_at',{ascending:false});
  if(error){ ({ data, error } = await supabase.from('prices').select('*').order('id',{ascending:false})); }
  if(error){ throw error; }
  DB.set(KEY_CACHE, data);
  render(data);
  info.textContent = "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± âœ“";
}

/* === Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ === */
async function upsertOnline(rec){
  // Ø§Ú¯Ø± id Ø¯Ø§Ø´Øª => update
  if(rec.id){
    const { error } = await supabase.from('prices').update({ title:rec.title, price:Number(rec.price) })
      .eq('id', rec.id);
    if(error) throw error;
  }else{
    const { error } = await supabase.from('prices').insert({ title:rec.title, price:Number(rec.price) });
    if(error) throw error;
  }
}
async function addOrEdit(){
  const title = $("#title").value.trim();
  const price = $("#price").value.trim();
  if(!title || !price){ flash('Ù†Ø§Ù… Ùˆ Ù‚ÛŒÙ…Øª Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†'); return; }

  const editingId = $("#btnAdd").dataset.editing || null;
  const rec = { id: editingId, title, price: Number(price.replace(/[^\d]/g,'')) };

  if(navigator.onLine){
    try{
      await upsertOnline(rec);
      $("#btnAdd").dataset.editing = "";
      $("#btnAdd").textContent = "Ø§ÙØ²ÙˆØ¯Ù†/Ø«Ø¨Øª";
      $("#title").value=""; $("#price").value="";
      await loadRemote();
      touchSaved();
    }catch(e){
      // Ø§Ú¯Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ø®Ø·Ø§ Ø¯Ø§Ø¯ØŒ Ø¨Ù†Ø¯Ø§Ø² ØªÙˆ ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ†
      queueOp({ type: editingId?'update':'insert', rec });
      flash('Ø«Ø¨Øª Ø¯Ø± ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ†Ø› Ø¨Ø§ Ø§ØªØµØ§Ù„ Ø³ÛŒÙ†Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯');
    }
  }else{
    queueOp({ type: editingId?'update':'insert', rec });
    // ÙÙˆØ±ÛŒ Ø¯Ø§Ø®Ù„ Ú©Ø´ Ù…Ø­Ù„ÛŒ Ù‡Ù… Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†ÛŒÙ…
    const cache = DB.get(KEY_CACHE,[]);
    if(editingId){
      const ix = cache.findIndex(x=> String(x.id)===String(editingId));
      if(ix>-1) cache[ix] = { ...cache[ix], title:rec.title, price:rec.price };
    }else{
      cache.unshift({ id: "temp_"+Date.now(), title:rec.title, price:rec.price });
    }
    DB.set(KEY_CACHE, cache); render(cache);
    $("#btnAdd").dataset.editing = "";
    $("#btnAdd").textContent = "Ø§ÙØ²ÙˆØ¯Ù†/Ø«Ø¨Øª";
    $("#title").value=""; $("#price").value="";
    flash('(Ø¢ÙÙ„Ø§ÛŒÙ†) Ø¯Ø± ØµÙ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  }
}
$("#btnAdd").onclick = addOrEdit;

/* === Ø­Ø°Ù === */
async function removeItem(id){
  if(!id) return;
  if(navigator.onLine){
    try{
      const { error } = await supabase.from('prices').delete().eq('id', id);
      if(error) throw error;
      await loadRemote();
      touchSaved();
    }catch(e){
      queueOp({ type:'delete', rec:{ id } });
      flash('Ø­Ø°Ù Ø¯Ø± ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ† Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª');
    }
  }else{
    queueOp({ type:'delete', rec:{ id } });
    const cache = DB.get(KEY_CACHE,[]).filter(x=> String(x.id)!==String(id));
    DB.set(KEY_CACHE, cache); render(cache);
    flash('(Ø¢ÙÙ„Ø§ÛŒÙ†) Ø­Ø°Ù Ø¯Ø± ØµÙ');
  }
}

/* === ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ† === */
function queueOp(op){
  const box = DB.get(KEY_OUTBOX,[]);
  box.push({ at: Date.now(), ...op });
  DB.set(KEY_OUTBOX, box);
  info.textContent = `Ø¯Ø± ØµÙ: ${box.length} Ù…ÙˆØ±Ø¯`;
}
async function flushOutbox(){
  const box = DB.get(KEY_OUTBOX,[]);
  if(!box.length) { info.textContent = 'ØµÙ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª'; return; }
  info.textContent = `Ø¯Ø± Ø­Ø§Ù„ Ø³ÛŒÙ†Ú© (${box.length})â€¦`;
  for(const it of box){
    try{
      if(it.type==='insert' || it.type==='update'){ await upsertOnline(it.rec); }
      if(it.type==='delete'){ await supabase.from('prices').delete().eq('id', it.rec.id); }
    }catch(e){ console.warn('sync fail', e); }
  }
  DB.set(KEY_OUTBOX, []);
  info.textContent = 'Ø³ÛŒÙ†Ú© Ø´Ø¯ âœ“';
  await loadRemote();
  touchSaved();
}
$("#btnSync").onclick = flushOutbox;

/* === Realtime: Ø¢Ù¾Ø¯ÛŒØª ÙÙˆØ±ÛŒ Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ === */
supabase.channel('prices-realtime')
  .on('postgres_changes', { event:'*', schema:'public', table:'prices' }, payload => {
    // Ù‡Ø± ØªØºÛŒÛŒØ±ÛŒ Ø±ÙˆÛŒ Ø¬Ø¯ÙˆÙ„ -> Ù„ÛŒØ³Øª ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´ÙˆØ¯
    loadRemote().catch(()=>{});
  })
  .subscribe();

/* === Ø¨Ú©â€ŒØ¢Ù¾: Ø¯Ø§Ù†Ù„ÙˆØ¯ JSON === */
function download(filename, text){
  const blob = new Blob([text], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
$("#btnBackup").onclick = async ()=>{
  // Ø§Ø² Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø±Ùˆ Ø¨Ú¯ÛŒØ±ØŒ Ø§Ú¯Ø± Ù†Ø´Ø¯ Ø§Ø² Ú©Ø´
  try{ await loadRemote(); }catch{}
  const data = DB.get(KEY_CACHE,[]);
  download(`prices-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`, JSON.stringify(data,null,2));
  flash('ÙØ§ÛŒÙ„ Ø¨Ú©â€ŒØ¢Ù¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
};

/* === Ø¨Ú©â€ŒØ¢Ù¾: Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Supabase Storage (Bucket: backups) === */
$("#btnUploadBackup").onclick = async ()=>{
  try{
    await loadRemote();
    const data = DB.get(KEY_CACHE,[]);
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const path = `prices/prices-${Date.now()}.json`;
    const { error } = await supabase.storage.from('backups').upload(path, blob, { upsert:false, contentType:'application/json' });
    if(error) throw error;
    flash('Ø±ÙˆÛŒ Ø§Ø³ØªÙˆØ±ÛŒØ¬ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯ âœ“ (bucket: backups)');
  }catch(e){
    flash('Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯Ø› Ø´Ø§ÛŒØ¯ Ø¨Ø§Ú©Øª/Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª. ÙØ¹Ù„Ø§Ù‹ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø­Ù„ÛŒ Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´.');
  }
};

/* === Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù¾Ø¯ÛŒØª (Ø³Ø±ÙˆÛŒØ³â€ŒÙˆØ±Ú©Ø±) === */
$("#btnRefresh").onclick = ()=>{ try{ navigator.serviceWorker.getRegistration().then(r=>r&&r.update()); }catch{} };

/* === Ú©Ù…Ú©ÛŒâ€ŒÙ‡Ø§ === */
function flash(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = "position:fixed;left:50%;transform:translateX(-50%);bottom:calc(120px + env(safe-area-inset-bottom));background:rgba(0,0,0,.6);color:#fff;padding:10px 14px;border-radius:12px;backdrop-filter:blur(8px);z-index:9999";
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600);
}
function touchSaved(){ lastSaved.textContent = "Ø¢Ø®Ø±ÛŒÙ† Ø°Ø®ÛŒØ±Ù‡: " + new Date().toLocaleTimeString('fa-IR'); }

/* === Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ === */
(async function init(){
  updateDot();
  // Ø§ÙˆÙ„ ØªÙ„Ø§Ø´ Ø§Ø² Ø³Ø±ÙˆØ± â€“ Ø§Ú¯Ø± Ù†Ø´Ø¯ Ø§Ø² Ú©Ø´
  try{ await loadRemote(); }
  catch{ render(DB.get(KEY_CACHE,[])); info.textContent = 'Ø¢ÙÙ„Ø§ÛŒÙ†: Ø§Ø² Ú©Ø´ Ù…Ø­Ù„ÛŒ'; }
})();
</script>
</body>
</html>
