<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>DentMaster 2025 • DentalOS PWA</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/tooth-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DentMaster 2025">

  <style>
    :root{
      --bg:#0b1020; --glass:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      --text:#eaf3ff; --muted:#b6c2d1; --accent:#00e5ff; --stroke:rgba(255,255,255,.18);
      --radius:16px; --blur:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-rounded,"Vazirmatn","IRANSans",system-ui,-apple-system,Segoe UI,Roboto;
      color:var(--text);
      background:
        radial-gradient(60rem 60rem at 10% -10%, rgba(61,201,255,.08), transparent 70%),
        radial-gradient(50rem 50rem at 110% 10%, rgba(0,255,188,.08), transparent 70%),
        linear-gradient(180deg,#0a0f1f 0%,#0b1020 40%,#0b1020 100%) fixed;
      overflow-x:hidden;
    }
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px}
    .dot{width:10px;height:10px;border-radius:50%;background:#27e36a;box-shadow:0 0 8px #27e36a}
    h1{margin:0;font-size:24px;letter-spacing:.2px}
    .card{background:var(--glass); backdrop-filter:blur(var(--blur)); border:1px solid var(--stroke);
      border-radius:var(--radius); padding:16px; margin-top:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 220px}
    input,button{
      height:44px; width:100%; border-radius:12px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.06); color:var(--text); padding:0 12px; outline:0;
    }
    button{cursor:pointer; border:1px solid rgba(0,229,255,.35); background:linear-gradient(180deg,rgba(0,229,255,.15),rgba(0,229,255,.05))}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th,td{padding:12px 14px; text-align:right}
    th{color:var(--muted); font-weight:600}
    tr{background:rgba(255,255,255,.04); border:1px solid var(--stroke)}
    tr, td{border-radius:10px}
    .muted{color:var(--muted)}
    .toolbar{display:flex; gap:8px; align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;height:28px;padding:0 10px;font-size:12px;border:1px solid var(--stroke);border-radius:999px;color:var(--muted)}
    .link{color:var(--accent);text-decoration:none}
    .tiny{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="dot" id="onlineDot" title="online"></span>
      <h1>DentMaster 2025</h1>
      <span class="badge" id="verBadge">v<span id="appVersion">1</span></span>
      <a class="badge link tiny" href="#" id="syncBtn">سینک آفلاین‌ها</a>
      <span class="badge tiny" id="updateBadge" style="display:none">درحال به‌روزرسانی…</span>
    </header>

    <!-- ورودی‌ها -->
    <div class="card">
      <div class="row">
        <input id="titleInput" placeholder="نام خدمت (مثلاً: کامپوزیت)">
        <input id="priceInput" inputmode="numeric" placeholder="قیمت (تومان)">
      </div>
      <div class="row" style="margin-top:12px">
        <div class="toolbar" style="flex:1">
          <button id="addBtn">افزودن/ثبت</button>
          <button id="syncOfflineBtn">سینک آفلاین‌ها</button>
        </div>
      </div>
      <p class="muted tiny" style="margin:10px 2px 0">
        تغییراتی که منشی یا شما ثبت کنید، بلافاصله روی تمام گوشی‌ها نمایش می‌شود (Realtime). در حالت آفلاین، در صف ذخیره می‌شود و با اتصال، خودکار اعمال می‌گردد.
      </p>
    </div>

    <!-- لیست قیمت‌ها -->
    <div class="card">
      <div class="toolbar" style="justify-content:space-between;margin-bottom:6px">
        <strong>لیست قیمت‌ها</strong>
        <span class="muted tiny">تعداد <span id="count">0</span> مورد</span>
      </div>
      <div class="muted tiny" id="emptyRow" style="padding:14px;border:1px dashed var(--stroke);border-radius:10px;display:none">
        هنوز قیمتی ثبت نشده است.
      </div>
      <table id="pricesTable">
        <thead>
          <tr><th>نام خدمت</th><th>قیمت (تومان)</th><th>ویرایش</th></tr>
        </thead>
        <tbody id="pricesTbody"></tbody>
      </table>
    </div>

    <p class="muted tiny" style="text-align:center;margin:22px 0 8px">
      DentalOS • PWA • Supabase Realtime • Backup & Auto‑Update
    </p>
  </div>

  <!-- ============== Scripts ============== -->
  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    /* ==== تنظیمات نسخه و آپدیت خودکار ==== */
    const LOCAL_VERSION_KEY = 'dentalos_version';
    const APP_VERSION = 1;           // هر بار که تغییر مهم می‌دی، این را +1 کن
    document.getElementById('appVersion').textContent = APP_VERSION;
    localStorage.setItem(LOCAL_VERSION_KEY, String(APP_VERSION));

    async function checkForUpdates(){
      try{
        const res = await fetch('latest.json', {cache:'no-store'});
        if(!res.ok) return;
        const meta = await res.json(); // {version, timestamp}
        if(Number(meta.version) > APP_VERSION){
          document.getElementById('updateBadge').style.display = 'inline-flex';
          // به سرویس‌ورکر بگو نسخه جدید فعال شود
          if(navigator.serviceWorker?.controller){
            navigator.serviceWorker.controller.postMessage({type:'SKIP_WAITING'});
          }
          setTimeout(()=>location.reload(), 1200);
        }
      }catch(_){}
    }

    /* ==== رجیستر سرویس‌ورکر + مدیریت آپدیت ==== */
    if('serviceWorker' in navigator){
      window.addEventListener('load', async () => {
        try{
          const reg = await navigator.serviceWorker.register('./service-worker.js', {scope:'./'});
          if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
          reg.addEventListener('updatefound', ()=>{
            const nw = reg.installing;
            nw && nw.addEventListener('statechange', ()=>{
              if(nw.state==='installed' && navigator.serviceWorker.controller){
                nw.postMessage({type:'SKIP_WAITING'});
                nw.addEventListener('statechange', ()=>{
                  if(nw.state==='activated') location.reload();
                });
              }
            });
          });
        }catch(e){ console.warn('SW register failed', e); }
        checkForUpdates();
      });
    }

    /* ==== وضعیت آنلاین/آفلاین ==== */
    const dot = document.getElementById('onlineDot');
    function paintOnline(){ dot.style.background = navigator.onLine ? '#27e36a' : '#ffb020'; }
    addEventListener('online', paintOnline);
    addEventListener('offline', paintOnline);
    paintOnline();

    /* ==== Supabase init (با مقادیر تو) ==== */
    const SUPABASE_URL = "https://poubooxbvvzbwyjlfmaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvdWJvb3hidnZ6Ynd5amxmbWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDgxODUsImV4cCI6MjA3MTMyNDE4NX0.aaLn3sqzRr87zFegPqJyrrsbLrK5IF9JpdDjezpsTrQ";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ==== صف آفلاین ساده ==== */
    const QKEY = 'dentalos_offline_queue'; // آرایه‌ای از عملیات {op:"upsert", row:{id,title,price}}
    const queue = JSON.parse(localStorage.getItem(QKEY) || '[]');
    function saveQueue(){ localStorage.setItem(QKEY, JSON.stringify(queue)); }

    async function flushQueue(){
      if(!navigator.onLine || !queue.length) return;
      try{
        const batch = [...queue];
        const { data, error } = await supa.from('prices').upsert(batch.map(x=>x.row), {onConflict:'id'});
        if(!error){
          queue.length = 0; saveQueue();
        }
      }catch(e){ console.warn('flush err', e); }
    }
    addEventListener('online', flushQueue);

    /* ==== بک‌آپ اتوماتیک (Local + Supabase Storage) ==== */
    const BK_KEY = 'dentalos_backup_prices';
    async function backupCloud(json){
      try{
        const fname = `backup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        const blob = new Blob([json], {type:'application/json'});
        // نیاز به باکت public به نام "backups" (در Supabase Storage بساز)
        await supa.storage.from('backups').upload(fname, blob, {contentType:'application/json', upsert:false});
      }catch(e){ console.warn('cloud backup fail', e); }
    }

    /* ==== UI helper ==== */
    const $ = s => document.querySelector(s);
    const tbody = $('#pricesTbody'), countEl = $('#count'), emptyRow = $('#emptyRow');

    function renderRows(rows){
      tbody.innerHTML = '';
      if(!rows || !rows.length){ emptyRow.style.display='block'; countEl.textContent = '0'; return; }
      emptyRow.style.display='none';
      countEl.textContent = String(rows.length);
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.title ?? ''}</td>
          <td>${(r.price ?? '').toLocaleString('fa-IR')}</td>
          <td><button data-id="${r.id}">ویرایش</button></td>`;
        tbody.appendChild(tr);
      }
      // دکمه‌های ویرایش (در این نسخه فقط نمایش می‌دهیم)
      tbody.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = ()=> alert('ویرایش سریع: در نسخه کامل فرم ویرایش باز می‌شود.');
      });
    }

    /* ==== بارگذاری اولیه + ذخیره محلی جهت بک‌آپ ==== */
    async function loadPrices(){
      try{
        const { data, error } = await supa.from('prices').select('*').order('created_at', {ascending:false});
        if(error) throw error;
        renderRows(data);
        localStorage.setItem(BK_KEY, JSON.stringify(data)); // بک‌آپ محلی
      }catch(e){
        // آفلاین: از بک‌آپ محلی نمایش بده
        const cached = JSON.parse(localStorage.getItem(BK_KEY) || '[]');
        renderRows(cached);
      }
    }

    /* ==== Realtime: هر تغییری رو زنده اعمال کن ==== */
    const channel = supa.channel('prices-ch')
      .on('postgres_changes', {event: '*', schema: 'public', table: 'prices'}, (payload) => {
        loadPrices();
      }).subscribe();

    /* ==== افزودن قیمت ==== */
    async function addPrice(){
      const title = $('#titleInput').value.trim();
      const raw = $('#priceInput').value.replace(/[^\d]/g,'');
      if(!title || !raw){ alert('نام خدمت و قیمت را وارد کنید'); return; }
      const price = Number(raw);
      const row = { title, price };

      if(navigator.onLine){
        const { error } = await supa.from('prices').insert(row);
        if(error){ alert('خطا در ثبت آنلاین'); return; }
        await loadPrices();
        // بک‌آپ ابری
        const snapshot = localStorage.getItem(BK_KEY) || '[]';
        backupCloud(snapshot);
      }else{
        // صف آفلاین
        queue.push({op:'upsert', row:{ id: crypto.randomUUID(), ...row }});
        saveQueue();
        alert('آفلاین هستید؛ مورد به صف اضافه شد و با اتصال، خودکار سینک می‌شود.');
      }
      $('#titleInput').value=''; $('#priceInput').value='';
    }

    /* ==== رویدادها ==== */
    $('#addBtn').onclick = addPrice;
    $('#syncOfflineBtn').onclick = flushQueue;
    $('#syncBtn').onclick = (e)=>{ e.preventDefault(); flushQueue(); };

    // شروع
    loadPrices();
  </script>
</body>
</html>
