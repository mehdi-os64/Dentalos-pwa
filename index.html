<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <!-- ★ PWA / iOS meta & icons injected -->
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="icons/tooth-180.png"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="DentalOS"/>
  <meta name="theme-color" content="#0b1020"/>
  <!-- /PWA inject -->

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>DentalOS • V4 • PRO • Super AI + AutoTest • iOS26 LiquidNav</title>
<meta name="theme-color" content="#0b1020">
<style>
:root{
  --bg:#0b1020;
  --stroke:rgba(255,255,255,.22);
  --glass:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  --blur:18px;
  --text:#eaf3ff;
  --muted:#b6c2d1;
  --accent:#00e5ff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-rounded,"Vazirmatn","IRANSans",system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--text);
  background:
   radial-gradient(60rem 60rem at 10% -10%, rgba(61,110,255,.25), transparent 60%),
   radial-gradient(50rem 50rem at 110% 10%, rgba(0,230,230,.18), transparent 60%),
   linear-gradient(180deg,#0a0f1f 0%,#0b1020 40%,#0e1226 100%);
  overflow:hidden;
  user-select:none;
}

/* Header */
.header{position:fixed;inset:0 0 auto 0;height:64px;display:flex;align-items:center;gap:10px;
  padding:0 clamp(10px,3vw,18px);z-index:90;
  backdrop-filter:blur(var(--blur)) saturate(140%);-webkit-backdrop-filter:blur(var(--blur)) saturate(140%);
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border-bottom:1px solid var(--stroke)}
.hamb{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;cursor:pointer;
  background:rgba(255,255,255,.12);border:1px solid var(--stroke)}
.hamb span,.hamb::before,.hamb::after{content:"";width:18px;height:2px;background:#fff;border-radius:2px;display:block;transition:.25s}
.hamb::before{transform:translateY(-5px)}.hamb::after{transform:translateY(5px)}
.hamb.active{background:rgba(255,255,255,.2)}.hamb.active span{opacity:0}
.hamb.active::before{transform:translateY(0) rotate(45deg)}.hamb.active::after{transform:translateY(0) rotate(-45deg)}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.logo{width:38px;height:38px;border-radius:12px;position:relative;overflow:hidden;
  background:radial-gradient(120% 120% at 20% 20%,#6dd5fa 0%,#2980b9 35%,#172a45 100%);
  box-shadow:inset 0 0 12px rgba(255,255,255,.25),0 10px 30px rgba(0,0,0,.35)}
.title{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Smart search */
.searchDock{position:fixed;inset:64px 12px auto 12px;z-index:80;display:flex;gap:10px;align-items:center}
.searchBar{flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:16px;border:1px solid var(--stroke);background:var(--glass);
  backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:0 10px 30px rgba(0,0,0,.28)}
.searchBar input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:14px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
.mic{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;border:1px solid var(--stroke);cursor:pointer;
  background:linear-gradient(135deg,#7ad8ff,#7ef2e0);color:#001018;box-shadow:0 12px 28px rgba(0,0,0,.35)}
.mic.rec{animation:pulse 1.2s infinite}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,229,255,.45)}70%{box-shadow:0 0 0 14px rgba(0,229,255,0)}100%{box-shadow:0 0 0 0 rgba(0,229,255,0)}}

/* Main content */
.main{position:fixed;inset:118px 0 calc(128px + env(safe-area-inset-bottom)) 0;padding:14px;overflow:auto}

/* Calendar + tiles (kept) */
.card{border-radius:20px;padding:12px;background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:0 10px 30px rgba(0,0,0,.35)}
.calhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.calgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;text-align:center}
.caldow{opacity:.75;font-size:12px}
.calday{padding:12px 0;border:1px solid var(--stroke);border-radius:12px;background:rgba(255,255,255,.06);position:relative}
.calday.today{outline:2px solid var(--accent)}
.calday .plus{position:absolute;inset:auto 8px 6px auto;font-weight:900;opacity:.65}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:12px}
.tile{position:relative;min-height:120px;border-radius:20px;padding:14px;cursor:pointer;
  background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));
  box-shadow:0 10px 30px rgba(0,0,0,.35);transition:transform .2s ease;overflow:hidden}
.tile:hover{transform:translateY(-2px)}
.tile .icon{font-size:28px}.tile .t{margin-top:8px;font-weight:800;font-size:18px}.tile .d{opacity:.75;font-size:12px}
.tile .optbtn{position:absolute;inset:10px auto auto 10px;padding:6px 8px;border-radius:10px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:#fff}

/* Bottom nav iOS26 Liquid Glass */
.bnav{position:fixed;inset:auto 12px calc(12px + env(safe-area-inset-bottom)) 12px;height:88px;
  display:grid;grid-template-columns:repeat(6,1fr);gap:10px;align-items:center;justify-items:center;
  border-radius:26px;padding:8px 10px;
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.18));
  border:1px solid rgba(255,255,255,.22);
  backdrop-filter:blur(28px) saturate(170%);-webkit-backdrop-filter:blur(28px) saturate(170%);
  box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.25); z-index:85}
.bnav .item{position:relative;width:100%;height:64px;border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:var(--muted);cursor:pointer;transition:.18s}
.bnav .ico{font-size:34px;line-height:1;filter:drop-shadow(0 14px 18px rgba(0,0,0,.45));transition:transform .12s}
.bnav .label{font-size:12px;margin-top:4px}
.bnav .item:active .ico{transform:translateY(2px) scale(.98)}
.bnav .item.active{color:#fff;background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.10));
  box-shadow:inset 0 6px 16px rgba(0,0,0,.35), inset 0 -1px 0 rgba(255,255,255,.25); transform:translateY(1px)}
.bnav .item.active .ico{transform:translateY(1px) scale(.96)}
/* droplet */
.droplet{position:absolute;left:0;top:0;width:72px;height:72px;border-radius:24px;pointer-events:none;opacity:0;
  background:radial-gradient(30% 30% at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.10));
  filter:blur(0);transition:opacity .15s, transform .06s}
.droplet.show{opacity:1}

/* Overlays */
.backdrop{position:fixed;inset:64px 0 calc(128px + env(safe-area-inset-bottom)) 0;background:rgba(10,12,18,.55);z-index:88;opacity:0;pointer-events:none;transition:.25s}
.backdrop.show{opacity:1;pointer-events:auto}
.sidemenu{position:fixed;inset:64px 0 calc(128px + env(safe-area-inset-bottom)) auto;width:min(380px,92vw);
  transform:translateX(100%);transition:.25s;z-index:89;padding:16px;overflow:auto;
  background:linear-gradient(180deg,rgba(17,24,39,.97),rgba(17,24,39,.94));color:#eaf3ff;border-left:1px solid rgba(255,255,255,.12);
  box-shadow:-18px 0 40px rgba(0,0,0,.45)}
.sidemenu.open{transform:none}
.group{margin:10px 0 16px}.group h3{font-size:13px;opacity:.95;margin:0 0 8px}
.sel{padding:9px 11px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff}
.row{display:flex;flex-wrap:wrap;gap:8px}
.help{font-size:12px;opacity:.85;padding:8px 10px;border:1px dashed rgba(255,255,255,.25);border-radius:12px;background:rgba(255,255,255,.06)}

/* Sheet */
.sheet{position:fixed;inset:64px 0 calc(128px + env(safe-area-inset-bottom)) 0;display:none;z-index:86}
.sheet.open{display:block}
.scard{position:absolute;inset:14px;border-radius:22px;overflow:hidden;background:var(--glass);border:1px solid var(--stroke);
  backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:0 10px 30px rgba(0,0,0,.35);display:flex;flex-direction:column}
.shead{padding:12px 14px 8px 14px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
.shead .stitle{font-weight:900;font-size:16px}
.sbody{flex:1;overflow:auto;padding:12px 14px 84px 14px}
.sfooter{position:absolute;inset:auto 12px 12px 12px;display:flex;justify-content:space-between;gap:12px}
.action{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border-radius:14px;border:1px solid var(--stroke);
  background:rgba(255,255,255,.08);color:#fff;font-weight:700;cursor:pointer}
.action.red{border-color:#e94560;background:rgba(233,69,96,.15)}.action.green{border-color:#16c784;background:rgba(22,199,132,.15)}.action.yellow{border-color:#f5c518;background:rgba(245,197,24,.15);color:#f7e08a}

/* AI orb */
#aiOrb{position:fixed;right:18px;bottom:calc(160px + env(safe-area-inset-bottom));width:72px;height:72px;border-radius:22px;display:grid;place-items:center;cursor:grab;
  background:conic-gradient(from 200deg,#7ad8ff,#8ef5a9,#bca7ff,#7ad8ff);box-shadow:0 18px 40px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.45);z-index:87}
#aiOrb svg{width:30px;height:30px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.4))}#aiOrb:active{cursor:grabbing}

.mini{font-size:12px;opacity:.8}
.hidden{display:none}
fieldset{border:1px dashed rgba(255,255,255,.2);border-radius:12px;padding:12px;margin:0 0 10px}
legend{padding:0 6px;opacity:.8;font-size:12px}
label{display:block;font-size:12px;opacity:.85;margin:6px 0 4px}
input,select,textarea{width:100%;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;padding:10px 12px}

/* --- Rotating Tooth Logo (no box) --- */
.brand .logo{width:48px;height:48px;background:transparent!important;box-shadow:none!important;border-radius:50%;overflow:visible;position:relative}
.brand .logo svg{width:48px;height:48px;display:block;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
@keyframes spinY{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}
.brand .logo .tooth3d{transform-origin:center;animation:spinY 10s linear infinite}

/* --- Bigger glass capsules behind bottom icons --- */
.bnav .item{position:relative}
.bnav .item::before{content:"";position:absolute;inset:auto 22px 6px 22px;height:44px;border-radius:22px;
  background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.06));
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.2),0 10px 24px rgba(0,0,0,.35);
  opacity:.28;transform:translateY(10px) scale(.92);transition:all .25s cubic-bezier(.2,.8,.2,1)}
.bnav .item.active::before,.bnav .item:hover::before{opacity:.75;transform:translateY(0) scale(1);
  background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,.12))}
.bnav .item .ico{font-size:24px}


/* --- رنگ و انیمیشن برای عنوان دندانپزشکی دکتر مینا مازندرانی --- */
#brandTitle{
  display:flex; gap:.5rem; align-items:center;
  font-weight:900; font-size: clamp(18px,3.8vw,28px);
}
#brandTitle .w{
  --c:#fff;
  color:var(--c);
  display:inline-block;
  padding:.15rem .45rem;
  border-radius:12px;
  text-shadow:0 2px 10px color-mix(in oklab, var(--c) 55%, transparent);
  animation:
    bob 2.8s ease-in-out infinite alternate,
    glow 3.6s ease-in-out infinite alternate;
  will-change: transform, text-shadow, filter;
}
#brandTitle .w:nth-child(1){ --c:#00e5ff; }  /* دندانپزشکی */
#brandTitle .w:nth-child(2){ --c:#ff5da2; }  /* دکتر */
#brandTitle .w:nth-child(3){ --c:#ffd166; }  /* مینا */
#brandTitle .w:nth-child(4){ --c:#a78bfa; }  /* مازندرانی */
@keyframes bob{
  0%   { transform: translateY(0) rotate(0deg); }
  100% { transform: translateY(-4px) rotate(-1deg); }
}
@keyframes glow{
  0%   { text-shadow: 0 2px 10px color-mix(in oklab, var(--c) 45%, transparent); filter:saturate(1); }
  100% { text-shadow: 0 0 18px color-mix(in oklab, var(--c) 90%, transparent);   filter:saturate(1.15); }
}
#brandTitle .w:nth-child(1){ animation-delay:.0s,.0s; }
#brandTitle .w:nth-child(2){ animation-delay:.1s,.2s; }
#brandTitle .w:nth-child(3){ animation-delay:.2s,.4s; }
#brandTitle .w:nth-child(4){ animation-delay:.3s,.6s; }

</style>
</head>
<body>
  <div class="header">
    <div class="hamb" id="hamb"><span></span></div>
    <div class="brand">
      <div class="logo"></div>
      
<div class="title" id="brandTitle">
  <span class="w">دندانپزشکی</span>
  <span class="w">دکتر</span>
  <span class="w">مینا</span>
  <span class="w">مازندرانی</span>
</div>

    </div>
  </div>

  <!-- Smart search -->
  <div class="searchDock">
    <div class="searchBar">
      <input id="q" placeholder="جستجوی هوشمند: بیمار/قسط/چک/رویداد/انبار..." />
      <button class="btn" id="searchBtn">جستجو</button>
    </div>
    <div class="mic" id="micBtn" title="گفتار به نوشتار">🎙️</div>
  </div>

  <div class="main">
    <div class="card" id="calHost"></div>
    <div class="grid" id="tiles"></div>
  </div>

  <!-- Bottom Nav -->
  <div class="bnav" id="bnav">
    <div class="droplet" id="drop"></div>
  </div>

  <div class="backdrop" id="backdrop"></div>
  <aside class="sidemenu" id="sidemenu">
    <div class="group">
      <h3>تنظیمات برنامه</h3>
      <div class="row">
        <button class="btn" data-act="askNoti">🔔 فعال‌سازی اعلان</button>
        <button class="btn" data-act="askMic">🎤 فعال‌سازی گفتار</button>
        <button class="btn" data-act="installPWA">📲 نصب PWA</button>
        <button class="btn" data-act="updateApp">🔄 بررسی آپدیت</button>
      </div>
    </div>
    <div class="group">
      <h3>نقش کاربر</h3>
      <select class="sel" id="roleSel">
        <option value="owner">مدیر/پزشک</option>
        <option value="reception">پذیرش</option>
        <option value="assistant">منشی/دستیار</option>
        <option value="cashier">صندوق</option>
      </select>
      <div class="help">دسترسی‌ها طبق نقش محدود می‌شود.</div>
    </div>
    <div class="group">
      <h3>تم</h3>
      <select class="sel" id="themeSel">
        <option value="glass">گلس</option>
        <option value="aqua">آکوا</option>
        <option value="sunset">سانست</option>
        <option value="dark">تیره</option>
      </select>
    </div>
    <div class="group">
      <h3>🧪 تست خودکار همه‌بخش‌ها</h3>
      <div class="row">
        <button class="btn" id="runTests">اجرای سناریوی واقعی</button>
        <button class="btn" id="runDeep">تست عمیق همه فرم‌ها</button>
        <button class="btn" id="copyReport">کپی گزارش</button>
      </div>
      <textarea id="report" class="sel" style="width:100%;height:180px;margin-top:8px" readonly>— هنوز گزارشی نیست —</textarea>
    </div>
  </aside>

  <!-- Sheet -->
  <div class="sheet" id="sheet">
    <div class="scard">
      <div class="shead">
        <div class="stitle" id="sTitle">...</div>
        <button class="action red" id="sClose">✖ بستن</button>
      </div>
      <div class="sbody" id="sBody"></div>
      <div class="sfooter">
        <button class="action yellow" id="sBack">↩ برگشت</button>
        <button class="action green" id="sSubmit">✔ ثبت</button>
      </div>
    </div>
  </div>

  <!-- AI orb -->
  <div id="aiOrb" title="دستیار هوشمند">
    <svg viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.6">
      <circle cx="12" cy="12" r="5" fill="white" opacity=".85"/>
      <path d="M4 12a8 8 0 1 0 16 0" stroke-linecap="round"/>
    </svg>
  </div>

<script>
const EL = (s)=>document.querySelector(s);
function toast(msg){ const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText="position:fixed;left:50%;transform:translateX(-50%);bottom:calc(150px + env(safe-area-inset-bottom));background:rgba(0,0,0,.6);color:#fff;padding:10px 14px;border-radius:12px;backdrop-filter:blur(8px);z-index:9999;";
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }
const DB={ get:(k,def=null)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def))}catch(e){return def}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };

/* ===== Data/tiles (kept) ===== */
const ALL_TILES=[
  {k:'events',t:'رویدادها',d:'امروز/هفته/ماه',ico:'🗓️',perm:['owner','reception','assistant','cashier'],
    subs:[['today','امروز'],['week','این هفته'],['month','ماه'],['calendar','تقویم'],['quick','نوبت فوری']]},
  {k:'patients',t:'بیماران',d:'لیست/افزودن/پرونده',ico:'🧑‍⚕️',perm:['owner','reception','assistant'],
    subs:[['list','لیست'],['add','افزودن'],['profile','پرونده بیمار']]},
  {k:'finance',t:'مالی',d:'دفتر کل/بدهکار/طلبکار/چک/اقساط',ico:'💳',perm:['owner','cashier'],
    subs:[['ledger','دفتر کل'],['debt','بدهکار'],['credit','طلبکار'],['check','چک'],['installment','اقساط'],['daily','گزارش روزانه'],['cashbox','صندوق']]},
  {k:'implant',t:'ایمپلنت',d:'ثبت/پیگیری',ico:'🦷',perm:['owner','assistant'],
    subs:[['new','ثبت جراحی'],['due','پیگیری'],['list','لیست'],['sterile','چک‌لیست استریل']]},
  {k:'inventory',t:'انبار',d:'موجودی/ورود/خروج',ico:'📦',perm:['owner','assistant'],
    subs:[['stock','موجودی'],['in','ورود'],['out','خروج'],['low','کسری']]},
  {k:'lab',t:'لابراتوار',d:'ارسال/دریافت/پیگیری',ico:'🏷️',perm:['owner','assistant'],
    subs:[['send','ارسال'],['receive','دریافت'],['track','پیگیری'],['list','لیست کارها'],['bill','فاکتور']]},
];
const roleSel=EL('#roleSel'); roleSel.value=localStorage.getItem('DOS.role')||'owner';
roleSel.onchange=()=>{ localStorage.setItem('DOS.role', roleSel.value); buildTiles(); rebuildBottomNav(); };

const tilesWrap=EL('#tiles'); const bnav=EL('#bnav'); const droplet=EL('#drop');
function buildTiles(){ tilesWrap.innerHTML=''; ALL_TILES.filter(t=>t.perm.includes(roleSel.value)).forEach(o=>{
  const d=document.createElement('div'); d.className='tile'; d.dataset.k=o.k;
  d.innerHTML=`<div class="icon">${o.ico}</div><div class="t">${o.t}</div><div class="d">${o.d}</div><button class="optbtn" type="button">⋮</button>`;
  d.addEventListener('click',()=>openEntry(o.k));
  d.querySelector('.optbtn').addEventListener('click',(ev)=>{ ev.stopPropagation(); openTileOptions(o.k); });
  tilesWrap.appendChild(d);
}); }
function rebuildBottomNav(){
  bnav.querySelectorAll('.item').forEach(n=>n.remove());
  ALL_TILES.filter(t=>t.perm.includes(roleSel.value)).forEach(o=>{
    const it=document.createElement('div'); it.className='item'; it.dataset.k=o.k;
    it.innerHTML=`<div class="ico">${o.ico}</div><div class="label">${o.t}</div>`;
    it.onclick=()=>{ setActiveNav(o.k); openEntry(o.k); };
    bnav.appendChild(it);
  });
  // keep droplet as first element
  bnav.prepend(droplet);
}
function setActiveNav(k){
  bnav.querySelectorAll('.item').forEach(i=>i.classList.toggle('active', i.dataset.k===k));
  DB.set('DOS.active', k);
}
buildTiles(); rebuildBottomNav(); setActiveNav(DB.get('DOS.active','events'));

/* ===== Sheet & forms (kept) ===== */
const sheet=EL('#sheet'), sBody=EL('#sBody'), sTitle=EL('#sTitle');
const sClose=EL('#sClose'), sBack=EL('#sBack'), sSubmit=EL('#sSubmit');
function openSheet(title, content){ sTitle.textContent=title||' '; sBody.innerHTML=''; if(typeof content==='string') sBody.innerHTML=content; else sBody.appendChild(content); sheet.classList.add('open'); }
function closeSheet(){ sheet.classList.remove('open'); }
function setHandlers(onSubmit,onBack,onClose){ sSubmit.onclick=onSubmit||(()=>{}); sBack.onclick=onBack||closeSheet; sClose.onclick=onClose||closeSheet; }

function F(legend, fields){ const fs=document.createElement('fieldset'); const lg=document.createElement('legend'); lg.textContent=legend; fs.appendChild(lg);
  fields.forEach(f=>{ const lab=document.createElement('label'); lab.textContent=f.l; if(f.tag==='select'){ const sel=document.createElement('select'); sel.name=f.n; (f.list||[]).forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); }); fs.append(lab, sel); }
  else { const el=(f.tag==='textarea')?document.createElement('textarea'):document.createElement('input'); el.name=f.n; if(f.type) el.type=f.type; fs.append(lab, el); } }); return fs; }

function buildForm(modKey, subKey){
  const el=document.createElement('div');
  if(modKey==='events'){
    if(subKey==='today'){ el.appendChild(F('رویدادهای امروز',[{l:'فیلتر نوع',n:'type',tag:'select',list:['همه','ویزیت','جرم‌گیری','پرکردگی','ایمپلنت']} ])); }
    if(subKey==='quick'){ el.appendChild(F('نوبت فوری',[{l:'بیمار',n:'pt'},{l:'خدمت',n:'srv',tag:'select',list:['ویزیت','جرم‌گیری','پرکردگی','ایمپلنت']},{l:'ساعت',n:'t',type:'time'}])); }
    if(subKey==='calendar'){ const host=document.createElement('div'); buildCalendar(host,new Date()); el.appendChild(host); }
  }
  if(modKey==='patients'){
    if(subKey==='add'){ el.appendChild(F('افزودن بیمار',[{l:'نام',n:'name'},{l:'موبایل',n:'tel'},{l:'کدملی',n:'nid'},{l:'یادداشت',n:'note',tag:'textarea'}])); }
    if(subKey==='list'){ const arr=DB.get('DOS.PATIENTS',[]); const tbl=document.createElement('div'); tbl.innerHTML= arr.length?('<table style="width:100%"><tr><th>نام</th><th>موبایل</th><th>کدملی</th></tr>'+arr.map(p=>`<tr><td>${p.name}</td><td>${p.tel||''}</td><td>${p.nid||''}</td></tr>`).join('')+'</table>'):'<div class="mini">موردی نیست.</div>'; el.appendChild(tbl); }
  }
  if(modKey==='finance'){
    if(subKey==='installment'){ el.appendChild(F('تعریف اقساط',[{l:'بیمار',n:'pt'},{l:'کل مبلغ',n:'total',type:'number'},{l:'پیش‌پرداخت',n:'pre',type:'number'},{l:'تعداد اقساط',n:'n',type:'number'}])); }
    if(subKey==='check'){ el.appendChild(F('ثبت چک',[{l:'نام',n:'p'},{l:'مبلغ',n:'amt',type:'number'},{l:'سررسید',n:'due',type:'date'}])); }
  }
  if(modKey=='implant'){
    if(subKey=='new'){ el.appendChild(F('ثبت جراحی ایمپلنت',[{l:'نام بیمار',n:'pt'},{l:'فک/نواحی',n:'area',tag:'select',list:['فک بالا','فک پایین','قدام','خلف']},{l:'تعداد ایمپلنت',n:'count',type:'number'},{l:'تاریخ جراحی',n:'date',type:'date'},{l:'یادداشت',n:'note',tag:'textarea'}])); }
    if(subKey=='due'){ el.appendChild(F('پیگیری',[{l:'کد/نام بیمار',n:'pt'},{l:'موضوع پیگیری',n:'topic',tag:'select',list:['بخیه','پانسمان','پروتز','معاینه']}])); }
    if(subKey=='list'){ el.appendChild(F('لیست جراحی‌ها (فیلتر)',[{l:'از تاریخ',n:'from',type:'date'},{l:'تا تاریخ',n:'to',type:'date'}])); }
    if(subKey=='sterile'){ el.appendChild(F('چک‌لیست استریل',[{l:'اتوکلاو OK',n:'autoclave',tag:'select',list:['بله','خیر']},{l:'ست جراحی کامل',n:'kit',tag:'select',list:['بله','خیر']},{l:'یادداشت',n:'note',tag:'textarea'}])); }
  }
  if(modKey=='inventory'){
    if(subKey=='stock'){ el.appendChild(F('موجودی کالا',[{l:'نام کالا/کد',n:'item'},{l:'گزارش تا تاریخ',n:'date',type:'date'}])); }
    if(subKey=='in'){ el.appendChild(F('ورود کالا',[{l:'نام کالا',n:'item'},{l:'تعداد',n:'qty',type:'number'},{l:'تأمین‌کننده',n:'vendor'},{l:'تاریخ',n:'date',type:'date'}])); }
    if(subKey=='out'){ el.appendChild(F('خروج کالا',[{l:'نام کالا',n:'item'},{l:'تعداد',n:'qty',type:'number'},{l:'مصرف برای',n:'use',tag:'select',list:['درمان','فروش','دیگر']},{l:'تاریخ',n:'date',type:'date'}])); }
    if(subKey=='low'){ el.appendChild(F('کسری/حداقل موجودی',[{l:'آستانهٔ هشدار',n:'min',type:'number'}])); }
  }
  if(modKey=='lab'){
    if(subKey=='send'){ el.appendChild(F('ارسال به لابراتوار',[{l:'بیمار',n:'pt'},{l:'نوع کار',n:'job',tag:'select',list:['روکش','بریج','دندان مصنوعی','اوردنچر']},{l:'تاریخ ارسال',n:'date',type:'date'},{l:'یادداشت',n:'note',tag:'textarea'}])); }
    if(subKey=='receive'){ el.appendChild(F('دریافت از لابراتوار',[{l:'شماره سفارش',n:'code'},{l:'تاریخ دریافت',n:'date',type:'date'},{l:'وضعیت',n:'status',tag:'select',list:['کامل','ناقص','نیاز به اصلاح']}])); }
    if(subKey=='track'){ el.appendChild(F('پیگیری کار لابراتوار',[{l:'شماره/بیمار',n:'q'}])); }
    if(subKey=='bill'){ el.appendChild(F('ثبت هزینه لابراتوار',[{l:'لابراتوار',n:'lab'},{l:'مبلغ',n:'amt',type:'number'},{l:'تاریخ',n:'date',type:'date'}])); }
  }
  return el;
}
function openEntry(k){ setActiveNav(k); const mod=ALL_TILES.find(x=>x.k===k); const box=document.createElement('div'); box.innerHTML='<div class="mini">یک عمل را انتخاب کنید:</div>';
  (mod.subs||[]).forEach(([sk,lab])=>{ const b=document.createElement('button'); b.className='btn'; b.style.margin='8px 6px 0 0'; b.textContent=lab; b.onclick=()=>openRoute(mod.k, sk); box.appendChild(b); });
  openSheet(mod.t+' • انتخاب عمل', box); setHandlers(null, closeSheet, closeSheet); }
function openRoute(modKey, subKey){ setActiveNav(modKey); const host=buildForm(modKey, subKey); const title=(ALL_TILES.find(t=>t.k===modKey).t)+' • '+(ALL_TILES.find(t=>t.k===modKey).subs.find(s=>s[0]===subKey)[1]);
  openSheet(title, host); setHandlers(()=>submitForm(modKey, subKey), ()=>openEntry(modKey), closeSheet); }
function submitForm(modKey, subKey){ const data={}; sBody.querySelectorAll('input,select,textarea').forEach(i=>data[i.name]=i.value);
  if(modKey==='patients' && subKey==='add'){ const arr=DB.get('DOS.PATIENTS',[]); arr.push(data); DB.set('DOS.PATIENTS',arr); }
  DB.set(`DOS.${modKey}.${subKey}.last`, {at:Date.now(), data}); toast('ثبت شد ✅'); }

/* Calendar */
function d2j(gy,gm,gd){const gdm=[0,31,59,90,120,151,181,212,243,273,304,334];gy-=1600;gm--;gd--;let g=365*gy+((gy+3)>>2)-((gy+99)>>2)+((gy+399)>>2);g+=gdm[gm]+gd;if(gm>1&&((gy%4==0&&gy%100!=0)||(gy%400==0)))g++;let j=g-79;let np=(j/12053)|0;j%=12053;let jy=979+33*np+4*((j/1461)|0);j%=1461;if(j>=366){jy+=(j-1)/365|0;j=(j-1)%365}let jm=(j<186)?1+(j/31|0):7+((j-186)/30|0);let jd=1+((j<186)?(j%31):((j-186)%30));return[jy,jm,jd]}
function jMonthLen(jy,jm){return jm<=6?31:jm<=11?30:29}
function j2g(jy,jm,jd){jy-=979;let j=365*jy+((jy/33)|0)*8+(((jy%33)+3)/4|0);for(let i=1;i<jm;i++)j+=i<=6?31:i<=11?30:29;j+=jd-1;let g=j+79;let gy=1600+400*((g/146097)|0);g%=146097;if(g>=36525){g--;gy+=100*((g/36524)|0);g%=36524;if(g>=365)g--}gy+=4*((g/1461)|0);g%=1461;if(g>=366){g--;gy+=(g/365)|0;g%=365}function gml(y,m){return[31,((y%4==0&&y%100!=0)||(y%400==0))?29:28,31,30,31,30,31,31,30,31,30,31][m-1]}let gm=1;for(;gm<=12&&g>=gml(gy,gm);gm++){g-=gml(gy,gm)}let gd=g+1;return[gy,gm,gd]}
function buildCalendar(container,date=new Date()){ const [jy,jm,jd]=d2j(date.getFullYear(),date.getMonth()+1,date.getDate()); renderCal(container,jy,jm,jd); }
function renderCal(container,jy,jm,today_d){
  container.innerHTML=''; const wrap=document.createElement('div'); const head=document.createElement('div'); head.className='calhead';
  const ttl=document.createElement('div'); ttl.textContent=`تقویم • ${jy}/${String(jm).padStart(2,'0')}`;
  const prev=document.createElement('button'); prev.className='btn'; prev.textContent='◀';
  const next=document.createElement('button'); next.className='btn'; next.textContent='▶';
  prev.onclick=()=>{ const njm=jm===1?12:jm-1; const njy=jm===1?jy-1:jy; renderCal(container, njy, njm, null); };
  next.onclick=()=>{ const njm=jm===12?1:jm+1; const njy=jm===12?jy+1:jy; renderCal(container, njy, njm, null); };
  head.append(prev, ttl, next);
  const grid=document.createElement('div'); grid.className='calgrid';
  'ش ی د س چ پ ج'.split(' ').forEach(d=>{ const e=document.createElement('div'); e.className='caldow'; e.textContent=d; grid.appendChild(e); });
  const [gy1,gm1,gd1]=j2g(jy,jm,1); const wk=new Date(gy1,gm1-1,gd1).getDay(); const start=(wk+1)%7;
  for(let i=0;i<start;i++){ const e=document.createElement('div'); e.className='calday hidden'; grid.appendChild(e); }
  const len=jMonthLen(jy,jm); for(let d=1; d<=len; d++){ const e=document.createElement('div'); e.className='calday'; e.textContent=d; if(d===today_d) e.classList.add('today');
    const plus=document.createElement('span'); plus.className='plus'; plus.textContent='+'; e.appendChild(plus);
    let holdTimer=null; let longPressed=false;
    e.addEventListener('pointerdown', ()=>{ longPressed=false; holdTimer=setTimeout(()=>{ longPressed=true; openRoute('events','quick'); }, 700); });
    e.addEventListener('pointerup', ()=>{ clearTimeout(holdTimer); if(!longPressed){ openRoute('events','today'); } });
    e.addEventListener('pointerleave', ()=>{ clearTimeout(holdTimer); });
    grid.appendChild(e);
  }
  wrap.append(head, grid); container.appendChild(wrap);
}
buildCalendar(EL('#calHost'), new Date());

/* ===== Hamburger ===== */
const hamb=EL('#hamb'), sidemenu=EL('#sidemenu'), backdrop=EL('#backdrop');
function closeMenu(){ hamb.classList.remove('active'); sidemenu.classList.remove('open'); backdrop.classList.remove('show'); }
hamb.onclick=()=>{ hamb.classList.toggle('active'); sidemenu.classList.toggle('open'); backdrop.classList.toggle('show'); };
backdrop.onclick=closeMenu;
sidemenu.addEventListener('click',(e)=>{
  const act=e.target.closest('[data-act]'); if(!act) return;
  if(act.dataset.act==='askNoti'){ if('Notification' in window) Notification.requestPermission().then(p=>toast(p==='granted'?'اعلان فعال شد':'اجازه داده نشد')); else toast('اعلان پشتیبانی نمی‌شود'); }
  if(act.dataset.act==='askMic'){ navigator.mediaDevices?.getUserMedia({audio:true}).then(()=>toast('دسترسی میکروفون OK')).catch(()=>toast('رد شد')); }
  if(act.dataset.act==='installPWA'){ promptPWA(); }
  if(act.dataset.act==='updateApp'){ toast('برای آپدیت، فایل جدید را جایگزین کنید.'); }
});

/* Search + Voice */
const micBtn=EL('#micBtn'), q=EL('#q'); let rec=null, recognizing=false;
function ensureRecognizer(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('SpeechRecognition پشتیبانی نمی‌شود'); return null; } const r=new SR(); r.lang='fa-IR'; r.interimResults=true; r.continuous=false; r.onresult=(ev)=>{ let txt=''; for(const res of ev.results){ txt+=res[0].transcript } q.value=txt; }; r.onend=()=>{ recognizing=false; micBtn.classList.remove('rec'); }; return r; }
micBtn.onclick=()=>{ if(recognizing){ rec&&rec.stop(); return; } if(!rec) rec=ensureRecognizer(); if(!rec) return; recognizing=true; micBtn.classList.add('rec'); try{ rec.start(); }catch(e){} };
EL('#searchBtn').onclick=runSearch; q.addEventListener('keydown',e=>{ if(e.key==='Enter') runSearch(); });
function runSearch(){ const v=q.value.trim(); if(!v){ toast('متنی وارد کنید'); return; }
  if(/امروز|today/i.test(v)) openRoute('events','today');
  else if(/نوبت|وقت/.test(v)) openRoute('events','quick');
  else if(/چک/.test(v)) openRoute('finance','check');
  else if(/قسط|اقساط/.test(v)) openRoute('finance','installment');
  else if(/بیمار/.test(v)) openRoute('patients','list');
  else openSheet('نتیجه جستجو','جستجوی آفلاین نتیجهٔ دقیقی پیدا نکرد.'); }

/* AI Orb drag */
(function(){ const orb=EL('#aiOrb'); const pos=DB.get('DOS.ai.pos',null);
  if(pos){ orb.style.left=pos.l; orb.style.top=pos.t; orb.style.right='auto'; orb.style.bottom='auto'; }
  let dragging=false, dx=0, dy=0;
  orb.addEventListener('pointerdown', (e)=>{ dragging=true; const r=orb.getBoundingClientRect(); dx=e.clientX-r.left; dy=e.clientY-r.top; orb.setPointerCapture(e.pointerId); });
  window.addEventListener('pointermove', (e)=>{ if(!dragging) return; orb.style.left=(e.clientX-dx)+'px'; orb.style.top=(e.clientY-dy)+'px'; orb.style.right='auto'; orb.style.bottom='auto'; });
  window.addEventListener('pointerup', ()=>{ if(!dragging) return; dragging=false; DB.set('DOS.ai.pos',{l:orb.style.left,t:orb.style.top}); });
  orb.addEventListener('click', ()=> q.focus() );
})();

/* iOS-like droplet gesture following finger */
(function(){
  let active = false;
  function move(e){
    if(!active) return;
    const rect = bnav.getBoundingClientRect();
    const x = Math.max(rect.left+36, Math.min(e.clientX, rect.right-36));
    const y = rect.top + rect.height/2;
    droplet.style.transform = `translate(${x-36}px, ${y-36}px)`;
  }
  bnav.addEventListener('pointerdown', (e)=>{ active=true; droplet.classList.add('show'); move(e); });
  window.addEventListener('pointermove', move);
  window.addEventListener('pointerup', ()=>{ active=false; droplet.classList.remove('show'); });
})();

/* Tile options */
function openTileOptions(k){ const mod=ALL_TILES.find(x=>x.k===k); const wrap=document.createElement('div'); wrap.innerHTML=`<div class="mini">تنظیمات «${mod.t}»</div>`; (mod.subs||[]).forEach(([sk,lab])=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=lab; b.onclick=()=>openRoute(mod.k, sk); wrap.appendChild(b); }); openSheet('تنظیمات کاشی', wrap); setHandlers(null, closeSheet, closeSheet); }

/* AutoTest */
function simulateFill(){ const inputs=sBody.querySelectorAll('input,select,textarea'); inputs.forEach((el,i)=>{ if(el.tagName==='SELECT'){ el.selectedIndex=Math.min(1, el.options.length-1); } else if(el.type==='time'){ el.value='10:00'; } else if(el.type==='date'){ el.value=new Date().toISOString().slice(0,10); } else if(el.type==='number'){ el.value=100000*(i+1); } else { el.value= el.placeholder || 'نمونه'; } }); }
function runScenario(){
  const R=[]; const roleWas=roleSel.value;
  function log(ok,msg){ R.push((ok?'✅ ':'❌ ')+msg); }
  const ptName='بیمار نمونه ' + Math.floor(Math.random()*1000);
  openRoute('patients','add'); setTimeout(()=>{
    try{ sBody.querySelector('[name="name"]').value=ptName; sBody.querySelector('[name="tel"]').value='09120000000'; submitForm('patients','add'); log(true,'patients/add: ثبت بیمار'); }
    catch(e){ log(false,'patients/add: خطا '+e.message); }
    openRoute('events','quick'); setTimeout(()=>{
      try{ sBody.querySelector('[name="pt"]').value=ptName; sBody.querySelector('[name="t"]').value='11:00'; submitForm('events','quick'); log(true,'events/quick: نوبت برای بیمار ثبت شد'); }
      catch(e){ log(false,'events/quick: خطا '+e.message); }
      openRoute('finance','installment'); setTimeout(()=>{
        try{ sBody.querySelector('[name="pt"]').value=ptName; sBody.querySelector('[name="total"]').value=2000000; sBody.querySelector('[name="pre"]').value=0; sBody.querySelector('[name="n"]').value=4; submitForm('finance','installment'); log(true,'finance/installment: قسط برای بیمار ساخته شد'); }
        catch(e){ log(false,'finance/installment: خطا '+e.message); }
        try{
          const pts=DB.get('DOS.PATIENTS',[]); const found=pts.some(p=>p.name===ptName);
          log(found,'بررسی لیست بیماران در ذخیره‌ساز');
        }catch(e){ log(false,'خواندن ذخیره‌ساز بیماران'); }
        if('Notification' in window){
          Notification.requestPermission().then(p=>{
            if(p==='granted'){ new Notification('DentalOS',{body:`یادآور تست برای ${ptName}`}); log(true,'اعلان نمونه ارسال شد'); after(); }
            else { log(false,'اجازه اعلان داده نشد'); after(); }
          });
        } else { log(false,'مرورگر اعلان ندارد'); after(); }
      },130);
    },130);
  },130);
  function after(){ roleSel.value=roleWas; buildTiles(); rebuildBottomNav(); EL('#report').value=R.join('\\n'); toast('تست سناریوی واقعی تمام شد'); }
}
EL('#runTests').onclick=runScenario;

function runDeep(){
  const R=[]; let i=0; const plans=[];
  ALL_TILES.forEach(m=> (m.subs||[]).forEach(s=> plans.push([m.k,s[0]])));
  function log(ok,msg){ R.push((ok?'✅ ':'❌ ')+msg); }
  function step(){
    if(i>=plans.length){ EL('#report').value=R.join('\\n'); toast('تست عمیق تمام شد'); return; }
    const [mk,sk]=plans[i++];
    try{
      openRoute(mk,sk);
      setTimeout(()=>{ simulateFill(); try{ submitForm(mk,sk); log(true, mk+'/'+sk+': ثبت شد'); } catch(e){ log(false, mk+'/'+sk+': خطا') } setTimeout(step,90); },70);
    }catch(e){ log(false, mk+'/'+sk+': باز نشد'); setTimeout(step,60); }
  }
  step();
}
EL('#runDeep').onclick=runDeep;
EL('#copyReport').onclick=()=>{ const ta=EL('#report'); ta.select(); try{ navigator.clipboard.writeText(ta.value).then(()=>toast('کپی شد')); }catch(e){ document.execCommand('copy'); toast('کپی شد'); } };

/* PWA */
let deferredPrompt=null; window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; });
function promptPWA(){ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; } else toast('در این مرورگر گزینهٔ نصب در دسترس نیست.'); }

/* Theme switching */
EL('#themeSel').onchange=e=>{ const v=e.target.value; if(v==='aqua'){ document.body.style.background='linear-gradient(180deg,#06141f,#093a5c)'; } else if(v==='sunset'){ document.body.style.background='linear-gradient(180deg,#190a14,#4b112a,#0e1226)'; } else if(v==='dark'){ document.body.style.background='linear-gradient(180deg,#06060a,#0b0b0f)'; } else { location.reload(); } };
</script>

<!-- JALALI CALENDAR FIX • ADD-ONLY -->
<style>
  /* Header: modern gradient, big font */
  .jalali-live-header{
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text","SF Pro Display", Segoe UI, Roboto, sans-serif;
    font-weight: 700;
    font-size: clamp(14px, 3.4vw, 22px);
    line-height: 1.4;
    letter-spacing: 0.2px;
    display:flex;align-items:center;gap:.55rem;
    background: linear-gradient(135deg,#9ae6ff,#b6f3c6,#ffd28f,#ff9ac0);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    padding:.25rem .65rem .35rem;
    border-radius:14px;
    width:max-content;
    margin:.25rem auto .5rem;
    filter: drop-shadow(0 6px 16px rgba(0,0,0,.25));
  }
  .jalali-live-header .clock{
    font-variant-numeric: tabular-nums;
    font-size: .92em;
    background: rgba(255,255,255,.1);
    color: #fff;
    -webkit-background-clip: initial;background-clip: initial;
    padding:.15rem .5rem;border-radius:10px;border:1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(8px) saturate(1.4);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 8px 24px rgba(0,0,0,.25);
  }
  .cal-grid .day{
    display:flex;align-items:center;justify-content:center;
    height:46px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
    background: radial-gradient(120% 150% at 50% -20%, rgba(255,255,255,.18), rgba(120,160,220,.06) 50%, rgba(255,255,255,.04) 100%);
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.15), 0 6px 14px rgba(0,0,0,.18);
    color:#e9f3ff;font-weight:700; font-size:1.05rem;
  }
  .cal-grid .day.empty{ visibility:hidden }
  /* 3D glossy today pill inside calendar */
  #calHost .day.today{
    position: relative;
    background: radial-gradient(140% 120% at 10% 5%, rgba(255,255,255,.9), rgba(180,225,255,.55) 32%, rgba(150,210,255,.35) 50%, rgba(110,160,255,.2) 70%, rgba(90,120,220,.12) 90%);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.65),
      inset 0 -2px 6px rgba(0,0,0,.18),
      0 10px 26px rgba(0,30,90,.28),
      0 2px 8px rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.45) !important;
    outline: 2px solid rgba(0,220,255,.35);
    transform: translateZ(0);
  }
  #calHost .day.today::after{
    content: "امروز";
    position:absolute;bottom:6px;left:50%;transform:translateX(-50%);
    font-size:.7em;color:#0b3868;opacity:.9;font-weight:700;letter-spacing:.4px;
    text-shadow:0 1px 0 rgba(255,255,255,.6);
  }
</style>
<script>
(function(){
  // Skip if calHost is missing
  const host = document.getElementById('calHost'); if(!host) return;

  // --- Utilities (fallbacks if not already defined on page) ---
  const PERSIAN_DIGITS = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  const toFa = s => String(s).replace(/[0-9]/g, d => PERSIAN_DIGITS[d]);

  const MONTH_NAMES = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  const WDAY_NAMES = ['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];

  // Use page's jalaali helpers if present; otherwise lightweight fallbacks
  const d2j = window.d2j || function(gy, gm, gd){
    // Jalaali conversion (https://github.com/jalaali/jalaali-js algorithm, trimmed)
    function div(a,b){return ~~(a/b);}
    function g2d(gy,gm,gd){
      var a=div((gy+399)/400), b=gy-400*a;
      return 365*gy + div(gy+3,4) - div(gy+99,100) + div(gy+399,400) + div(306*(gm+1),10) + (gd-429);
    }
    function d2g(jdn){
      var j = 4*jdn + 139361631, i = div(j%146097,4)*4+3;
      j = j/146097 - div(i,4);
      var gd = div((i%1461),4)*5 + 2;
      var gm = div(gd%153,5) + 3; gd = div(gd,153) + 1;
      var gy = 100*j + div(i,1461) - 1600 + div(gm,13);
      gm = (gm-1)%12 + 1;
      return [gy, gm, gd];
    }
    function jalCal(jy){
      var breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,1767,1867,1995,2072,2097,2192,2262,2324,2394,2456,3178], bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm, jump, n, i;
      if(jy<jp||jy>=breaks[bl-1]) throw Error('bad jalali year '+jy);
      for(i=1;i<bl;i++){ jm=breaks[i]; jump=jm-jp; if(jy<jm) break; leapJ+=div(jump,33)*8 + div(jump%33,4); jp=jm; }
      n=jy-jp; leapJ+=div(n,33)*8 + div((n%33)+3,4); var leapG=div(gy,4)-div((div(gy,100)+1)*3,4)-150;
      var march=20+leapJ-leapG; return {gy:gy, march:march};
    }
    function j2d(jy,jm,jd){
      var r=jalCal(jy); var gy=r.gy, march=r.march;
      var jdn = g2d(gy,3, march) + (jm-1)*31 - div(jm,7)*(jm-7) + (jd-1);
      return jdn;
    }
    function d2j_inner(gy,gm,gd){
      var jdn = g2d(gy,gm,gd), gy2=gy-621, r, jdn1f, jd, jm, jy;
      r = jalCal(gy2); jdn1f = g2d(gy,3,r.march);
      jd = jdn - jdn1f;
      if (jd >= 0) {
        if (jd <= 185) { jm = 1 + div(jd, 31); jd = (jd % 31) + 1; }
        else { jd -= 186; jm = 7 + div(jd, 30); jd = (jd % 30) + 1; }
        jy = gy2;
      } else {
        jy = gy2 - 1; r = jalCal(jy); jdn1f = g2d(r.gy,3,r.march);
        jd = jdn - jdn1f;
        if (jd <= 185) { jm = 1 + div(jd, 31); jd = (jd % 31) + 1; }
        else { jd -= 186; jm = 7 + div(jd, 30); jd = (jd % 30) + 1; }
      }
      return [jy, jm, jd];
    }
    return d2j_inner(gy,gm,gd);
  };
  const j2g = window.j2g || function(jy,jm,jd){
    function div(a,b){return ~~(a/b);}
    function g2d(gy,gm,gd){var a=~~((gy+399)/400), b=gy-400*a;return 365*gy + ~~((gy+3)/4) - ~~((gy+99)/100) + ~~((gy+399)/400) + ~~((306*(gm+1))/10) + (gd-429);}
    function d2g(jdn){var j = 4*jdn + 139361631, i = ~~(j%146097/4)*4+3; j = ~~(j/146097) - ~~(i/4); var gd = ~~((i%1461)/4)*5 + 2; var gm = ~~((gd%153)/5) + 3; gd = ~~(gd/153) + 1; var gy = 100*j + ~~(i/1461) - 1600 + ~~(gm/13); gm = (gm-1)%12 + 1; return [gy,gm,gd];}
    function jalCal(jy){var breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,1767,1867,1995,2072,2097,2192,2262,2324,2394,2456,3178], bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm, jump, n, i;for(i=1;i<bl;i++){jm=breaks[i];jump=jm-jp;if(jy<jm)break;leapJ+=~~(jump/33)*8+~~((jump%33)/4);jp=jm}n=jy-jp;leapJ+=~~(n/33)*8+~~(((n%33)+3)/4);var leapG=~~(gy/4)-~~(((~~(gy/100)+1)*3)/4)-150;var march=20+leapJ-leapG;return {gy:gy, march:march};}
    function j2d(jy,jm,jd){var r=jalCal(jy);var gy=r.gy, march=r.march; return (365*gy + ~~((gy+3)/4) - ~~((gy+99)/100) + ~~((gy+399)/400) + ~~((306*3+6)/10) + (march-429)) + (jm-1)*31 - ~~(jm/7)*(jm-7) + (jd-1);}
    var jdn = j2d(jy,jm,jd); return d2g(jdn);
  };
  const jMonthLen = window.jMonthLen || function(jy,jm){
    // robust: length = days between 1st of this month and 1st of next month
    let njy = jy, njm = jm+1, njd = 1;
    if(njm===13){ njy++; njm=1; }
    const a = j2g(jy,jm,1), b = j2g(njy,njm,1);
    const da = new Date(a[0],a[1]-1,a[2]);
    const db = new Date(b[0],b[1]-1,b[2]);
    return Math.round((db - da)/86400000);
  };

  function buildMonth(jy,jm){
    // Build the month grid into #calHost using the app's styles
    const gFirst = j2g(jy, jm, 1);
    const wk = new Date(gFirst[0], gFirst[1]-1, gFirst[2]).getDay(); // 0=Sun..6=Sat
    const startOffset = (wk + 1) % 7; // columns are Sat..Fri
    const days = jMonthLen(jy,jm);

    // header
    const now = new Date();
    const [ty, tm, td] = d2j(now.getFullYear(), now.getMonth()+1, now.getDate());
    const todayW = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getDay();
    const header = `
      <div class="jalali-live-header" id="jalaliLiveHeader">
        <span class="wday">${WDAY_NAMES[todayW===6?0:todayW+1]}</span>
        <span class="date">${toFa(td)}</span>
        <span class="month">${MONTH_NAMES[tm-1]}</span>
        <span class="year">${toFa(ty)}</span>
        <span class="clock" id="jalaliClock">--:--:--</span>
      </div>
    `;

    // grid
    let cells = '';
    for(let i=0;i<startOffset;i++){
      cells += '<div class="day empty"></div>';
    }
    for(let d=1; d<=days; d++){
      const isToday = (jy===ty && jm===tm && d===td);
      cells += `<div class="day${isToday?' today':''}"><span>${toFa(d)}</span></div>`;
    }

    const html = `
      ${header}
      <div class="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:.55rem;place-items:stretch;">
        ${cells}
      </div>
    `;
    host.innerHTML = html;

    // live clock
    function tick(){
      const n = new Date();
      const h=n.getHours().toString().padStart(2,'0');
      const m=n.getMinutes().toString().padStart(2,'0');
      const s=n.getSeconds().toString().padStart(2,'0');
      const el=document.getElementById('jalaliClock'); if(el) el.textContent = toFa(`${h}:${m}:${s}`);
    }
    tick(); setInterval(tick,1000);
  }

  // Build for *current* Jalali month
  (function init(){
    const now = new Date();
    const [jy, jm] = d2j(now.getFullYear(), now.getMonth()+1, now.getDate());
    try { buildMonth(jy, jm); } catch(e){ /* fail silently */ }
  })();
})();
</script>

<!-- JALALI CALENDAR FIX • ADD-ONLY -->
<style>
  /* Header: modern gradient, big font */
  .jalali-live-header{
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text","SF Pro Display", Segoe UI, Roboto, sans-serif;
    font-weight: 700;
    font-size: clamp(14px, 3.4vw, 22px);
    line-height: 1.4;
    letter-spacing: 0.2px;
    display:flex;align-items:center;gap:.55rem;
    background: linear-gradient(135deg,#9ae6ff,#b6f3c6,#ffd28f,#ff9ac0);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    padding:.25rem .65rem .35rem;
    border-radius:14px;
    width:max-content;
    margin:.25rem auto .5rem;
    filter: drop-shadow(0 6px 16px rgba(0,0,0,.25));
  }
  .jalali-live-header .clock{
    font-variant-numeric: tabular-nums;
    font-size: .92em;
    background: rgba(255,255,255,.1);
    color: #fff;
    -webkit-background-clip: initial;background-clip: initial;
    padding:.15rem .5rem;border-radius:10px;border:1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(8px) saturate(1.4);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 8px 24px rgba(0,0,0,.25);
  }
  .cal-grid .day{
    display:flex;align-items:center;justify-content:center;
    height:46px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
    background: radial-gradient(120% 150% at 50% -20%, rgba(255,255,255,.18), rgba(120,160,220,.06) 50%, rgba(255,255,255,.04) 100%);
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.15), 0 6px 14px rgba(0,0,0,.18);
    color:#e9f3ff;font-weight:700; font-size:1.05rem;
  }
  .cal-grid .day.empty{ visibility:hidden }
  /* 3D glossy today pill inside calendar */
  #calHost .day.today{
    position: relative;
    background: radial-gradient(140% 120% at 10% 5%, rgba(255,255,255,.9), rgba(180,225,255,.55) 32%, rgba(150,210,255,.35) 50%, rgba(110,160,255,.2) 70%, rgba(90,120,220,.12) 90%);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.65),
      inset 0 -2px 6px rgba(0,0,0,.18),
      0 10px 26px rgba(0,30,90,.28),
      0 2px 8px rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.45) !important;
    outline: 2px solid rgba(0,220,255,.35);
    transform: translateZ(0);
  }
  #calHost .day.today::after{
    content: "امروز";
    position:absolute;bottom:6px;left:50%;transform:translateX(-50%);
    font-size:.7em;color:#0b3868;opacity:.9;font-weight:700;letter-spacing:.4px;
    text-shadow:0 1px 0 rgba(255,255,255,.6);
  }
</style>
<script>
(function(){
  // Skip if calHost is missing
  const host = document.getElementById('calHost'); if(!host) return;

  // --- Utilities (fallbacks if not already defined on page) ---
  const PERSIAN_DIGITS = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  const toFa = s => String(s).replace(/[0-9]/g, d => PERSIAN_DIGITS[d]);

  const MONTH_NAMES = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  const WDAY_NAMES = ['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];

  // Use page's jalaali helpers if present; otherwise lightweight fallbacks
  const d2j = window.d2j || function(gy, gm, gd){
    // Jalaali conversion (https://github.com/jalaali/jalaali-js algorithm, trimmed)
    function div(a,b){return ~~(a/b);}
    function g2d(gy,gm,gd){
      var a=div((gy+399)/400), b=gy-400*a;
      return 365*gy + div(gy+3,4) - div(gy+99,100) + div(gy+399,400) + div(306*(gm+1),10) + (gd-429);
    }
    function d2g(jdn){
      var j = 4*jdn + 139361631, i = div(j%146097,4)*4+3;
      j = j/146097 - div(i,4);
      var gd = div((i%1461),4)*5 + 2;
      var gm = div(gd%153,5) + 3; gd = div(gd,153) + 1;
      var gy = 100*j + div(i,1461) - 1600 + div(gm,13);
      gm = (gm-1)%12 + 1;
      return [gy, gm, gd];
    }
    function jalCal(jy){
      var breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,1767,1867,1995,2072,2097,2192,2262,2324,2394,2456,3178], bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm, jump, n, i;
      if(jy<jp||jy>=breaks[bl-1]) throw Error('bad jalali year '+jy);
      for(i=1;i<bl;i++){ jm=breaks[i]; jump=jm-jp; if(jy<jm) break; leapJ+=div(jump,33)*8 + div(jump%33,4); jp=jm; }
      n=jy-jp; leapJ+=div(n,33)*8 + div((n%33)+3,4); var leapG=div(gy,4)-div((div(gy,100)+1)*3,4)-150;
      var march=20+leapJ-leapG; return {gy:gy, march:march};
    }
    function j2d(jy,jm,jd){
      var r=jalCal(jy); var gy=r.gy, march=r.march;
      var jdn = g2d(gy,3, march) + (jm-1)*31 - div(jm,7)*(jm-7) + (jd-1);
      return jdn;
    }
    function d2j_inner(gy,gm,gd){
      var jdn = g2d(gy,gm,gd), gy2=gy-621, r, jdn1f, jd, jm, jy;
      r = jalCal(gy2); jdn1f = g2d(gy,3,r.march);
      jd = jdn - jdn1f;
      if (jd >= 0) {
        if (jd <= 185) { jm = 1 + div(jd, 31); jd = (jd % 31) + 1; }
        else { jd -= 186; jm = 7 + div(jd, 30); jd = (jd % 30) + 1; }
        jy = gy2;
      } else {
        jy = gy2 - 1; r = jalCal(jy); jdn1f = g2d(r.gy,3,r.march);
        jd = jdn - jdn1f;
        if (jd <= 185) { jm = 1 + div(jd, 31); jd = (jd % 31) + 1; }
        else { jd -= 186; jm = 7 + div(jd, 30); jd = (jd % 30) + 1; }
      }
      return [jy, jm, jd];
    }
    return d2j_inner(gy,gm,gd);
  };
  const j2g = window.j2g || function(jy,jm,jd){
    function div(a,b){return ~~(a/b);}
    function g2d(gy,gm,gd){var a=~~((gy+399)/400), b=gy-400*a;return 365*gy + ~~((gy+3)/4) - ~~((gy+99)/100) + ~~((gy+399)/400) + ~~((306*(gm+1))/10) + (gd-429);}
    function d2g(jdn){var j = 4*jdn + 139361631, i = ~~(j%146097/4)*4+3; j = ~~(j/146097) - ~~(i/4); var gd = ~~((i%1461)/4)*5 + 2; var gm = ~~((gd%153)/5) + 3; gd = ~~(gd/153) + 1; var gy = 100*j + ~~(i/1461) - 1600 + ~~(gm/13); gm = (gm-1)%12 + 1; return [gy,gm,gd];}
    function jalCal(jy){var breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,1767,1867,1995,2072,2097,2192,2262,2324,2394,2456,3178], bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm, jump, n, i;for(i=1;i<bl;i++){jm=breaks[i];jump=jm-jp;if(jy<jm)break;leapJ+=~~(jump/33)*8+~~((jump%33)/4);jp=jm}n=jy-jp;leapJ+=~~(n/33)*8+~~(((n%33)+3)/4);var leapG=~~(gy/4)-~~(((~~(gy/100)+1)*3)/4)-150;var march=20+leapJ-leapG;return {gy:gy, march:march};}
    function j2d(jy,jm,jd){var r=jalCal(jy);var gy=r.gy, march=r.march; return (365*gy + ~~((gy+3)/4) - ~~((gy+99)/100) + ~~((gy+399)/400) + ~~((306*3+6)/10) + (march-429)) + (jm-1)*31 - ~~(jm/7)*(jm-7) + (jd-1);}
    var jdn = j2d(jy,jm,jd); return d2g(jdn);
  };
  const jMonthLen = window.jMonthLen || function(jy,jm){
    if(jm<=6) return 31;
    if(jm<=11) return 30;
    // Esfand
    // simple leap approx:
    return (((jy+38)*31)%128) < 31 ? 30 : 29; // keeps offline, no big libs
  };

  function buildMonth(jy,jm){
    // Build the month grid into #calHost using the app's styles
    const gFirst = j2g(jy, jm, 1);
    const wk = new Date(gFirst[0], gFirst[1]-1, gFirst[2]).getDay(); // 0=Sun..6=Sat
    const startOffset = (wk + 1) % 7; // columns are Sat..Fri
    const days = jMonthLen(jy,jm);

    // header
    const now = new Date();
    const [ty, tm, td] = d2j(now.getFullYear(), now.getMonth()+1, now.getDate());
    const todayW = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getDay();
    const header = `
      <div class="jalali-live-header" id="jalaliLiveHeader">
        <span class="wday">${WDAY_NAMES[todayW===6?0:todayW+1]}</span>
        <span class="date">${toFa(td)}</span>
        <span class="month">${MONTH_NAMES[tm-1]}</span>
        <span class="year">${toFa(ty)}</span>
        <span class="clock" id="jalaliClock">--:--:--</span>
      </div>
    `;

    // grid
    let cells = '';
    for(let i=0;i<startOffset;i++){
      cells += '<div class="day empty"></div>';
    }
    for(let d=1; d<=days; d++){
      const isToday = (jy===ty && jm===tm && d===td);
      cells += `<div class="day${isToday?' today':''}"><span>${toFa(d)}</span></div>`;
    }

    const html = `
      ${header}
      <div class="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:.55rem;place-items:stretch;">
        ${cells}
      </div>
    `;
    host.innerHTML = html;

    // live clock
    function tick(){
      const n = new Date();
      const h=n.getHours().toString().padStart(2,'0');
      const m=n.getMinutes().toString().padStart(2,'0');
      const s=n.getSeconds().toString().padStart(2,'0');
      const el=document.getElementById('jalaliClock'); if(el) el.textContent = toFa(`${h}:${m}:${s}`);
    }
    tick(); setInterval(tick,1000);
  }

  // Build for *current* Jalali month
  (function init(){
    const now = new Date();
    const [jy, jm] = d2j(now.getFullYear(), now.getMonth()+1, now.getDate());
    try { buildMonth(jy, jm); } catch(e){ /* fail silently */ }
  })();
})();
</script>


<!-- DENTALOS • CALENDAR V2 (ADD-ONLY, NO DELETION) -->
<style id="dos-cal-v2-css">
  /* Orange header like screenshot */
  #dosCalV2{direction:rtl}
  .doscal-head{display:flex;align-items:center;justify-content:space-between;
    background:#f29a18; color:#1e1300; padding:.6rem .8rem; border-radius:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.4);}
  .doscal-head .left, .doscal-head .right{display:flex;align-items:center;gap:.5rem}
  .doscal-head .month{font-weight:900;font-size:1.15rem}
  .doscal-head .date{opacity:.9;font-weight:700}
  .doscal-btn{appearance:none;border:0;border-radius:12px;padding:.35rem .55rem;cursor:pointer;
    background:rgba(255,255,255,.35); box-shadow:inset 0 1px 0 rgba(255,255,255,.8);}
  .doscal-bar{display:flex;gap:.4rem;margin:.55rem 0 .65rem 0; justify-content:flex-start}
  .doscal-pill{width:34px;height:26px;border-radius:10px;display:grid;place-items:center;
    background:rgba(255,255,255,.25); font-weight:800; font-size:.9rem; color:#1e1300}
  .doscal-grid{display:grid;grid-template-columns:repeat(7,1fr); gap:.35rem}
  .doscal-wd{font-size:.8rem;opacity:.85;text-align:center;color:#ffd; padding:.2rem 0}
  .doscal-day{height:46px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
    display:flex;align-items:center;justify-content:center;
    background: radial-gradient(120% 150% at 50% -20%, rgba(255,255,255,.18), rgba(120,160,220,.06) 50%, rgba(255,255,255,.04) 100%);
    backdrop-filter: blur(10px) saturate(1.2);
    -webkit-backdrop-filter: blur(10px) saturate(1.2);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.15), 0 6px 14px rgba(0,0,0,.18);
    color:#e9f3ff;font-weight:800; font-size:1.05rem; position:relative}
  .doscal-day.empty{visibility:hidden}
  .doscal-day.today{background: radial-gradient(140% 120% at 10% 5%, rgba(255,255,255,.9), rgba(180,225,255,.55) 32%, rgba(150,210,255,.35) 50%, rgba(110,160,255,.2) 70%, rgba(90,120,220,.12) 90%);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.65), inset 0 -2px 6px rgba(0,0,0,.18), 0 10px 26px rgba(0,30,90,.28), 0 2px 8px rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.45) !important; outline: 2px solid rgba(0,220,255,.35);}
  .doscal-day.today::after{content:"امروز"; position:absolute;bottom:4px;left:50%;transform:translateX(-50%);
    font-size:.7em;color:#0b3868;opacity:.9;font-weight:700;letter-spacing:.4px;text-shadow:0 1px 0 rgba(255,255,255,.6);}
  /* modal */
  .dos-back{position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.45);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center}
  .dos-modal{max-width:92vw;width:720px;max-height:86vh;overflow:auto;border-radius:20px;background:linear-gradient(145deg,rgba(255,255,255,.86),rgba(245,248,255,.7));box-shadow:0 10px 40px rgba(0,0,0,.3);padding:14px}
  .dos-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.5rem}
  .dos-btn{appearance:none;border:0;border-radius:12px;padding:.6rem .85rem;font-weight:800;cursor:pointer}
  .dos-btn.ghost{background:transparent;border:1px solid rgba(0,0,0,.15)}
  .dos-btn.primary{background:linear-gradient(180deg,#6aa6ff,#3b82f6);color:#fff}
  .dos-list{list-style:none;margin:.5rem 0 0 0;padding:0}
  .dos-li{padding:.5rem .65rem;border-radius:12px;border:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:space-between;margin:.35rem 0}
</style>


<script id="dos-cal-v2-js">
(function(){
  if(window.__DOS_CALV2__) return; window.__DOS_CALV2__=true;

  const host = document.getElementById('calHost'); if(!host) return;
  const PERSIAN_DIGITS = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  const toFa = s => String(s).replace(/[0-9]/g, d => PERSIAN_DIGITS[d]);
  const MONTH_NAMES = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  const WDAY = ['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];

  // Jalali helpers (fallbacks)
  function d2j(gy,gm,gd){const gdm=[0,31,59,90,120,151,181,212,243,273,304,334];gy-=1600;gm--;gd--;let g=365*gy+((gy+3)>>2)-((gy+99)>>2)+((gy+399)>>2);g+=gdm[gm]+gd;if(gm>1&&((gy%4==0&&gy%100!=0)||(gy%400==0)))g++;let j=g-79;let np=(j/12053)|0;j%=12053;let jy=979+33*np+4*((j/1461)|0);j%=1461;if(j>=366){jy+=(j-1)/365|0;j=(j-1)%365}let jm=(j<186)?1+(j/31|0):7+((j-186)/30|0);let jd=1+((j<186)?(j%31):((j-186)%30));return[jy,jm,jd]}
  function j2g(jy,jm,jd){jy-=979;let j=365*jy+((jy/33)|0)*8+(((jy%33)+3)/4|0);for(let i=1;i<jm;i++)j+=i<=6?31:i<=11?30:29;j+=jd-1;let g=j+79;let gy=1600+400*((g/146097)|0);g%=146097;if(g>=36525){g--;gy+=100*((g/36524)|0);g%=36524;if(g>=365)g--}gy+=4*((g/1461)|0);g%=1461;if(g>=366){g--;gy+=(g/365)|0;g%=365}function gml(y,m){return[31,((y%4==0&&y%100!=0)||(y%400==0))?29:28,31,30,31,30,31,31,30,31,30,31][m-1]}let gm=1;for(;gm<=12&&g>=gml(gy,gm);gm++){g-=gml(gy,gm)}let gd=g+1;return[gy,gm,gd]}
  function jMonthLen(jy,jm){return jm<=6?31:jm<=11?30:29}

  // Storage
  const KEY='DENTALOS_EVENTS_V1';
  const loadEvents=()=>{try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){return []}};
  const saveEvents=(a)=>{localStorage.setItem(KEY,JSON.stringify(a)); window.dispatchEvent(new CustomEvent('dentalos:events-updated',{detail:a}));};
  const addEvent=(e)=>{const a=loadEvents(); a.push(e); saveEvents(a);};

  // UI builders
  function headerHTML(jy,jm){
    const now=new Date(); const [ty,tm,td]=d2j(now.getFullYear(),now.getMonth()+1,now.getDate());
    return `<div class="doscal-head">
      <div class="left"><button class="doscal-btn" data-nav="prev">◀</button>
      <div class="month">${MONTH_NAMES[jm-1]} ${toFa(jy)}</div></div>
      <div class="right">
        <div class="date">${toFa(td)} ${MONTH_NAMES[tm-1]}</div>
        <button class="doscal-btn" data-nav="today">امروز</button>
        <button class="doscal-btn" data-nav="next">▶</button>
      </div>
    </div>
    <div class="doscal-bar">
      ${['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'].map(w=>`<div class="doscal-pill">${w[0]}</div>`).join('')}
    </div>`;
  }
  function gridHTML(jy,jm){
    const [gy,gm,gd]=j2g(jy,jm,1);
    const start=(new Date(gy,gm-1,gd).getDay()+1)%7; // Sat..Fri
    const len=jMonthLen(jy,jm);
    const now=new Date(); const [ty,tm,td]=d2j(now.getFullYear(),now.getMonth()+1,now.getDate());
    let h = `<div class="doscal-grid">`;
    // week header
    'ش ی د س چ پ ج'.split(' ').forEach(w=> h += `<div class="doscal-wd">${w}</div>`);
    for(let i=0;i<start;i++) h += `<div class="doscal-day empty"></div>`;
    for(let d=1; d<=len; d++){
      const isToday = (jy===ty && jm===tm && d===td);
      h += `<div class="doscal-day${isToday?' today':''}" data-day="${jy}-${jm}-${d}">${toFa(d)}</div>`;
    }
    h += `</div>`; return h;
  }

  function build(jy,jm){
    const box = document.createElement('div'); box.id='dosCalV2';
    box.innerHTML = headerHTML(jy,jm) + gridHTML(jy,jm);
    host.innerHTML=''; host.appendChild(box);

    // nav
    host.querySelectorAll('.doscal-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        if(b.dataset.nav==='today'){ const n=new Date(); const j=d2j(n.getFullYear(),n.getMonth()+1,n.getDate()); build(j[0],j[1]); return; }
        if(b.dataset.nav==='prev'){ if(jm===1){jy--; jm=12;} else jm--; build(jy,jm); return; }
        if(b.dataset.nav==='next'){ if(jm===12){jy++; jm=1;} else jm++; build(jy,jm); return; }
      });
    });

    // gestures per requirement
    let timer=null, pressed=false;
    host.querySelectorAll('.doscal-day').forEach(cell=>{
      cell.addEventListener('pointerdown', (e)=>{
        if(cell.classList.contains('empty')) return;
        pressed=true;
        timer=setTimeout(()=>{ // long press
          if(!pressed) return;
          const [JY,JM,JD]=cell.dataset.day.split('-').map(Number);
          openDayModal(JY,JM,JD);
        },650);
      });
      cell.addEventListener('pointerup', (e)=>{
        if(cell.classList.contains('empty')) return;
        clearTimeout(timer);
        if(pressed){ openAllEventsModal(); }
        pressed=false;
      });
      cell.addEventListener('pointerleave', ()=>{ pressed=false; clearTimeout(timer); });
    });
  }

  // Modals
  function createBack(){ const b=document.createElement('div'); b.className='dos-back'; b.addEventListener('click',e=>{ if(e.target===b) b.remove();}); return b; }
  function openAllEventsModal(){
    const b=createBack(); const m=document.createElement('div'); m.className='dos-modal';
    m.innerHTML=`<h3>همه رویدادها</h3><ul class="dos-list" id="list"></ul><div class="dos-actions"><button class="dos-btn ghost" id="x">بستن</button></div>`;
    b.appendChild(m); document.body.appendChild(b);
    m.querySelector('#x').onclick=()=>b.remove();
    const L=m.querySelector('#list'); const arr=loadEvents().sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    if(!arr.length){ L.innerHTML='<li class="dos-li">رویدادی ثبت نشده.</li>'; return; }
    L.innerHTML=arr.map(e=>`<li class="dos-li"><div><strong>${e.title||'بدون عنوان'}</strong><div style="opacity:.7;font-size:.85rem">${e.date}${e.time?' · '+e.time:''}${e.section?' · '+e.section:''}</div></div><button class="dos-btn ghost" data-del="${e.id}">حذف</button></li>`).join('');
    L.querySelectorAll('[data-del]').forEach(btn=> btn.onclick=()=>{ const id=btn.getAttribute('data-del'); const list=loadEvents().filter(x=>x.id!==id); saveEvents(list); b.remove(); openAllEventsModal(); });
  }
  function openDayModal(jy,jm,jd){
    const ds = `${jy}-${String(jm).padStart(2,'0')}-${String(jd).padStart(2,'0')}`;
    const b=createBack(); const m=document.createElement('div'); m.className='dos-modal';
    m.innerHTML=`<h3>رویدادهای ${ds}</h3><div id="wrap"></div>
      <h4>ثبت رویداد جدید</h4>
      <input id="t" class="dos-input" placeholder="عنوان *" style="width:100%;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(0,0,0,.12)">
      <div style="display:flex;gap:.5rem;margin-top:.4rem">
        <input id="time" type="time" class="dos-input" style="flex:1;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(0,0,0,.12)">
        <input id="section" placeholder="بخش (اختیاری)" class="dos-input" style="flex:1;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(0,0,0,.12)">
      </div>
      <textarea id="desc" class="dos-input" placeholder="توضیحات" style="margin-top:.4rem;height:90px;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(0,0,0,.12)"></textarea>
      <div class="dos-actions"><button class="dos-btn ghost" id="x">انصراف</button><button class="dos-btn primary" id="save">ذخیره</button></div>`;
    b.appendChild(m); document.body.appendChild(b);
    const wrap = m.querySelector('#wrap');
    function render(){
      const arr = loadEvents().filter(e=>e.date===ds);
      wrap.innerHTML = arr.length?('<ul class="dos-list">'+arr.map(e=>`<li class="dos-li"><div><strong>${e.title}</strong><div style="opacity:.7">${e.time||''} ${e.section?('· '+e.section):''}</div></div><button class="dos-btn ghost" data-del="'+e.id+'">حذف</button></li>`).join('')+'</ul>'):'<div style="opacity:.7">موردی نیست.</div>';
      wrap.querySelectorAll('[data-del]').forEach(btn=> btn.onclick=()=>{ const id=btn.getAttribute('data-del'); const list=loadEvents().filter(x=>x.id!==id); saveEvents(list); render(); });
    }
    render();
    m.querySelector('#x').onclick=()=>b.remove();
    m.querySelector('#save').onclick=()=>{
      const title=m.querySelector('#t').value.trim(); if(!title){ alert('عنوان الزامی است'); return; }
      const evt={id:'evt_'+Math.random().toString(36).slice(2), title, date:ds, time:m.querySelector('#time').value.trim(), desc:m.querySelector('#desc').value.trim(), section:m.querySelector('#section').value.trim(), createdAt:new Date().toISOString()};
      addEvent(evt);
      // Connect to all sections
      if(evt.section){
        const target=document.getElementById(evt.section) || document.querySelector(`[data-section="${evt.section}"], [data-name="${evt.section}"], [data-route="${evt.section}"]`);
        if(target && target.click) target.click();
      }
      window.dispatchEvent(new CustomEvent('dentalos:event-created',{detail:evt}));
      render();
    };
  }

  // Init with current month matching screenshot logic
  (function(){
    const n=new Date(); const j=d2j(n.getFullYear(),n.getMonth()+1,n.getDate());
    build(j[0], j[1]);
  })();

  console.info('[DentalOS] Calendar V2 injected add-only.');
})();
</script>

<!-- PATCHED 2025-08-19T06:36:11.125037 -->


<!-- DOS • JALALI DOW PRECISION PATCH (ADD-ONLY, NO REMOVALS) -->
<script id="dos-jalali-dow-patch-v2">
(function(){
  if(window.__DOS_JalaliDowPatchV2) return; window.__DOS_JalaliDowPatchV2 = true;

  // Robust, timezone-safe helpers scoped here (avoid globals)
  function d2j(gy,gm,gd){
    // Trimmed algorithm (jalaali-js)
    function div(a,b){return ~~(a/b);}
    function g2d(gy,gm,gd){var a=div((gy+399),400); return 365*gy + div(gy+3,4) - div(gy+99,100) + div(gy+399,400) + div(306*(gm+1),10) + (gd-429);}
    function jalCal(jy){
      var breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,1767,1867,1995,2072,2097,2192,2262,2324,2394,2456,3178];
      var bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm, jump, n, i;
      if(jy<jp||jy>=breaks[bl-1]) return {gy:gy, march:20};
      for(i=1;i<bl;i++){ jm=breaks[i]; jump=jm-jp; if(jy<jm) break; leapJ+=div(jump,33)*8 + div(jump%33,4); jp=jm; }
      n=jy-jp; leapJ+=div(n,33)*8 + div((n%33)+3,4); var leapG=div(gy,4)-div((div(gy,100)+1)*3,4)-150;
      var march=20 + leapJ - leapG; return {gy:gy, march:march};
    }
    function d2j_inner(gy,gm,gd){
      var r = jalCal(gy-621), jdn = g2d(gy,gm,gd), jdn1f = g2d(gy,3,r.march);
      var jd = jdn - jdn1f, jm, jy;
      if(jd>=0){ if(jd<=185){ jm = 1 + ~~(jd/31); jd = (jd%31)+1; } else { jd-=186; jm = 7 + ~~(jd/30); jd = (jd%30)+1; } jy = gy-621; }
      else { jy = gy-622; r = jalCal(jy); jdn1f = g2d(gy,3,r.march); jd = jdn - jdn1f; if(jd<=185){ jm = 1 + ~~(jd/31); jd = (jd%31)+1; } else { jd-=186; jm = 7 + ~~(jd/30); jd = (jd%30)+1; } }
      return [jy, jm, jd];
    }
    return d2j_inner(gy,gm,gd);
  }
  function j2g(jy,jm,jd){
    jy-=979;
    var j=365*jy+((jy/33)|0)*8+(((jy%33)+3)/4|0);
    for(var i=1;i<jm;i++) j+= i<=6?31 : (i<=11?30:29);
    j+=jd-1;
    var g=j+79;
    var gy=1600+400*((g/146097)|0); g%=146097;
    if(g>=36525){ g--; gy+=100*((g/36524)|0); g%=36524; if(g>=365) g--; }
    gy+=4*((g/1461)|0); g%=1461;
    if(g>=366){ g--; gy+=(g/365)|0; g%=365; }
    function gml(y,m){ return [31,((y%4==0&&y%100!=0)||(y%400==0))?29:28,31,30,31,30,31,31,30,31,30,31][m-1]; }
    var gm=1; for(;gm<=12&&g>=gml(gy,gm);gm++){ g-=gml(gy,gm); }
    var gd=g+1; return [gy,gm,gd];
  }
  function jalaliDow(jy,jm,jd){
    // 0=شنبه ... 6=جمعه
    var g=j2g(jy,jm,jd);
    // Use noon to avoid TZ rollovers
    var dt = new Date(g[0], g[1]-1, g[2], 12, 0, 0);
    var gd = dt.getDay(); // 0=Sun..6=Sat
    return (gd+1)%7; // map: Sun->1, ... Sat->0
  }

  var host = document.getElementById('calHost');
  if(!host) return;

  var header = host.querySelector('.jalali-live-header');
  if(header){
    var now = new Date();
    var j = d2j(now.getFullYear(), now.getMonth()+1, now.getDate());
    var dow = jalaliDow(j[0], j[1], j[2]); // 0..6
    var names = ['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];
    var wEl = header.querySelector('.wday');
    if(wEl) wEl.textContent = names[dow];
  }

  // Ensure the highlighted "today" bubble marks the exact Jalali today cell
  try{
    var n = new Date(), j = d2j(n.getFullYear(), n.getMonth()+1, n.getDate());
    var cells = host.querySelectorAll('.cal-grid .day');
    // remove any existing today flags
    cells.forEach(function(c){ c.classList.remove('today'); });
    // find nth non-empty cell equal to j[2]
    var idx=0;
    cells.forEach(function(c){
      if(!c.classList.contains('empty')){
        idx++;
        // text may be Persian digits; normalize
        var t = (c.textContent||'').replace(/[۰-۹]/g, function(d){ return '۰۱۲۳۴۵۶۷۸۹'.indexOf(d); });
        if(parseInt(t,10)===j[2]) c.classList.add('today');
      }
    });
  }catch(e){/*silent*/}

  console.info('[DentalOS] Jalali DOW precision patch v2 applied.');
})();
</script>


<!-- DENTALOS • REALTIME JALALI DATE+CLOCK • ADD-ONLY (V3) • 2025-08-19T06:40:51.091296 -->
<script>
(function(){ 
  if(window.__DOS_JALALI_RTC_V3__) return; 
  window.__DOS_JALALI_RTC_V3__=true;

  const host = document.getElementById('calHost'); 
  if(!host) return;

  // Persian digits helpers
  const PERSIAN_DIGITS = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  const toFa = s => String(s).replace(/[0-9]/g, d => PERSIAN_DIGITS[d]);
  const fromFa = s => String(s).replace(/[۰-۹]/g, ch => '۰۱۲۳۴۵۶۷۸۹'.indexOf(ch));

  const MONTH_NAMES = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  const WDAY_NAMES = ['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];

  // Robust jalaali conversion (fallbacks)
  function div(a,b){ return Math.trunc(a/b); }
  function g2d(gy,gm,gd){ return 365*gy + div(gy+3,4) - div(gy+99,100) + div(gy+399,400) + div(306*(gm+1),10) + (gd-429); }
  function jalCal(jy){
    var breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,1767,1867,1995,2072,2097,2192,2262,2324,2394,2456,3178], bl=breaks.length, gy=jy+621, leapJ=-14, jp=breaks[0], jm, jump, n;
    if(jy<jp||jy>=breaks[bl-1]) return {gy:gy, march:20}; // safe fallback
    for(var i=1;i<bl;i++){ jm=breaks[i]; jump=jm-jp; if(jy<jm) break; leapJ+=div(jump,33)*8 + div(jump%33,4); jp=jm; }
    n=jy-jp; leapJ+=div(n,33)*8 + div((n%33)+3,4); var leapG=div(gy,4)-div((div(gy,100)+1)*3,4)-150;
    var march=20+leapJ-leapG; return {gy:gy, march:march};
  }
  function d2j_alg(gy,gm,gd){
    var jdn = g2d(gy,gm,gd), gy2=gy-621, r=jalCal(gy2), jdn1f=g2d(gy,3,r.march), jd=jdn - jdn1f, jm, jy;
    if (jd >= 0){ if (jd <= 185) { jm = 1 + Math.trunc(jd/31); jd = (jd % 31) + 1; } else { jd -= 186; jm = 7 + Math.trunc(jd/30); jd = (jd % 30) + 1; } jy = gy2; }
    else { jy = gy2 - 1; r = jalCal(jy); jdn1f = g2d(r.gy,3,r.march); jd = jdn - jdn1f; if (jd <= 185) { jm = 1 + Math.trunc(jd/31); jd = (jd % 31) + 1; } else { jd -= 186; jm = 7 + Math.trunc(jd/30); jd = (jd % 30) + 1; } }
    return [jy,jm,jd];
  }

  function getJalali(now){
    // Prefer device Intl Persian calendar if available (most iOS versions support it)
    try{
      if(Intl && Intl.DateTimeFormat){
        const fmt = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year:'numeric', month:'2-digit', day:'2-digit', weekday:'long' });
        const parts = fmt.formatToParts(now);
        const map = {}, digits='۰۱۲۳۴۵۶۷۸۹';
        parts.forEach(p=> map[p.type]=p.value);
        let jy = parseInt(fromFa(map.year),10);
        let jm = parseInt(fromFa(map.month),10);
        let jd = parseInt(fromFa(map.day),10);
        let wd = map.weekday || '';
        return {jy, jm, jd, wd};
      }
    }catch(e){}
    // Fallback: algorithm
    const d = d2j_alg(now.getFullYear(), now.getMonth()+1, now.getDate());
    const wdIndex = (now.getDay()===6?0:now.getDay()+1); // map Sun..Sat -> 1..0 (Sat first)
    return {jy:d[0], jm:d[1], jd:d[2], wd:WDAY_NAMES[wdIndex]};
  }

  function update(){
    const now = new Date(); // exact device time
    const j = getJalali(now);
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');

    // Update all headers (existing or future)
    document.querySelectorAll('.jalali-live-header').forEach(h=>{
      const w = h.querySelector('.wday'); if(w) w.textContent = j.wd;
      const y = h.querySelector('.year'); if(y) y.textContent = toFa(j.jy);
      const mo = h.querySelector('.month'); if(mo) mo.textContent = MONTH_NAMES[j.jm-1] || mo.textContent;
      const d = h.querySelector('.date'); if(d) d.textContent = toFa(j.jd);
      const clk = h.querySelector('.clock, #jalaliClock'); if(clk) clk.textContent = toFa(`${hh}:${mm}:${ss}`);
    });

    // Keep a clear YYYY/MM/DD badge available (append once)
    if(!document.getElementById('dosTodayBadge')){
      const badge = document.createElement('div');
      badge.id = 'dosTodayBadge';
      badge.style.cssText = 'display:flex;gap:.5rem;align-items:center;justify-content:center;margin:.25rem 0 0 0;font-weight:800;';
      badge.innerHTML = '<span id="dosTodayText"></span>';
      const insAt = document.getElementById('jalaliLiveHeader') || host.firstElementChild || host;
      insAt.parentNode.insertBefore(badge, insAt.nextSibling);
    }
    const txt = document.getElementById('dosTodayText');
    if(txt) txt.textContent = toFa(`${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`);

    // Highlight today's cell inside our calendars if present
    try{
      const cells = host.querySelectorAll('.cal-grid .day:not(.empty)');
      if(cells.length){ cells.forEach(c=>c.classList.remove('today')); const idx=j.jd-1; if(cells[idx]) cells[idx].classList.add('today'); }
    }catch(e){}
  }

  update();
  setInterval(update, 1000); // live clock & rollover at midnight

})();
</script>


<!-- DENTALOS • JALALI LIVE DEVICE SYNC • V3 (ADD-ONLY, NO REMOVAL) -->
<style id="dos-jalali-live-v3-css">
  #calHost .dos-live-head{display:flex;gap:.5rem;align-items:center;justify-content:center;
    font-weight:900;font-size:clamp(14px,3.2vw,20px);
    background:linear-gradient(135deg,#9ae6ff,#b6f3c6,#ffd28f,#ff9ac0);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    padding:.25rem .6rem;border-radius:14px;margin:.25rem auto .5rem;filter:drop-shadow(0 6px 16px rgba(0,0,0,.25));
  }
  #calHost .dos-live-head .clock{font-variant-numeric:tabular-nums;font-weight:800;
    padding:.15rem .5rem;border-radius:10px;border:1px solid rgba(255,255,255,.22);
    background:rgba(255,255,255,.10);color:#fff;-webkit-background-clip:initial;background-clip:initial;
    backdrop-filter:blur(8px) saturate(1.4);box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), 0 8px 24px rgba(0,0,0,.25);
  }
  #calHost .bar{display:grid;grid-template-columns:repeat(7,1fr);gap:.35rem;margin:.45rem 0 .55rem 0}
  #calHost .dot{height:26px;border-radius:10px;display:grid;place-items:center;
    background:rgba(255,255,255,.22);color:#1e1300;font-weight:900}
  #calHost .cal-grid-v3{display:grid;grid-template-columns:repeat(7,1fr);gap:.55rem}
  #calHost .cell{height:46px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
    display:flex;align-items:center;justify-content:center;
    background:radial-gradient(120% 150% at 50% -20%, rgba(255,255,255,.18), rgba(120,160,220,.06) 50%, rgba(255,255,255,.04) 100%);
    backdrop-filter:blur(10px) saturate(1.2);-webkit-backdrop-filter:blur(10px) saturate(1.2);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.15), 0 6px 14px rgba(0,0,0,.18);
    color:#e9f3ff;font-weight:800;font-size:1.05rem;position:relative;
    user-select:none;-webkit-user-select:none;touch-action:manipulation;
  }
  #calHost .cell.empty{visibility:hidden}
  #calHost .cell.today{
    background: radial-gradient(140% 120% at 10% 5%, rgba(255,255,255,.9), rgba(180,225,255,.55) 32%, rgba(150,210,255,.35) 50%, rgba(110,160,255,.2) 70%, rgba(90,120,220,.12) 90%);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.65), inset 0 -2px 6px rgba(0,0,0,.18), 0 10px 26px rgba(0,30,90,.28), 0 2px 8px rgba(0,0,0,.18);
    border: 1px solid rgba(255,255,255,.45) !important; outline: 2px solid rgba(0,220,255,.35);
  }
  #calHost .cell.today::after{content:"امروز";position:absolute;bottom:6px;left:50%;transform:translateX(-50%);font-size:.7em;color:#0b3868;opacity:.9;font-weight:700;letter-spacing:.4px;text-shadow:0 1px 0 rgba(255,255,255,.6);}
  #calHost .mini-btn{display:inline-flex;align-items:center;gap:.35rem;padding:.4rem .6rem;border-radius:10px;border:1px solid rgba(255,255,255,.22);
    background:rgba(255,255,255,.10);color:#fff;font-weight:800;cursor:pointer}
</style>
<script id="dos-jalali-live-v3-js">
(function(){
  if(window.__DOS_JLIVE_V3__) return; window.__DOS_JLIVE_V3__=true;
  const host = document.getElementById('calHost'); if(!host) return;

  // === Digits ===
  const FA = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  const toFa = s => String(s).replace(/[0-9]/g, d => FA[d]);
  const toEn = s => String(s).replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));

  // === Names ===
  const MONTH = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  const WDAY  = ['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];

  // === Intl (primary) + fallbacks for Jalali ===
  function jalaliNow(){
    try{
      const fmt = new Intl.DateTimeFormat('fa-IR-u-ca-persian',{year:'numeric',month:'numeric',day:'numeric',weekday:'long',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
      const parts = fmt.formatToParts(new Date());
      const obj={};
      parts.forEach(p=> obj[p.type]=p.value);
      const jy=Number(toEn(obj.year)), jm=Number(toEn(obj.month)), jd=Number(toEn(obj.day));
      const wday=obj.weekday;
      const hms=`${toEn(obj.hour).padStart(2,'0')}:${toEn(obj.minute).padStart(2,'0')}:${toEn(obj.second).padStart(2,'0')}`;
      return {jy,jm,jd,wday,hmsFa:toFa(hms)};
    }catch(e){
      // fallback via conversion
      const n=new Date(); const [jy,jm,jd]=d2j(n.getFullYear(),n.getMonth()+1,n.getDate());
      const map = ['یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه','شنبه']; // JS 0..6 -> Sun..Sat
      const wday = map[n.getDay()];
      const h=n.getHours().toString().padStart(2,'0'), m=n.getMinutes().toString().padStart(2,'0'), s=n.getSeconds().toString().padStart(2,'0');
      return {jy,jm,jd,wday, hmsFa:toFa(`${h}:${m}:${s}`)};
    }
  }

  // --- Jalaali helpers (fallbacks; scoped so we don't touch globals) ---
  function d2j(gy,gm,gd){const gdm=[0,31,59,90,120,151,181,212,243,273,304,334];gy-=1600;gm--;gd--;let g=365*gy+((gy+3)>>2)-((gy+99)>>2)+((gy+399)>>2);g+=gdm[gm]+gd;if(gm>1&&((gy%4==0&&gy%100!=0)||(gy%400==0)))g++;let j=g-79;let np=(j/12053)|0;j%=12053;let jy=979+33*np+4*((j/1461)|0);j%=1461;if(j>=366){jy+=(j-1)/365|0;j=(j-1)%365}let jm=(j<186)?1+(j/31|0):7+((j-186)/30|0);let jd=1+((j<186)?(j%31):((j-186)%30));return[jy,jm,jd]}
  function j2g(jy,jm,jd){jy-=979;let j=365*jy+((jy/33)|0)*8+(((jy%33)+3)/4|0);for(let i=1;i<jm;i++)j+=i<=6?31:i<=11?30:29;j+=jd-1;let g=j+79;let gy=1600+400*((g/146097)|0);g%=146097;if(g>=36525){g--;gy+=100*((g/36524)|0);g%=36524;if(g>=365)g--}gy+=4*((g/1461)|0);g%=1461;if(g>=366){g--;gy+=(g/365)|0;g%=365}function gml(y,m){return[31,((y%4==0&&y%100!=0)||(y%400==0))?29:28,31,30,31,30,31,31,30,31,30,31][m-1]}let gm=1;for(;gm<=12&&g>=gml(gy,gm);gm++){g-=gml(gy,gm)}let gd=g+1;return[gy,gm,gd]}
  function jMonthLen(jy,jm){let njy=jy, njm=jm+1; if(njm===13){ njy++; njm=1; } const a=j2g(jy,jm,1), b=j2g(njy,njm,1); const da=new Date(a[0],a[1]-1,a[2]), db=new Date(b[0],b[1]-1,b[2]); return Math.round((db-da)/86400000);}

  // === Events storage (shared key) ===
  const KEY='DENTALOS_EVENTS_V1';
  const loadEvents=()=>{try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){return []}};
  const saveEvents=a=>{localStorage.setItem(KEY,JSON.stringify(a)); window.dispatchEvent(new CustomEvent('dentalos:events-updated',{detail:a}))};
  const addEvent=e=>{const arr=loadEvents(); arr.push(e); saveEvents(arr)};

  // === Render month grid in program's host ===
  function renderMonth(jy,jm){
    const gFirst=j2g(jy,jm,1);
    const wk=new Date(gFirst[0],gFirst[1]-1,gFirst[2]).getDay(); // 0 Sun..6 Sat
    const start=(wk+1)%7; // start column Saturday
    const days=jMonthLen(jy,jm);
    const nowJ = jalaliNow();
    const head = document.createElement('div'); head.className='dos-live-head';
    head.innerHTML = `<div class="dos-live-head">
        <span class="wday" id="dos-wday">${nowJ.wday}</span>
        <span class="date" id="dos-date">${toFa(nowJ.jd)}</span>
        <span class="month" id="dos-month">${MONTH[jm-1]}</span>
        <span class="year" id="dos-year">${toFa(jy)}</span>
        <span class="clock" id="dos-clock">${nowJ.hmsFa}</span>
      </div>`;
    const bar = document.createElement('div'); bar.className='bar';
    'ش ی د س چ پ ج'.split(' ').forEach(ch=>{ const n=document.createElement('div'); n.className='dot'; n.textContent=ch; bar.appendChild(n); });
    const grid=document.createElement('div'); grid.className='cal-grid-v3';

    for(let i=0;i<start;i++){ const c=document.createElement('div'); c.className='cell empty'; grid.appendChild(c); }
    for(let d=1; d<=days; d++){
      const c=document.createElement('div'); c.className='cell'; c.textContent=toFa(d);
      if(d===nowJ.jd && jm===nowJ.jm && jy===nowJ.jy) c.classList.add('today');
      c.dataset.jdate = `${jy}-${String(jm).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      // interactions
      let timer=null, pressed=false, longHit=false;
      c.addEventListener('pointerdown', (ev)=>{ pressed=true; longHit=false; timer=setTimeout(()=>{ if(!pressed) return; longHit=true; openDaySheet(c.dataset.jdate); },650); });
      c.addEventListener('pointerup', ()=>{ clearTimeout(timer); if(!longHit){ openAllEventsSheet(); } pressed=false; });
      c.addEventListener('pointerleave', ()=>{ pressed=false; clearTimeout(timer); });
      grid.appendChild(c);
    }
    host.innerHTML=''; host.appendChild(head); host.appendChild(bar); host.appendChild(grid);
  }

  // === Sheets (use app's sheet system; no custom modals) ===
  function openAllEventsSheet(){
    const list=loadEvents().sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    const wrap=document.createElement('div');
    if(!list.length){ wrap.innerHTML='<div class="mini">رویدادی ثبت نشده.</div>'; }
    else {
      const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
      list.forEach(e=>{
        const li=document.createElement('li'); li.style.cssText='display:flex;justify-content:space-between;gap:.5rem;align-items:center;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:.5rem .65rem;margin:.35rem 0;background:rgba(255,255,255,.08)';
        li.innerHTML=`<div><strong>${e.title||'بدون عنوان'}</strong>
          <div class="mini" style="opacity:.8">${e.date}${e.time?' · '+e.time:''}${e.section?' · '+e.section:''}</div></div>`;
        const btn=document.createElement('button'); btn.className='mini-btn'; btn.textContent='حذف'; btn.onclick=()=>{ const arr=loadEvents().filter(x=>x.id!==e.id); saveEvents(arr); openAllEventsSheet(); };
        const go=document.createElement('button'); go.className='mini-btn'; go.textContent='رفتن به بخش'; go.onclick=()=>gotoSection(e.section);
        const box=document.createElement('div'); box.style.display='flex'; box.style.gap='.35rem'; box.appendChild(go); box.appendChild(btn);
        li.appendChild(box); ul.appendChild(li);
      });
      wrap.appendChild(ul);
    }
    openSheet('فهرست همهٔ رویدادها', wrap);
    setHandlers(null, null, null);
  }

  function openDaySheet(jdate){
    const wrap=document.createElement('div');
    const listBox=document.createElement('div'); wrap.appendChild(listBox);
    const form=document.createElement('div'); form.innerHTML=`
      <div style="display:flex;gap:.5rem;margin-top:.6rem">
        <input name="title" placeholder="عنوان *" class="sel" style="flex:2">
        <input name="time" type="time" class="sel" style="flex:1">
      </div>
      <div style="display:flex;gap:.5rem;margin-top:.4rem">
        <input name="section" placeholder="بخش (اختیاری: module/sub یا شناسه)" class="sel" style="flex:1">
        <input name="desc" placeholder="توضیح" class="sel" style="flex:2">
      </div>
      <div style="display:flex;gap:.5rem;margin-top:.6rem">
        <button id="saveEvt" class="mini-btn">ذخیره</button>
      </div>`;
    wrap.appendChild(form);

    function renderList(){
      const arr=loadEvents().filter(e=>e.date===jdate);
      if(!arr.length){ listBox.innerHTML='<div class="mini" style="opacity:.8">برای این روز رویدادی ثبت نشده.</div>'; return; }
      const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='.25rem 0 0 0';
      arr.forEach(e=>{
        const li=document.createElement('li'); li.style.cssText='display:flex;justify-content:space-between;gap:.5rem;align-items:center;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:.5rem .65rem;margin:.35rem 0;background:rgba(255,255,255,.08)';
        li.innerHTML=`<div><strong>${e.title}</strong><div class="mini" style="opacity:.8">${e.time||''} ${e.section?('· '+e.section):''}</div></div>`;
        const del=document.createElement('button'); del.className='mini-btn'; del.textContent='حذف'; del.onclick=()=>{ const all=loadEvents().filter(x=>x.id!==e.id); saveEvents(all); renderList(); };
        const go=document.createElement('button'); go.className='mini-btn'; go.textContent='رفتن به بخش'; go.onclick=()=>gotoSection(e.section);
        const box=document.createElement('div'); box.style.display='flex'; box.style.gap='.35rem'; box.appendChild(go); box.appendChild(del);
        li.appendChild(box); ul.appendChild(li);
      });
      listBox.innerHTML=''; listBox.appendChild(ul);
    }
    renderList();

    openSheet('رویدادهای ' + jdate, wrap);
    setHandlers(()=>{
      const t=wrap.querySelector('[name="title"]').value.trim();
      if(!t){ toast('عنوان الزامی است'); return; }
      const time=wrap.querySelector('[name="time"]').value.trim();
      const section=wrap.querySelector('[name="section"]').value.trim();
      const desc=wrap.querySelector('[name="desc"]').value.trim();
      const evt={id:'evt_'+Math.random().toString(36).slice(2), title:t, date:jdate, time, section, desc, createdAt:new Date().toISOString()};
      addEvent(evt); renderList();
      if(section) gotoSection(section);
      window.dispatchEvent(new CustomEvent('dentalos:event-created',{detail:evt}));
      toast('ثبت شد ✅');
    }, null, null);
  }

  function gotoSection(tag){
    if(!tag) return;
    // Formats supported: "module/sub", "module:sub", "module" only, or an element id.
    let mod=null, sub=null;
    if(tag.includes('/') || tag.includes(':')){
      const sp=tag.includes('/')?tag.split('/') : tag.split(':');
      mod=sp[0]; sub=sp[1]||null;
    } else {
      mod=tag;
    }
    try{
      if(typeof openRoute==='function' && mod){
        if(!sub){ sub = (mod==='events'?'today':'list'); }
        openRoute(mod, sub);
        return;
      }
    }catch(e){}
    // try click any element representing this section
    const el=document.getElementById(tag) || document.querySelector(`[data-section="{tag}"],[data-name="{tag}"],[data-route="{tag}"]`);
    if(el && el.click) el.click();
    window.dispatchEvent(new CustomEvent('dentalos:navigate',{detail:{section:tag}}));
  }

  // === Live header clock synced to device ===
  function startClock(jy,jm){
    const clock=document.getElementById('dos-clock');
    const wdayEl=document.getElementById('dos-wday');
    const dateEl=document.getElementById('dos-date');
    const monthEl=document.getElementById('dos-month');
    const yearEl=document.getElementById('dos-year');
    function tick(){
      const now = jalaliNow();
      if(clock) clock.textContent = now.hmsFa;
      if(wdayEl) wdayEl.textContent = now.wday;
      if(dateEl)  dateEl.textContent = toFa(now.jd);
      if(monthEl) monthEl.textContent = MONTH[now.jm-1];
      if(yearEl)  yearEl.textContent = toFa(now.jy);
    }
    tick(); setInterval(tick, 1000);
  }

  // === Init (build using DEVICE date) ===
  const now = jalaliNow();
  renderMonth(now.jy, now.jm);
  startClock(now.jy, now.jm);

  console.info('[DentalOS] Jalali Live V3 active (device-synced).');
})();
</script>
<!-- /DENTALOS • JALALI LIVE DEVICE SYNC • V3 -->


<!-- ★ Auto-update & Backup injected -->
<script>
(function(){ 
  const APP_VERSION = '2025.01.0';
  try{ localStorage.setItem('appVersionInstalled', APP_VERSION); }catch(e){}

  async function checkForUpdate(){ 
    try{ 
      const r = await fetch('latest.json?ts=' + Date.now(), {cache:'no-store'});
      if(!r.ok) return;
      const data = await r.json();
      const latest = data.version || data.tag || data.latest || null;
      if(latest && latest !== APP_VERSION){ 
        if(confirm('نسخه‌ی جدید ' + latest + ' آماده است. آپدیت شود؟')){ 
          location.reload(true);
        }
      }
    }catch(err){ /* silent */ }
  }

  setTimeout(checkForUpdate, 2000);
  document.addEventListener('visibilitychange', () => { if(!document.hidden) checkForUpdate(); });

  // -------- Local backup / restore (menu-friendly) --------
  function exportJSON(filename, data){ 
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
    a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 4000);
  }

  function collectAppState(){ 
    // Customize keys list if you have a namespace for your app
    const store = {}
    try{ for (let i=0;i<localStorage.length;i++){ 
      const k = localStorage.key(i);
      // include only app-related keys if needed:
      // if(!k.startsWith('dentalos:')) continue;
      store[k] = localStorage.getItem(k);
    } }catch(e){}
    return { when: new Date().toISOString(), version: APP_VERSION, localStorage: store };
  }

  async function backupNow(){ 
    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    exportJSON('DentalOS-backup-' + stamp + '.json', collectAppState());
    alert('بک‌آپ محلی دانلود شد.');
  }

  function restoreFromFile(file){ 
    const reader = new FileReader();
    reader.onload = () => { 
      try{ 
        const data = JSON.parse(reader.result);
        if(data && data.localStorage){ 
          for(const [k,v] of Object.entries(data.localStorage)){ 
            try{ localStorage.setItem(k, v); }catch(e){}
          }
          alert('بازیابی انجام شد. لطفا برنامه را رفرش کنید.');
        }
      }catch(e){ alert('فایل بک‌آپ نامعتبر است'); }
    };
    reader.readAsText(file);
  }

  function hookMenu(id, fn){ 
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', fn);
  }

  // Hook to optional menu items (if they exist in your HTML)
  hookMenu('menu-backup', backupNow);
  hookMenu('menu-restore', () => { 
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = '.json,application/json';
    inp.onchange = (e)=> restoreFromFile(e.target.files[0]);
    inp.click();
  });

  // Expose globally so you can call from anywhere
  window.DentalOS = Object.assign(window.DentalOS || {}, {
    backupNow, restoreFromFile, checkForUpdate, version: APP_VERSION
  });
})();
</script>
<!-- /Auto-update & Backup -->
</body>
</html>
