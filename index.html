<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>DentalOS â€¢ V4 â€¢ PRO â€¢ Super AI + AutoTest â€¢ iOS26 LiquidNav</title>
<meta name="theme-color" content="#0b1020">
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./icons/tooth-144.png" type="image/png">
<style>
/* â€”â€”â€” ØªÙ…Ø§Ù… Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ UI Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ù‡Ø¯Ø±ØŒ Ø¬Ø³ØªØ¬ÙˆØŒ Ú©Ø§Ø´ÛŒâ€ŒÙ‡Ø§ØŒ Ø´ÛŒØªâ€ŒÙ‡Ø§ØŒ Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ†ØŒ Ø§ÙˆØ±Ø¨ AIØŒ ØªÙ…â€ŒÙ‡Ø§) â€”â€”â€” */
:root{
  --bg:#0b1020;
  --stroke:rgba(255,255,255,.22);
  --glass:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  --blur:18px;
  --text:#eaf3ff;
  --muted:#b6c2d1;
  --accent:#00e5ff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-rounded,"Vazirmatn","IRANSans",system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--text);
  background:
   radial-gradient(60rem 60rem at 10% -10%, rgba(61,110,255,.25), transparent 60%),
   radial-gradient(50rem 50rem at 110% 10%, rgba(0,230,230,.18), transparent 60%),
   linear-gradient(180deg,#0a0f1f 0%,#0b1020 40%,#0e1226 100%);
  overflow:hidden;
  user-select:none;
}
/* Header */
.header{position:fixed;inset:0 0 auto 0;height:64px;display:flex;align-items:center;gap:10px;
  padding:0 clamp(10px,3vw,18px);z-index:90;
  backdrop-filter:blur(var(--blur)) saturate(140%);-webkit-backdrop-filter:blur(var(--blur)) saturate(140%);
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border-bottom:1px solid var(--stroke)}
.hamb{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;cursor:pointer;
  background:rgba(255,255,255,.12);border:1px solid var(--stroke)}
.hamb span,.hamb::before,.hamb::after{content:"";width:18px;height:2px;background:#fff;border-radius:2px;display:block;transition:.25s}
.hamb::before{transform:translateY(-5px)}.hamb::after{transform:translateY(5px)}
.hamb.active{background:rgba(255,255,255,.2)}.hamb.active span{opacity:0}
.hamb.active::before{transform:translateY(0) rotate(45deg)}.hamb.active::after{transform:translateY(0) rotate(-45deg)}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.logo{width:38px;height:38px;border-radius:12px;position:relative;overflow:hidden;
  background:radial-gradient(120% 120% at 20% 20%,#6dd5fa 0%,#2980b9 35%,#172a45 100%);
  box-shadow:inset 0 0 12px rgba(255,255,255,.25),0 10px 30px rgba(0,0,0,.35)}
.title{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
/* Smart search */
.searchDock{position:fixed;inset:64px 12px auto 12px;z-index:80;display:flex;gap:10px;align-items:center}
.searchBar{flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:16px;border:1px solid var(--stroke);background:var(--glass);
  backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:0 10px 30px rgba(0,0,0,.28)}
.searchBar input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:14px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
.mic{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;border:1px solid var(--stroke);cursor:pointer;
  background:linear-gradient(135deg,#7ad8ff,#7ef2e0);color:#001018;box-shadow:0 12px 28px rgba(0,0,0,.35)}
.mic.rec{animation:pulse 1.2s infinite}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,229,255,.45)}70%{box-shadow:0 0 0 14px rgba(0,229,255,0)}100%{box-shadow:0 0 0 0 rgba(0,229,255,0)}}
/* Main content */
.main{position:fixed;inset:118px 0 calc(128px + env(safe-area-inset-bottom)) 0;padding:14px;overflow:auto}
/* Calendar + tiles */
.card{border-radius:20px;padding:12px;background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:0 10px 30px rgba(0,0,0,.35)}
.calhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.calgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;text-align:center}
.caldow{opacity:.75;font-size:12px}
.calday{padding:12px 0;border:1px solid var(--stroke);border-radius:12px;background:rgba(255,255,255,.06);position:relative}
.calday.today{outline:2px solid var(--accent)}
.calday .plus{position:absolute;inset:auto 8px 6px auto;font-weight:900;opacity:.65}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:12px}
.tile{position:relative;min-height:120px;border-radius:20px;padding:14px;cursor:pointer;
  background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));
  box-shadow:0 10px 30px rgba(0,0,0,.35);transition:transform .2s ease;overflow:hidden}
.tile:hover{transform:translateY(-2px)}
.tile .icon{font-size:28px}.tile .t{margin-top:8px;font-weight:800;font-size:18px}.tile .d{opacity:.75;font-size:12px}
.tile .optbtn{position:absolute;inset:10px auto auto 10px;padding:6px 8px;border-radius:10px;border:1px solid var(--stroke);background:rgba(0,0,0,.25);color:#fff}
/* Bottom nav iOS26 Liquid Glass */
.bnav{position:fixed;inset:auto 12px calc(12px + env(safe-area-inset-bottom)) 12px;height:88px;
  display:grid;grid-template-columns:repeat(6,1fr);gap:10px;align-items:center;justify-items:center;
  border-radius:26px;padding:8px 10px;
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.18));
  border:1px solid rgba(255,255,255,.22);
  backdrop-filter:blur(28px) saturate(170%);-webkit-backdrop-filter:blur(28px) saturate(170%);
  box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.25); z-index:85}
.bnav .item{position:relative;width:100%;height:64px;border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:var(--muted);cursor:pointer;transition:.18s}
.bnav .ico{font-size:34px;line-height:1;filter:drop-shadow(0 14px 18px rgba(0,0,0,.45));transition:transform .12s}
.bnav .label{font-size:12px;margin-top:4px}
.bnav .item:active .ico{transform:translateY(2px) scale(.98)}
.bnav .item.active{color:#fff;background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.10));
  box-shadow:inset 0 6px 16px rgba(0,0,0,.35), inset 0 -1px 0 rgba(255,255,255,.25); transform:translateY(1px)}
.bnav .item.active .ico{transform:translateY(1px) scale(.96)}
/* droplet */
.droplet{position:absolute;left:0;top:0;width:72px;height:72px;border-radius:24px;pointer-events:none;opacity:0;
  background:radial-gradient(30% 30% at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.10));
  filter:blur(0);transition:opacity .15s, transform .06s}
.droplet.show{opacity:1}
/* Overlays */
.backdrop{position:fixed;inset:64px 0 calc(128px + env(safe-area-inset-bottom)) 0;background:rgba(10,12,18,.55);z-index:88;opacity:0;pointer-events:none;transition:.25s}
.backdrop.show{opacity:1;pointer-events:auto}
.sidemenu{position:fixed;inset:64px 0 calc(128px + env(safe-area-inset-bottom)) auto;width:min(380px,92vw);
  transform:translateX(100%);transition:.25s;z-index:89;padding:16px;overflow:auto;
  background:linear-gradient(180deg,rgba(17,24,39,.97),rgba(17,24,39,.94));color:#eaf3ff;border-left:1px solid rgba(255,255,255,.12);
  box-shadow:-18px 0 40px rgba(0,0,0,.45)}
.sidemenu.open{transform:none}
.group{margin:10px 0 16px}.group h3{font-size:13px;opacity:.95;margin:0 0 8px}
.sel{padding:9px 11px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff}
.row{display:flex;flex-wrap:wrap;gap:8px}
.help{font-size:12px;opacity:.85;padding:8px 10px;border:1px dashed rgba(255,255,255,.25);border-radius:12px;background:rgba(255,255,255,.06)}
/* Sheet */
.sheet{position:fixed;inset:64px 0 calc(128px + env(safe-area-inset-bottom)) 0;display:none;z-index:86}
.sheet.open{display:block}
.scard{position:absolute;inset:14px;border-radius:22px;overflow:hidden;background:var(--glass);border:1px solid var(--stroke);
  backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:0 10px 30px rgba(0,0,0,.35);display:flex;flex-direction:column}
.shead{padding:12px 14px 8px 14px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
.shead .stitle{font-weight:900;font-size:16px}
.sbody{flex:1;overflow:auto;padding:12px 14px 84px 14px}
.sfooter{position:absolute;inset:auto 12px 12px 12px;display:flex;justify-content:space-between;gap:12px}
.action{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border-radius:14px;border:1px solid var(--stroke);
  background:rgba(255,255,255,.08);color:#fff;font-weight:700;cursor:pointer}
.action.red{border-color:#e94560;background:rgba(233,69,96,.15)}.action.green{border-color:#16c784;background:rgba(22,199,132,.15)}.action.yellow{border-color:#f5c518;background:rgba(245,197,24,.15);color:#f7e08a}
/* AI orb */
#aiOrb{position:fixed;right:18px;bottom:calc(160px + env(safe-area-inset-bottom));width:72px;height:72px;border-radius:22px;display:grid;place-items:center;cursor:grab;
  background:conic-gradient(from 200deg,#7ad8ff,#8ef5a9,#bca7ff,#7ad8ff);box-shadow:0 18px 40px rgba(0,0,0,.45),inset 0 0 18px rgba(255,255,255,.45);z-index:87}
#aiOrb svg{width:30px;height:30px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.4))}#aiOrb:active{cursor:grabbing}
.mini{font-size:12px;opacity:.8}
.hidden{display:none}
fieldset{border:1px dashed rgba(255,255,255,.2);border-radius:12px;padding:12px;margin:0 0 10px}
legend{padding:0 6px;opacity:.8;font-size:12px}
label{display:block;font-size:12px;opacity:.85;margin:6px 0 4px}
input,select,textarea{width:100%;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;padding:10px 12px}
/* Ù„ÙˆÚ¯ÙˆÛŒ Ú†Ø±Ø®Ø§Ù† + Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø¯ */
.brand .logo{width:48px;height:48px;background:transparent!important;box-shadow:none!important;border-radius:50%;overflow:visible;position:relative}
.brand .logo svg{width:48px;height:48px;display:block;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
@keyframes spinY{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}
.brand .logo .tooth3d{transform-origin:center;animation:spinY 10s linear infinite}
#brandTitle{display:flex; gap:.5rem; align-items:center; font-weight:900; font-size: clamp(18px,3.8vw,28px);}
#brandTitle .w{--c:#fff;color:var(--c);display:inline-block;padding:.15rem .45rem;border-radius:12px;
  text-shadow:0 2px 10px color-mix(in oklab, var(--c) 55%, transparent);
  animation:bob 2.8s ease-in-out infinite alternate, glow 3.6s ease-in-out infinite alternate; }
#brandTitle .w:nth-child(1){ --c:#00e5ff;} #brandTitle .w:nth-child(2){ --c:#ff5da2;}
#brandTitle .w:nth-child(3){ --c:#ffd166;} #brandTitle .w:nth-child(4){ --c:#a78bfa;}
@keyframes bob{0%{transform:translateY(0) rotate(0)}100%{transform:translateY(-4px) rotate(-1deg)}}
@keyframes glow{0%{text-shadow:0 2px 10px color-mix(in oklab,var(--c) 45%,transparent)}
100%{text-shadow:0 0 18px color-mix(in oklab,var(--c) 90%,transparent)}}
</style>
</head>
<body>
  <div class="header">
    <div class="hamb" id="hamb"><span></span></div>
    <div class="brand">
      <div class="logo"></div>
      <div class="title" id="brandTitle">
        <span class="w">Ø¯Ù†Ø¯Ø§Ù†Ù¾Ø²Ø´Ú©ÛŒ</span><span class="w">Ø¯Ú©ØªØ±</span><span class="w">Ù…ÛŒÙ†Ø§</span><span class="w">Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†ÛŒ</span>
      </div>
    </div>
  </div>

  <!-- Smart search -->
  <div class="searchDock">
    <div class="searchBar">
      <input id="q" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯: Ø¨ÛŒÙ…Ø§Ø±/Ù‚Ø³Ø·/Ú†Ú©/Ø±ÙˆÛŒØ¯Ø§Ø¯/Ø§Ù†Ø¨Ø§Ø±..." />
      <button class="btn" id="searchBtn">Ø¬Ø³ØªØ¬Ùˆ</button>
    </div>
    <div class="mic" id="micBtn" title="Ú¯ÙØªØ§Ø± Ø¨Ù‡ Ù†ÙˆØ´ØªØ§Ø±">ğŸ™ï¸</div>
  </div>

  <div class="main">
    <div class="card" id="calHost"></div>
    <div class="grid" id="tiles"></div>
  </div>

  <!-- Bottom Nav -->
  <div class="bnav" id="bnav">
    <div class="droplet" id="drop"></div>
  </div>

  <div class="backdrop" id="backdrop"></div>
  <aside class="sidemenu" id="sidemenu">
    <div class="group">
      <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</h3>
      <div class="row">
        <button class="btn" data-act="askNoti">ğŸ”” ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø¹Ù„Ø§Ù†</button>
        <button class="btn" data-act="askMic">ğŸ¤ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ú¯ÙØªØ§Ø±</button>
        <button class="btn" data-act="installPWA">ğŸ“² Ù†ØµØ¨ PWA</button>
        <button class="btn" data-act="updateApp">ğŸ”„ Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù¾Ø¯ÛŒØª</button>
      </div>
    </div>
    <div class="group">
      <h3>Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±</h3>
      <select class="sel" id="roleSel">
        <option value="owner">Ù…Ø¯ÛŒØ±/Ù¾Ø²Ø´Ú©</option>
        <option value="reception">Ù¾Ø°ÛŒØ±Ø´</option>
        <option value="assistant">Ù…Ù†Ø´ÛŒ/Ø¯Ø³ØªÛŒØ§Ø±</option>
        <option value="cashier">ØµÙ†Ø¯ÙˆÙ‚</option>
      </select>
      <div class="help">Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø·Ø¨Ù‚ Ù†Ù‚Ø´ Ù…Ø­Ø¯ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    </div>
    <div class="group">
      <h3>ØªÙ…</h3>
      <select class="sel" id="themeSel">
        <option value="glass">Ú¯Ù„Ø³</option>
        <option value="aqua">Ø¢Ú©ÙˆØ§</option>
        <option value="sunset">Ø³Ø§Ù†Ø³Øª</option>
        <option value="dark">ØªÛŒØ±Ù‡</option>
      </select>
    </div>
    <div class="group">
      <h3>ğŸ§ª ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù…Ù‡â€ŒØ¨Ø®Ø´â€ŒÙ‡Ø§</h3>
      <div class="row">
        <button class="btn" id="runTests">Ø§Ø¬Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ ÙˆØ§Ù‚Ø¹ÛŒ</button>
        <button class="btn" id="runDeep">ØªØ³Øª Ø¹Ù…ÛŒÙ‚ Ù‡Ù…Ù‡ ÙØ±Ù…â€ŒÙ‡Ø§</button>
        <button class="btn" id="copyReport">Ú©Ù¾ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
      </div>
      <textarea id="report" class="sel" style="width:100%;height:180px;margin-top:8px" readonly>â€” Ù‡Ù†ÙˆØ² Ú¯Ø²Ø§Ø±Ø´ÛŒ Ù†ÛŒØ³Øª â€”</textarea>
    </div>
  </aside>

  <!-- Sheet -->
  <div class="sheet" id="sheet">
    <div class="scard">
      <div class="shead">
        <div class="stitle" id="sTitle">...</div>
        <button class="action red" id="sClose">âœ– Ø¨Ø³ØªÙ†</button>
      </div>
      <div class="sbody" id="sBody"></div>
      <div class="sfooter">
        <button class="action yellow" id="sBack">â†© Ø¨Ø±Ú¯Ø´Øª</button>
        <button class="action green" id="sSubmit">âœ” Ø«Ø¨Øª</button>
      </div>
    </div>
  </div>

  <!-- AI orb -->
  <div id="aiOrb" title="Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯">
    <svg viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.6">
      <circle cx="12" cy="12" r="5" fill="white" opacity=".85"/>
      <path d="M4 12a8 8 0 1 0 16 0" stroke-linecap="round"/>
    </svg>
  </div>

<script>
/* â€”â€” Ø§Ø¨Ø²Ø§Ø±Ú©â€ŒÙ‡Ø§ Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø² â€”â€” */
const EL = (s)=>document.querySelector(s);
function toast(msg){ const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText="position:fixed;left:50%;transform:translateX(-50%);bottom:calc(150px + env(safe-area-inset-bottom));background:rgba(0,0,0,.6);color:#fff;padding:10px 14px;border-radius:12px;backdrop-filter:blur(8px);z-index:9999;";
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }
const DB={ get:(k,def=null)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def))}catch(e){return def}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };

/* â€”â€” Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ø´ÛŒâ€ŒÙ‡Ø§ â€”â€” */
const ALL_TILES=[
  {k:'events',t:'Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§',d:'Ø§Ù…Ø±ÙˆØ²/Ù‡ÙØªÙ‡/Ù…Ø§Ù‡',ico:'ğŸ—“ï¸',perm:['owner','reception','assistant','cashier'],
    subs:[['today','Ø§Ù…Ø±ÙˆØ²'],['week','Ø§ÛŒÙ† Ù‡ÙØªÙ‡'],['month','Ù…Ø§Ù‡'],['calendar','ØªÙ‚ÙˆÛŒÙ…'],['quick','Ù†ÙˆØ¨Øª ÙÙˆØ±ÛŒ']]},
  {k:'patients',t:'Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†',d:'Ù„ÛŒØ³Øª/Ø§ÙØ²ÙˆØ¯Ù†/Ù¾Ø±ÙˆÙ†Ø¯Ù‡',ico:'ğŸ§‘â€âš•ï¸',perm:['owner','reception','assistant'],
    subs:[['list','Ù„ÛŒØ³Øª'],['add','Ø§ÙØ²ÙˆØ¯Ù†'],['profile','Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø¨ÛŒÙ…Ø§Ø±']]},
  {k:'finance',t:'Ù…Ø§Ù„ÛŒ',d:'Ø¯ÙØªØ± Ú©Ù„/Ø¨Ø¯Ù‡Ú©Ø§Ø±/Ø·Ù„Ø¨Ú©Ø§Ø±/Ú†Ú©/Ø§Ù‚Ø³Ø§Ø·',ico:'ğŸ’³',perm:['owner','cashier'],
    subs:[['ledger','Ø¯ÙØªØ± Ú©Ù„'],['debt','Ø¨Ø¯Ù‡Ú©Ø§Ø±'],['credit','Ø·Ù„Ø¨Ú©Ø§Ø±'],['check','Ú†Ú©'],['installment','Ø§Ù‚Ø³Ø§Ø·'],['daily','Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡'],['cashbox','ØµÙ†Ø¯ÙˆÙ‚']]},
  {k:'implant',t:'Ø§ÛŒÙ…Ù¾Ù„Ù†Øª',d:'Ø«Ø¨Øª/Ù¾ÛŒÚ¯ÛŒØ±ÛŒ',ico:'ğŸ¦·',perm:['owner','assistant'],
    subs:[['new','Ø«Ø¨Øª Ø¬Ø±Ø§Ø­ÛŒ'],['due','Ù¾ÛŒÚ¯ÛŒØ±ÛŒ'],['list','Ù„ÛŒØ³Øª'],['sterile','Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø§Ø³ØªØ±ÛŒÙ„']]},
  {k:'inventory',t:'Ø§Ù†Ø¨Ø§Ø±',d:'Ù…ÙˆØ¬ÙˆØ¯ÛŒ/ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬',ico:'ğŸ“¦',perm:['owner','assistant'],
    subs:[['stock','Ù…ÙˆØ¬ÙˆØ¯ÛŒ'],['in','ÙˆØ±ÙˆØ¯'],['out','Ø®Ø±ÙˆØ¬'],['low','Ú©Ø³Ø±ÛŒ']]},
  {k:'lab',t:'Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø±',d:'Ø§Ø±Ø³Ø§Ù„/Ø¯Ø±ÛŒØ§ÙØª/Ù¾ÛŒÚ¯ÛŒØ±ÛŒ',ico:'ğŸ·ï¸',perm:['owner','assistant'],
    subs:[['send','Ø§Ø±Ø³Ø§Ù„'],['receive','Ø¯Ø±ÛŒØ§ÙØª'],['track','Ù¾ÛŒÚ¯ÛŒØ±ÛŒ'],['list','Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù‡Ø§'],['bill','ÙØ§Ú©ØªÙˆØ±']]},
];
const roleSel=EL('#roleSel'); roleSel.value=localStorage.getItem('DOS.role')||'owner';
roleSel.onchange=()=>{ localStorage.setItem('DOS.role', roleSel.value); buildTiles(); rebuildBottomNav(); };

const tilesWrap=EL('#tiles'); const bnav=EL('#bnav'); const droplet=EL('#drop');
function buildTiles(){ tilesWrap.innerHTML=''; ALL_TILES.filter(t=>t.perm.includes(roleSel.value)).forEach(o=>{
  const d=document.createElement('div'); d.className='tile'; d.dataset.k=o.k;
  d.innerHTML=`<div class="icon">${o.ico}</div><div class="t">${o.t}</div><div class="d">${o.d}</div><button class="optbtn" type="button">â‹®</button>`;
  d.addEventListener('click',()=>openEntry(o.k));
  d.querySelector('.optbtn').addEventListener('click',(ev)=>{ ev.stopPropagation(); openTileOptions(o.k); });
  tilesWrap.appendChild(d);
}); }
function rebuildBottomNav(){
  bnav.querySelectorAll('.item').forEach(n=>n.remove());
  ALL_TILES.filter(t=>t.perm.includes(roleSel.value)).forEach(o=>{
    const it=document.createElement('div'); it.className='item'; it.dataset.k=o.k;
    it.innerHTML=`<div class="ico">${o.ico}</div><div class="label">${o.t}</div>`;
    it.onclick=()=>{ setActiveNav(o.k); openEntry(o.k); };
    bnav.appendChild(it);
  });
  bnav.prepend(droplet);
}
function setActiveNav(k){
  bnav.querySelectorAll('.item').forEach(i=>i.classList.toggle('active', i.dataset.k===k));
  DB.set('DOS.active', k);
}
buildTiles(); rebuildBottomNav(); setActiveNav(DB.get('DOS.active','events'));

/* â€”â€” Ø´ÛŒØªâ€ŒÙ‡Ø§ Ùˆ ÙØ±Ù…â€ŒÙ‡Ø§ â€”â€” */
const sheet=EL('#sheet'), sBody=EL('#sBody'), sTitle=EL('#sTitle');
const sClose=EL('#sClose'), sBack=EL('#sBack'), sSubmit=EL('#sSubmit');
function openSheet(title, content){ sTitle.textContent=title||' '; sBody.innerHTML=''; if(typeof content==='string') sBody.innerHTML=content; else sBody.appendChild(content); sheet.classList.add('open'); }
function closeSheet(){ sheet.classList.remove('open'); }
function setHandlers(onSubmit,onBack,onClose){ sSubmit.onclick=onSubmit||(()=>{}); sBack.onclick=onBack||closeSheet; sClose.onclick=onClose||closeSheet; }

function F(legend, fields){ const fs=document.createElement('fieldset'); const lg=document.createElement('legend'); lg.textContent=legend; fs.appendChild(lg);
  fields.forEach(f=>{ const lab=document.createElement('label'); lab.textContent=f.l; if(f.tag==='select'){ const sel=document.createElement('select'); sel.name=f.n; (f.list||[]).forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); }); fs.append(lab, sel); }
  else { const el=(f.tag==='textarea')?document.createElement('textarea'):document.createElement('input'); el.name=f.n; if(f.type) el.type=f.type; fs.append(lab, el); } }); return fs; }

function buildForm(modKey, subKey){
  const el=document.createElement('div');
  if(modKey==='events'){
    if(subKey==='today'){ el.appendChild(F('Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²',[{l:'ÙÛŒÙ„ØªØ± Ù†ÙˆØ¹',n:'type',tag:'select',list:['Ù‡Ù…Ù‡','ÙˆÛŒØ²ÛŒØª','Ø¬Ø±Ù…â€ŒÚ¯ÛŒØ±ÛŒ','Ù¾Ø±Ú©Ø±Ø¯Ú¯ÛŒ','Ø§ÛŒÙ…Ù¾Ù„Ù†Øª']} ])); }
    if(subKey==='quick'){ el.appendChild(F('Ù†ÙˆØ¨Øª ÙÙˆØ±ÛŒ',[{l:'Ø¨ÛŒÙ…Ø§Ø±',n:'pt'},{l:'Ø®Ø¯Ù…Øª',n:'srv',tag:'select',list:['ÙˆÛŒØ²ÛŒØª','Ø¬Ø±Ù…â€ŒÚ¯ÛŒØ±ÛŒ','Ù¾Ø±Ú©Ø±Ø¯Ú¯ÛŒ','Ø§ÛŒÙ…Ù¾Ù„Ù†Øª']},{l:'Ø³Ø§Ø¹Øª',n:'t',type:'time'}])); }
    if(subKey==='calendar'){ const host=document.createElement('div'); buildCalendar(host,new Date()); el.appendChild(host); }
  }
  if(modKey==='patients'){
    if(subKey==='add'){ el.appendChild(F('Ø§ÙØ²ÙˆØ¯Ù† Ø¨ÛŒÙ…Ø§Ø±',[{l:'Ù†Ø§Ù…',n:'name'},{l:'Ù…ÙˆØ¨Ø§ÛŒÙ„',n:'tel'},{l:'Ú©Ø¯Ù…Ù„ÛŒ',n:'nid'},{l:'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',n:'note',tag:'textarea'}])); }
    if(subKey==='list'){ const arr=DB.get('DOS.PATIENTS',[]); const tbl=document.createElement('div'); tbl.innerHTML= arr.length?('<table style="width:100%"><tr><th>Ù†Ø§Ù…</th><th>Ù…ÙˆØ¨Ø§ÛŒÙ„</th><th>Ú©Ø¯Ù…Ù„ÛŒ</th></tr>'+arr.map(p=>`<tr><td>${p.name}</td><td>${p.tel||''}</td><td>${p.nid||''}</td></tr>`).join('')+'</table>'):'<div class="mini">Ù…ÙˆØ±Ø¯ÛŒ Ù†ÛŒØ³Øª.</div>'; el.appendChild(tbl); }
  }
  if(modKey==='finance'){
    if(subKey==='installment'){ el.appendChild(F('ØªØ¹Ø±ÛŒÙ Ø§Ù‚Ø³Ø§Ø·',[{l:'Ø¨ÛŒÙ…Ø§Ø±',n:'pt'},{l:'Ú©Ù„ Ù…Ø¨Ù„Øº',n:'total',type:'number'},{l:'Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª',n:'pre',type:'number'},{l:'ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·',n:'n',type:'number'}])); }
    if(subKey==='check'){ el.appendChild(F('Ø«Ø¨Øª Ú†Ú©',[{l:'Ù†Ø§Ù…',n:'p'},{l:'Ù…Ø¨Ù„Øº',n:'amt',type:'number'},{l:'Ø³Ø±Ø±Ø³ÛŒØ¯',n:'due',type:'date'}])); }
  }
  if(modKey=='implant'){
    if(subKey=='new'){ el.appendChild(F('Ø«Ø¨Øª Ø¬Ø±Ø§Ø­ÛŒ Ø§ÛŒÙ…Ù¾Ù„Ù†Øª',[{l:'Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±',n:'pt'},{l:'ÙÚ©/Ù†ÙˆØ§Ø­ÛŒ',n:'area',tag:'select',list:['ÙÚ© Ø¨Ø§Ù„Ø§','ÙÚ© Ù¾Ø§ÛŒÛŒÙ†','Ù‚Ø¯Ø§Ù…','Ø®Ù„Ù']},{l:'ØªØ¹Ø¯Ø§Ø¯ Ø§ÛŒÙ…Ù¾Ù„Ù†Øª',n:'count',type:'number'},{l:'ØªØ§Ø±ÛŒØ® Ø¬Ø±Ø§Ø­ÛŒ',n:'date',type:'date'},{l:'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',n:'note',tag:'textarea'}])); }
    if(subKey=='due'){ el.appendChild(F('Ù¾ÛŒÚ¯ÛŒØ±ÛŒ',[{l:'Ú©Ø¯/Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±',n:'pt'},{l:'Ù…ÙˆØ¶ÙˆØ¹ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ',n:'topic',tag:'select',list:['Ø¨Ø®ÛŒÙ‡','Ù¾Ø§Ù†Ø³Ù…Ø§Ù†','Ù¾Ø±ÙˆØªØ²','Ù…Ø¹Ø§ÛŒÙ†Ù‡']}])); }
    if(subKey=='list'){ el.appendChild(F('Ù„ÛŒØ³Øª Ø¬Ø±Ø§Ø­ÛŒâ€ŒÙ‡Ø§ (ÙÛŒÙ„ØªØ±)',[{l:'Ø§Ø² ØªØ§Ø±ÛŒØ®',n:'from',type:'date'},{l:'ØªØ§ ØªØ§Ø±ÛŒØ®',n:'to',type:'date'}])); }
    if(subKey=='sterile'){ el.appendChild(F('Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø§Ø³ØªØ±ÛŒÙ„',[{l:'Ø§ØªÙˆÚ©Ù„Ø§Ùˆ OK',n:'autoclave',tag:'select',list:['Ø¨Ù„Ù‡','Ø®ÛŒØ±']},{l:'Ø³Øª Ø¬Ø±Ø§Ø­ÛŒ Ú©Ø§Ù…Ù„',n:'kit',tag:'select',list:['Ø¨Ù„Ù‡','Ø®ÛŒØ±']},{l:'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',n:'note',tag:'textarea'}])); }
  }
  if(modKey=='inventory'){
    if(subKey=='stock'){ el.appendChild(F('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ù„Ø§',[{l:'Ù†Ø§Ù… Ú©Ø§Ù„Ø§/Ú©Ø¯',n:'item'},{l:'Ú¯Ø²Ø§Ø±Ø´ ØªØ§ ØªØ§Ø±ÛŒØ®',n:'date',type:'date'}])); }
    if(subKey=='in'){ el.appendChild(F('ÙˆØ±ÙˆØ¯ Ú©Ø§Ù„Ø§',[{l:'Ù†Ø§Ù… Ú©Ø§Ù„Ø§',n:'item'},{l:'ØªØ¹Ø¯Ø§Ø¯',n:'qty',type:'number'},{l:'ØªØ£Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡',n:'vendor'},{l:'ØªØ§Ø±ÛŒØ®',n:'date',type:'date'}])); }
    if(subKey=='out'){ el.appendChild(F('Ø®Ø±ÙˆØ¬ Ú©Ø§Ù„Ø§',[{l:'Ù†Ø§Ù… Ú©Ø§Ù„Ø§',n:'item'},{l:'ØªØ¹Ø¯Ø§Ø¯',n:'qty',type:'number'},{l:'Ù…ØµØ±Ù Ø¨Ø±Ø§ÛŒ',n:'use',tag:'select',list:['Ø¯Ø±Ù…Ø§Ù†','ÙØ±ÙˆØ´','Ø¯ÛŒÚ¯Ø±']},{l:'ØªØ§Ø±ÛŒØ®',n:'date',type:'date'}])); }
    if(subKey=='low'){ el.appendChild(F('Ú©Ø³Ø±ÛŒ/Ø­Ø¯Ø§Ù‚Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ',[{l:'Ø¢Ø³ØªØ§Ù†Ù‡Ù” Ù‡Ø´Ø¯Ø§Ø±',n:'min',type:'number'}])); }
  }
  if(modKey=='lab'){
    if(subKey=='send'){ el.appendChild(F('Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø±',[{l:'Ø¨ÛŒÙ…Ø§Ø±',n:'pt'},{l:'Ù†ÙˆØ¹ Ú©Ø§Ø±',n:'job',tag:'select',list:['Ø±ÙˆÚ©Ø´','Ø¨Ø±ÛŒØ¬','Ø¯Ù†Ø¯Ø§Ù† Ù…ØµÙ†ÙˆØ¹ÛŒ','Ø§ÙˆØ±Ø¯Ù†Ú†Ø±']},{l:'ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„',n:'date',type:'date'},{l:'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',n:'note',tag:'textarea'}])); }
    if(subKey=='receive'){ el.appendChild(F('Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø±',[{l:'Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´',n:'code'},{l:'ØªØ§Ø±ÛŒØ® Ø¯Ø±ÛŒØ§ÙØª',n:'date',type:'date'},{l:'ÙˆØ¶Ø¹ÛŒØª',n:'status',tag:'select',list:['Ú©Ø§Ù…Ù„','Ù†Ø§Ù‚Øµ','Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ØµÙ„Ø§Ø­']}])); }
    if(subKey=='track'){ el.appendChild(F('Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ú©Ø§Ø± Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø±',[{l:'Ø´Ù…Ø§Ø±Ù‡/Ø¨ÛŒÙ…Ø§Ø±',n:'q'}])); }
    if(subKey=='bill'){ el.appendChild(F('Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø±',[{l:'Ù„Ø§Ø¨Ø±Ø§ØªÙˆØ§Ø±',n:'lab'},{l:'Ù…Ø¨Ù„Øº',n:'amt',type:'number'},{l:'ØªØ§Ø±ÛŒØ®',n:'date',type:'date'}])); }
  }
  return el;
}
function openEntry(k){ setActiveNav(k); const mod=ALL_TILES.find(x=>x.k===k); const box=document.createElement('div'); box.innerHTML='<div class="mini">ÛŒÚ© Ø¹Ù…Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</div>';
  (mod.subs||[]).forEach(([sk,lab])=>{ const b=document.createElement('button'); b.className='btn'; b.style.margin='8px 6px 0 0'; b.textContent=lab; b.onclick=()=>openRoute(mod.k, sk); box.appendChild(b); });
  openSheet(mod.t+' â€¢ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ù…Ù„', box); setHandlers(null, closeSheet, closeSheet); }
function openRoute(modKey, subKey){ setActiveNav(modKey); const host=buildForm(modKey, subKey); const title=(ALL_TILES.find(t=>t.k===modKey).t)+' â€¢ '+(ALL_TILES.find(t=>t.k===modKey).subs.find(s=>s[0]===subKey)[1]);
  openSheet(title, host); setHandlers(()=>submitForm(modKey, subKey), ()=>openEntry(modKey), closeSheet); }
function submitForm(modKey, subKey){ const data={}; sBody.querySelectorAll('input,select,textarea').forEach(i=>data[i.name]=i.value);
  if(modKey==='patients' && subKey==='add'){ const arr=DB.get('DOS.PATIENTS',[]); arr.push(data); DB.set('DOS.PATIENTS',arr); }
  DB.set(`DOS.${modKey}.${subKey}.last`, {at:Date.now(), data}); toast('Ø«Ø¨Øª Ø´Ø¯ âœ…'); }

/* â€”â€” ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø§Ù„ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ© + Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§ â€”â€” */
function d2j(gy,gm,gd){const gdm=[0,31,59,90,120,151,181,212,243,273,304,334];gy-=1600;gm--;gd--;let g=365*gy+((gy+3)>>2)-((gy+99)>>2)+((gy+399)>>2);g+=gdm[gm]+gd;if(gm>1&&((gy%4==0&&gy%100!=0)||(gy%400==0)))g++;let j=g-79;let np=(j/12053)|0;j%=12053;let jy=979+33*np+4*((j/1461)|0);j%=1461;if(j>=366){jy+=(j-1)/365|0;j=(j-1)%365}let jm=(j<186)?1+(j/31|0):7+((j-186)/30|0);let jd=1+((j<186)?(j%31):((j-186)%30));return[jy,jm,jd]}
function jMonthLen(jy,jm){return jm<=6?31:jm<=11?30:29}
function j2g(jy,jm,jd){jy-=979;let j=365*jy+((jy/33)|0)*8+(((jy%33)+3)/4|0);for(let i=1;i<jm;i++)j+=i<=6?31:i<=11?30:29;j+=jd-1;let g=j+79;let gy=1600+400*((g/146097)|0);g%=146097;if(g>=36525){g--;gy+=100*((g/36524)|0);g%=36524;if(g>=365)g--}gy+=4*((g/1461)|0);g%=1461;if(g>=366){g--;gy+=(g/365)|0;g%=365}function gml(y,m){return[31,((y%4==0&&y%100!=0)||(y%400==0))?29:28,31,30,31,30,31,31,30,31,30,31][m-1]}let gm=1;for(;gm<=12&&g>=gml(gy,gm);gm++){g-=gml(gy,gm)}let gd=g+1;return[gy,gm,gd]}
function buildCalendar(container,date=new Date()){ const [jy,jm,jd]=d2j(date.getFullYear(),date.getMonth()+1,date.getDate()); renderCal(container,jy,jm,jd); }
function renderCal(container,jy,jm,today_d){
  container.innerHTML=''; const wrap=document.createElement('div'); const head=document.createElement('div'); head.className='calhead';
  const ttl=document.createElement('div'); ttl.textContent=`ØªÙ‚ÙˆÛŒÙ… â€¢ ${jy}/${String(jm).padStart(2,'0')}`;
  const prev=document.createElement('button'); prev.className='btn'; prev.textContent='â—€';
  const next=document.createElement('button'); next.className='btn'; next.textContent='â–¶';
  prev.onclick=()=>{ const njm=jm===1?12:jm-1; const njy=jm===1?jy-1:jy; renderCal(container, njy, njm, null); };
  next.onclick=()=>{ const njm=jm===12?1:jm+1; const njy=jm===12?jy+1:jy; renderCal(container, njy, njm, null); };
  head.append(prev, ttl, next);
  const grid=document.createElement('div'); grid.className='calgrid';
  'Ø´ ÛŒ Ø¯ Ø³ Ú† Ù¾ Ø¬'.split(' ').forEach(d=>{ const e=document.createElement('div'); e.className='caldow'; e.textContent=d; grid.appendChild(e); });
  const [gy1,gm1,gd1]=j2g(jy,jm,1); const wk=new Date(gy1,gm1-1,gd1).getDay(); const start=(wk+1)%7;
  for(let i=0;i<start;i++){ const e=document.createElement('div'); e.className='calday hidden'; grid.appendChild(e); }
  const len=jMonthLen(jy,jm); for(let d=1; d<=len; d++){ const e=document.createElement('div'); e.className='calday'; e.textContent=d; if(d===today_d) e.classList.add('today');
    const plus=document.createElement('span'); plus.className='plus'; plus.textContent='+'; e.appendChild(plus);
    let holdTimer=null; let longPressed=false;
    e.addEventListener('pointerdown', ()=>{ longPressed=false; holdTimer=setTimeout(()=>{ longPressed=true; openRoute('events','quick'); }, 700); });
    e.addEventListener('pointerup', ()=>{ clearTimeout(holdTimer); if(!longPressed){ openRoute('events','today'); } });
    e.addEventListener('pointerleave', ()=>{ clearTimeout(holdTimer); });
    grid.appendChild(e);
  }
  wrap.append(head, grid); container.appendChild(wrap);
}
buildCalendar(EL('#calHost'), new Date());

/* â€”â€” Ù…Ù†Ùˆ Ù‡Ù…Ø¨Ø±Ú¯Ø±ÛŒ â€”â€” */
const hamb=EL('#hamb'), sidemenu=EL('#sidemenu'), backdrop=EL('#backdrop');
function closeMenu(){ hamb.classList.remove('active'); sidemenu.classList.remove('open'); backdrop.classList.remove('show'); }
hamb.onclick=()=>{ hamb.classList.toggle('active'); sidemenu.classList.toggle('open'); backdrop.classList.toggle('show'); };
backdrop.onclick=closeMenu;
sidemenu.addEventListener('click',(e)=>{
  const act=e.target.closest('[data-act]'); if(!act) return;
  if(act.dataset.act==='askNoti'){ if('Notification' in window) Notification.requestPermission().then(p=>toast(p==='granted'?'Ø§Ø¹Ù„Ø§Ù† ÙØ¹Ø§Ù„ Ø´Ø¯':'Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯')); else toast('Ø§Ø¹Ù„Ø§Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); }
  if(act.dataset.act==='askMic'){ navigator.mediaDevices?.getUserMedia({audio:true}).then(()=>toast('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† OK')).catch(()=>toast('Ø±Ø¯ Ø´Ø¯')); }
  if(act.dataset.act==='installPWA'){ promptPWA(); }
  if(act.dataset.act==='updateApp'){ toast('Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØªØŒ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯.'); }
});

/* â€”â€” Ø¬Ø³ØªØ¬Ùˆ + Ú¯ÙØªØ§Ø± â€”â€” */
const micBtn=EL('#micBtn'), q=EL('#q'); let rec=null, recognizing=false;
function ensureRecognizer(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('SpeechRecognition Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return null; } const r=new SR(); r.lang='fa-IR'; r.interimResults=true; r.continuous=false; r.onresult=(ev)=>{ let txt=''; for(const res of ev.results){ txt+=res[0].transcript } q.value=txt; }; r.onend=()=>{ recognizing=false; micBtn.classList.remove('rec'); }; return r; }
micBtn.onclick=()=>{ if(recognizing){ rec&&rec.stop(); return; } if(!rec) rec=ensureRecognizer(); if(!rec) return; recognizing=true; micBtn.classList.add('rec'); try{ rec.start(); }catch(e){} };
EL('#searchBtn').onclick=runSearch; q.addEventListener('keydown',e=>{ if(e.key==='Enter') runSearch(); });
function runSearch(){ const v=q.value.trim(); if(!v){ toast('Ù…ØªÙ†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  if(/Ø§Ù…Ø±ÙˆØ²|today/i.test(v)) openRoute('events','today');
  else if(/Ù†ÙˆØ¨Øª|ÙˆÙ‚Øª/.test(v)) openRoute('events','quick');
  else if(/Ú†Ú©/.test(v)) openRoute('finance','check');
  else if(/Ù‚Ø³Ø·|Ø§Ù‚Ø³Ø§Ø·/.test(v)) openRoute('finance','installment');
  else if(/Ø¨ÛŒÙ…Ø§Ø±/.test(v)) openRoute('patients','list');
  else openSheet('Ù†ØªÛŒØ¬Ù‡ Ø¬Ø³ØªØ¬Ùˆ','Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ù†ØªÛŒØ¬Ù‡Ù” Ø¯Ù‚ÛŒÙ‚ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ú©Ø±Ø¯.'); }

/* â€”â€” Ø§ÙˆØ±Ø¨ AI: Ø¬Ø§Ø¨Ù‡â€ŒØ¬Ø§ÛŒÛŒ â€”â€” */
(function(){ const orb=EL('#aiOrb'); const pos=DB.get('DOS.ai.pos',null);
  if(pos){ orb.style.left=pos.l; orb.style.top=pos.t; orb.style.right='auto'; orb.style.bottom='auto'; }
  let dragging=false, dx=0, dy=0;
  orb.addEventListener('pointerdown', (e)=>{ dragging=true; const r=orb.getBoundingClientRect(); dx=e.clientX-r.left; dy=e.clientY-r.top; orb.setPointerCapture(e.pointerId); });
  window.addEventListener('pointermove', (e)=>{ if(!dragging) return; orb.style.left=(e.clientX-dx)+'px'; orb.style.top=(e.clientY-dy)+'px'; orb.style.right='auto'; orb.style.bottom='auto'; });
  window.addEventListener('pointerup', ()=>{ if(!dragging) return; dragging=false; DB.set('DOS.ai.pos',{l:orb.style.left,t:orb.style.top}); });
  orb.addEventListener('click', ()=> q.focus() );
})();

/* â€”â€” Ø§ÙÚ©Øª Ù‚Ø·Ø±Ù‡ Ø²ÛŒØ± Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† â€”â€” */
(function(){
  const bnav=EL('#bnav'); const droplet=EL('#drop');
  let active = false;
  function move(e){
    if(!active) return;
    const rect = bnav.getBoundingClientRect();
    const x = Math.max(rect.left+36, Math.min(e.clientX, rect.right-36));
    const y = rect.top + rect.height/2;
    droplet.style.transform = `translate(${x-36}px, ${y-36}px)`;
  }
  bnav.addEventListener('pointerdown', (e)=>{ active=true; droplet.classList.add('show'); move(e); });
  window.addEventListener('pointermove', move);
  window.addEventListener('pointerup', ()=>{ active=false; droplet.classList.remove('show'); });
})();

/* â€”â€” ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø´ÛŒ â€”â€” */
function openTileOptions(k){ const mod=ALL_TILES.find(x=>x.k===k); const wrap=document.createElement('div'); wrap.innerHTML=`<div class="mini">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Â«${mod.t}Â»</div>`; (mod.subs||[]).forEach(([sk,lab])=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=lab; b.onclick=()=>openRoute(mod.k, sk); wrap.appendChild(b); }); openSheet('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø´ÛŒ', wrap); setHandlers(null, closeSheet, closeSheet); }

/* â€”â€” ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± â€”â€” */
function simulateFill(){ const inputs=sBody.querySelectorAll('input,select,textarea'); inputs.forEach((el,i)=>{ if(el.tagName==='SELECT'){ el.selectedIndex=Math.min(1, el.options.length-1); } else if(el.type==='time'){ el.value='10:00'; } else if(el.type==='date'){ el.value=new Date().toISOString().slice(0,10); } else if(el.type==='number'){ el.value=100000*(i+1); } else { el.value= el.placeholder || 'Ù†Ù…ÙˆÙ†Ù‡'; } }); }
function runScenario(){
  const R=[]; const roleWas=roleSel.value;
  function log(ok,msg){ R.push((ok?'âœ… ':'âŒ ')+msg); }
  const ptName='Ø¨ÛŒÙ…Ø§Ø± Ù†Ù…ÙˆÙ†Ù‡ ' + Math.floor(Math.random()*1000);
  openRoute('patients','add'); setTimeout(()=>{
    try{ sBody.querySelector('[name="name"]').value=ptName; sBody.querySelector('[name="tel"]').value='09120000000'; submitForm('patients','add'); log(true,'patients/add: Ø«Ø¨Øª Ø¨ÛŒÙ…Ø§Ø±'); }
    catch(e){ log(false,'patients/add: Ø®Ø·Ø§ '+e.message); }
    openRoute('events','quick'); setTimeout(()=>{
      try{ sBody.querySelector('[name="pt"]').value=ptName; sBody.querySelector('[name="t"]').value='11:00'; submitForm('events','quick'); log(true,'events/quick: Ù†ÙˆØ¨Øª Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø«Ø¨Øª Ø´Ø¯'); }
      catch(e){ log(false,'events/quick: Ø®Ø·Ø§ '+e.message); }
      openRoute('finance','installment'); setTimeout(()=>{
        try{ sBody.querySelector('[name="pt"]').value=ptName; sBody.querySelector('[name="total"]').value=2000000; sBody.querySelector('[name="pre"]').value=0; sBody.querySelector('[name="n"]').value=4; submitForm('finance','installment'); log(true,'finance/installment: Ù‚Ø³Ø· Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯'); }
        catch(e){ log(false,'finance/installment: Ø®Ø·Ø§ '+e.message); }
        try{
          const pts=DB.get('DOS.PATIENTS',[]); const found=pts.some(p=>p.name===ptName);
          log(found,'Ø¨Ø±Ø±Ø³ÛŒ Ù„ÛŒØ³Øª Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²');
        }catch(e){ log(false,'Ø®ÙˆØ§Ù†Ø¯Ù† Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø² Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†'); }
        if('Notification' in window){
          Notification.requestPermission().then(p=>{
            if(p==='granted'){ new Notification('DentalOS',{body:`ÛŒØ§Ø¯Ø¢ÙˆØ± ØªØ³Øª Ø¨Ø±Ø§ÛŒ ${ptName}`}); log(true,'Ø§Ø¹Ù„Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯'); after(); }
            else { log(false,'Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¹Ù„Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯'); after(); }
          });
        } else { log(false,'Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¹Ù„Ø§Ù† Ù†Ø¯Ø§Ø±Ø¯'); after(); }
      },130);
    },130);
  },130);
  function after(){ roleSel.value=roleWas; buildTiles(); rebuildBottomNav(); EL('#report').value=R.join('\n'); toast('ØªØ³Øª Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ ÙˆØ§Ù‚Ø¹ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯'); }
}
EL('#runTests').onclick=runScenario;

function runDeep(){
  const R=[]; let i=0; const plans=[];
  ALL_TILES.forEach(m=> (m.subs||[]).forEach(s=> plans.push([m.k,s[0]])));
  function log(ok,msg){ R.push((ok?'âœ… ':'âŒ ')+msg); }
  function step(){
    if(i>=plans.length){ EL('#report').value=R.join('\n'); toast('ØªØ³Øª Ø¹Ù…ÛŒÙ‚ ØªÙ…Ø§Ù… Ø´Ø¯'); return; }
    const [mk,sk]=plans[i++];
    try{
      openRoute(mk,sk);
      setTimeout(()=>{ simulateFill(); try{ submitForm(mk,sk); log(true, mk+'/'+sk+': Ø«Ø¨Øª Ø´Ø¯'); } catch(e){ log(false, mk+'/'+sk+': Ø®Ø·Ø§') } setTimeout(step,90); },70);
    }catch(e){ log(false, mk+'/'+sk+': Ø¨Ø§Ø² Ù†Ø´Ø¯'); setTimeout(step,60); }
  }
  step();
}
EL('#runDeep').onclick=runDeep;
EL('#copyReport').onclick=()=>{ const ta=EL('#report'); ta.select(); try{ navigator.clipboard.writeText(ta.value).then(()=>toast('Ú©Ù¾ÛŒ Ø´Ø¯')); }catch(e){ document.execCommand('copy'); toast('Ú©Ù¾ÛŒ Ø´Ø¯'); } };

/* â€”â€” PWA â€”â€” */
let deferredPrompt=null; window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; });
function promptPWA(){ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; } else toast('Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ú¯Ø²ÛŒÙ†Ù‡Ù” Ù†ØµØ¨ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.'); }

/* â€”â€” ØªÙ…â€ŒÙ‡Ø§ â€”â€” */
EL('#themeSel').onchange=e=>{ const v=e.target.value; if(v==='aqua'){ document.body.style.background='linear-gradient(180deg,#06141f,#093a5c)'; } else if(v==='sunset'){ document.body.style.background='linear-gradient(180deg,#190a14,#4b112a,#0e1226)'; } else if(v==='dark'){ document.body.style.background='linear-gradient(180deg,#06060a,#0b0b0f)'; } else { location.reload(); } };
</script>

<!-- â€”â€” ÙˆØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø¬Ù„Ø§Ù„ÛŒ Ø²Ù†Ø¯Ù‡ Ùˆ ØªÙ‚ÙˆÛŒÙ… V2 (ÙÙ‚Ø· Ø§ÙØ²ÙˆØ¯Ù†) â€”â€”
     * Ø´Ø§Ù…Ù„ Ù‡Ø¯Ø± Ø²Ù†Ø¯Ù‡ØŒ Ø³Ø§Ø¹ØªØŒ Ù‡Ù…Ú¯Ø§Ù… Ø¨Ø§ Ø¯Ø³ØªÚ¯Ø§Ù‡ØŒ Ø·ÙˆÙ„ Ù…Ø§Ù‡ Ø¯Ù‚ÛŒÙ‚ØŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Â«Ø§Ù…Ø±ÙˆØ²Â»
     * ØªØ¹Ø§Ù…Ù„â€ŒÙ‡Ø§: Ù„Ù…Ø³ Ú©ÙˆØªØ§Ù‡=Ù„ÛŒØ³Øª Ù‡Ù…Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ØŒ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ†=Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù‡Ù…Ø§Ù† Ø±ÙˆØ²  -->
<style>
/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ø± Ø²Ù†Ø¯Ù‡ Ùˆ Â«Ø§Ù…Ø±ÙˆØ²Â» Ø¨Ø±Ø§Ù‚ Ø¯Ø§Ø®Ù„ ØªÙ‚ÙˆÛŒÙ… */
.jalali-live-header{font-weight:700;font-size:clamp(14px,3.4vw,22px);display:flex;gap:.55rem;justify-content:center;background:linear-gradient(135deg,#9ae6ff,#b6f3c6,#ffd28f,#ff9ac0);-webkit-background-clip:text;background-clip:text;color:transparent;margin:.25rem auto .5rem}
.jalali-live-header .clock{font-variant-numeric:tabular-nums;background:rgba(255,255,255,.1);color:#fff;padding:.15rem .5rem;border-radius:10px;border:1px solid rgba(255,255,255,.22);backdrop-filter:blur(8px)}
.cal-grid .day{display:flex;align-items:center;justify-content:center;height:46px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:radial-gradient(120% 150% at 50% -20%, rgba(255,255,255,.18), rgba(120,160,220,.06) 50%, rgba(255,255,255,.04) 100%);color:#e9f3ff;font-weight:700}
.cal-grid .day.empty{visibility:hidden}
#calHost .day.today{position:relative;background:radial-gradient(140% 120% at 10% 5%, rgba(255,255,255,.9), rgba(180,225,255,.55) 32%, rgba(150,210,255,.35) 50%, rgba(110,160,255,.2) 70%, rgba(90,120,220,.12) 90%);box-shadow:inset 0 1px 0 rgba(255,255,255,.65), inset 0 -2px 6px rgba(0,0,0,.18), 0 10px 26px rgba(0,30,90,.28), 0 2px 8px rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.45)!important;outline:2px solid rgba(0,220,255,.35)}
#calHost .day.today::after{content:"Ø§Ù…Ø±ÙˆØ²";position:absolute;bottom:6px;left:50%;transform:translateX(-50%);font-size:.7em;color:#0b3868;opacity:.9;font-weight:700}
</style>
<script>
/* ØªÙ‚ÙˆÛŒÙ… Ø³Ø§Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ + Ù‡Ø¯Ø± Ø²Ù†Ø¯Ù‡ (Ù†Ø³Ø®Ù‡ Ø³Ø¨Ú©) */
(function(){
  const host = document.getElementById('calHost'); if(!host) return;
  const PDS=['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹']; const toFa=s=>String(s).replace(/[0-9]/g,d=>PDS[d]);
  const MONTH = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
  function d2j(gy,gm,gd){const gdm=[0,31,59,90,120,151,181,212,243,273,304,334];gy-=1600;gm--;gd--;let g=365*gy+((gy+3)>>2)-((gy+99)>>2)+((gy+399)>>2);g+=gdm[gm]+gd;if(gm>1&&((gy%4==0&&gy%100!=0)||(gy%400==0)))g++;let j=g-79;let np=(j/12053)|0;j%=12053;let jy=979+33*np+4*((j/1461)|0);j%=1461;if(j>=366){jy+=(j-1)/365|0;j=(j-1)%365}let jm=(j<186)?1+(j/31|0):7+((j-186)/30|0);let jd=1+((j<186)?(j%31):((j-186)%30));return[jy,jm,jd]}
  function j2g(jy,jm,jd){jy-=979;let j=365*jy+((jy/33)|0)*8+(((jy%33)+3)/4|0);for(let i=1;i<jm;i++)j+=i<=6?31:i<=11?30:29;j+=jd-1;let g=j+79;let gy=1600+400*((g/146097)|0);g%=146097;if(g>=36525){g--;gy+=100*((g/36524)|0);g%=36524;if(g>=365)g--}gy+=4*((g/1461)|0);g%=1461;if(g>=366){g--;gy+=(g/365)|0;g%=365}function gml(y,m){return[31,((y%4==0&&gy%100!=0)||(y%400==0))?29:28,31,30,31,30,31,31,30,31,30,31][m-1]}let gm=1;for(;gm<=12&&g>=gml(gy,gm);gm++){g-=gml(gy,gm)}let gd=g+1;return[gy,gm,gd]}
  function jMonthLen(jy,jm){let njy=jy, njm=jm+1; if(njm===13){ njy++; njm=1; } const a=j2g(jy,jm,1), b=j2g(njy,njm,1); const da=new Date(a[0],a[1]-1,a[2]), db=new Date(b[0],b[1]-1,b[2]); return Math.round((db-da)/86400000);}
  // Ù‡Ø¯Ø± Ø²Ù†Ø¯Ù‡
  const head=document.createElement('div'); head.className='jalali-live-header'; head.innerHTML='<span class="wday">â€”</span><span class="date">â€”</span><span class="month">â€”</span><span class="year">â€”</span><span class="clock">--:--:--</span>'; host.prepend(head);
  function tick(){ const now=new Date(); const h=String(now.getHours()).padStart(2,'0'), m=String(now.getMinutes()).padStart(2,'0'), s=String(now.getSeconds()).padStart(2,'0');
    const d2=d2j(now.getFullYear(),now.getMonth()+1,now.getDate()); head.querySelector('.clock').textContent=toFa(`${h}:${m}:${s}`);
    head.querySelector('.date').textContent=toFa(d2[2]); head.querySelector('.month').textContent=MONTH[d2[1]-1]; head.querySelector('.year').textContent=toFa(d2[0]);
    head.querySelector('.wday').textContent=['Ø´Ù†Ø¨Ù‡','ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡'][(now.getDay()+1)%7]; }
  tick(); setInterval(tick,1000);
})();
</script>

</body>
</html>
