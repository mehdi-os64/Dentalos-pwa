<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DentalOS • PWA</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1020"/>

  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#0b1020;color:#eef}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:rgba(255,255,255,.06);backdrop-filter: blur(8px);border-radius:14px;padding:14px;margin:14px 0;border:1px solid rgba(255,255,255,.08)}
    h1,h2{margin:.2rem 0 1rem}
    input,button,textarea{font-size:16px;border-radius:10px;border:1px solid #3b4457; padding:12px;background:#0e1529;color:#eef; outline:none}
    input,textarea{width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .btn{background:#12b3ff;border-color:#12b3ff; cursor:pointer}
    .muted{opacity:.75}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px;text-align:right}
    .ok{color:#38f27a}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:6px}
    .dot.on{background:#23e16c}.dot.off{background:#ff5d6c}
    #toast{display:none;position:fixed;bottom:14px;left:14px;right:14px;background:#141c33;border:1px solid #2a3553;border-radius:10px;padding:12px;z-index:99}
    small.badge{border:1px solid rgba(255,255,255,.18);padding:3px 8px;border-radius:999px;margin-right:6px;font-size:12px;opacity:.85}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="toast"></div>

<div class="wrap">

  <div class="card">
    <h1>DentalOS • PWA
      <small class="badge" id="version">v1</small>
      <span class="dot" id="onlineDot"></span>
      <small class="muted" id="onlineText">چک اتصال…</small>
    </h1>
    <div class="muted">نسخه‌ی کامل با آفلاین/آنلاین، همگام‌سازی زنده (Realtime) و بک‌آپ خودکار.</div>
  </div>

  <!-- فرم نوبت‌ها -->
  <div class="card">
    <h2>نوبت جدید</h2>
    <div class="grid2">
      <input id="ap_patient" placeholder="نام بیمار">
      <input id="ap_doctor"  placeholder="نام دکتر">
    </div>
    <div class="grid2">
      <input id="ap_time" type="datetime-local" placeholder="زمان نوبت">
      <input id="ap_note" placeholder="یادداشت (اختیاری)">
    </div>
    <div class="row">
      <button class="btn" id="btnAddAppt">افزودن/ثبت</button>
      <button id="btnSync" title="ارسال آفلاین‌های باقیمانده">همگام‌سازی معوقه</button>
      <button id="btnBackup" title="بک‌آپ فوری">بک‌آپ فوری</button>
    </div>
    <div class="muted">هر تغییری که منشی ایجاد کند، روی همه‌ی گوشی‌ها زنده (Realtime) دیده می‌شود. اگر آفلاین باشید، در صف ذخیره می‌شود و به محض اتصال ارسال می‌گردد.</div>
  </div>

  <!-- لیست نوبت‌ها -->
  <div class="card">
    <h2>لیست نوبت‌ها</h2>
    <div id="apptCount" class="muted"></div>
    <table>
      <thead>
        <tr><th>ویرایش</th><th>زمان</th><th>دکتر</th><th>بیمار</th></tr>
      </thead>
      <tbody id="apptsBody"><tr><td colspan="4" class="muted">در حال بارگذاری…</td></tr></tbody>
    </table>
  </div>

  <!-- قیمت‌ها (بخشی از همین صفحه؛ برنامه‌ی اصلی همین است) -->
  <div class="card">
    <h2>ثبت قیمت خدمت</h2>
    <div class="grid2">
      <input id="pr_title"  placeholder="نام خدمت (مثلاً کامپوزیت)">
      <input id="pr_amount" type="number" inputmode="numeric" placeholder="قیمت (تومان)">
    </div>
    <div class="row">
      <button class="btn" id="btnAddPrice">افزودن/ثبت</button>
    </div>
    <div class="muted">قیمت‌ها هم Realtime هستند؛ آفلاین → صف → ارسال خودکار.</div>
  </div>

  <div class="card">
    <h2>لیست قیمت‌ها</h2>
    <div id="priceCount" class="muted"></div>
    <table>
      <thead>
        <tr><th>ویرایش</th><th>قیمت (تومان)</th><th>نام خدمت</th></tr>
      </thead>
      <tbody id="pricesBody"><tr><td colspan="3" class="muted">در حال بارگذاری…</td></tr></tbody>
    </table>
  </div>

  <div class="card muted">
    DentalOS • PWA • Supabase Realtime • Backup (Local + Cloud)
  </div>
</div>

<!-- اسکریپت‌ها -->
<script src="/sw-register.js"></script>
<script type="module" src="/js/db.js"></script>
<script type="module" src="/js/realtime.js"></script>
<script type="module" src="/js/backup.js"></script>

<script>
  // اتصالات UI ساده
  const $ = s => document.querySelector(s);

  // وضعیت آنلاین/آفلاین
  function updateOnlineBadge(){
    const dot = $('#onlineDot'), t = $('#onlineText');
    const on = navigator.onLine;
    dot.className = 'dot ' + (on?'on':'off');
    t.textContent = on ? 'آنلاین' : 'آفلاین (صف فعال است)';
  }
  window.addEventListener('online', updateOnlineBadge);
  window.addEventListener('offline', updateOnlineBadge);
  updateOnlineBadge();

  // نسخه
  fetch('/latest.json').then(r=>r.json()).then(j=>{
    $('#version').textContent = j?.version || 'v1';
  }).catch(()=>{});

  // هندل دکمه‌ها
  import('/js/db.js').then(({DB})=>{
    // افزودن نوبت
    $('#btnAddAppt').onclick = async ()=>{
      const obj = {
        patient: $('#ap_patient').value.trim(),
        doctor:  $('#ap_doctor').value.trim(),
        time:    $('#ap_time').value,
        note:    $('#ap_note').value.trim()
      };
      await DB.addAppointment(obj);
      $('#ap_patient').value = $('#ap_doctor').value = $('#ap_time').value = $('#ap_note').value = '';
    };
    // افزودن قیمت
    $('#btnAddPrice').onclick = async ()=>{
      const obj = {
        title:  $('#pr_title').value.trim(),
        amount: Number($('#pr_amount').value||0)
      };
      await DB.addPrice(obj);
      $('#pr_title').value = ''; $('#pr_amount').value='';
    };
    // همگام‌سازی معوقه
    $('#btnSync').onclick = async ()=>{ await DB.syncPending(true); };
  });

  // توابع رندر برای استفاده در db.js
  window.renderAppointments = function(list){
    $('#apptCount').textContent = `تعداد ${list.length} مورد`;
    const tbody = $('#apptsBody');
    if(!list.length){ tbody.innerHTML = `<tr><td colspan="4" class="muted">هنوز نوبتی ثبت نشده است.</td></tr>`; return; }
    tbody.innerHTML = list.map(r=>`
      <tr>
        <td><small class="badge">#${r.id}</small></td>
        <td>${new Date(r.time).toLocaleString('fa-IR')}</td>
        <td>${r.doctor||'-'}</td>
        <td>${r.patient||'-'}</td>
      </tr>
    `).join('');
  };

  window.renderPrices = function(list){
    $('#priceCount').textContent = `تعداد ${list.length} مورد`;
    const tbody = $('#pricesBody');
    if(!list.length){ tbody.innerHTML = `<tr><td colspan="3" class="muted">هنوز قیمتی ثبت نشده است.</td></tr>`; return; }
    tbody.innerHTML = list.map(r=>`
      <tr>
        <td><small class="badge">#${r.id}</small></td>
        <td>${(r.amount||0).toLocaleString('fa-IR')}</td>
        <td>${r.title||'-'}</td>
      </tr>
    `).join('');
  };
</script>
</body>
</html>
