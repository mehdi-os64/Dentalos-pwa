<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DentalOS • PWA</title>

  <!-- رنگ نوار مرورگر -->
  <meta name="theme-color" content="#0b1020" />

  <!-- PWA Manifest (مسیر نسبی تا با ریشه‌ی دامنه تداخل نکند) -->
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- آیکون‌ها (در صورت تفاوت نام فایل‌ها، اصلاح کن) -->
  <link rel="apple-touch-icon" href="./icons/tooth-180.png" sizes="180x180" />
  <link rel="icon" type="image/png" href="./icons/tooth-192.png" sizes="192x192" />
  <link rel="icon" type="image/png" href="./icons/tooth-512.png" sizes="512x512" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DentalOS" />

  <style>
    /* می‌تونی استایل اصلی خودت را نگه داری؛ این فقط یک پایه‌ی ساده‌ست */
    :root{
      --bg:#0b1020; --text:#eaf3ff; --muted:#b6c2d1; --accent:#00e5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:radial-gradient(60rem 60rem at 10% -10%, rgba(61,140,255,.12), transparent 60%),
                                   radial-gradient(50rem 50rem at 110% 10%, rgba(0,229,255,.10), transparent 55%),
                                   linear-gradient(180deg,#0a0f1f 0%,#0b1020 40%,#0b1020 100%);
      font-family: ui-rounded, "Vazirmatn", "IRANSans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;backdrop-filter:blur(12px)}
    .muted{color:var(--muted)}
    .okdot{width:.6rem;height:.6rem;background:#18c964;border-radius:50%;display:inline-block;margin-inline-start:.35rem}
  </style>
</head>
<body>
  <!-- ===== محتوای برنامهٔ تو =====
       اگر بدنهٔ اختصاصی داری، می‌تونی همین ساختار را نگه داری یا کلاً محتوای خودت را اینجا قرار بدی. -->
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 6px">DentalOS <small class="muted">• PWA</small><span class="okdot" title="Online"></span></h1>
      <p class="muted" style="margin:6px 0 0">نسخهٔ بهینه‌شده با PWA، سرویس‌ورکر، Supabase Realtime، و بکاپ/همگام‌سازی.</p>
    </div>
  </div>

  <noscript>برای استفاده از برنامه، جاوااسکریپت باید فعال باشد.</noscript>

  <!-- Supabase: مقداردهی با اطلاعاتی که دادی -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // *** داده‌هایی که خودت دادی ***
    const SUPABASE_URL = "https://poubooxbvvzbwyjlfmaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvdWJvb3hidnZ6Ynd5amxmbWFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDgxODUsImV4cCI6MjA3MTMyNDE4NX0.aaLn3sqzRr87zFegPqJyrrsbLrK5IF9JpdDjezpsTrQ";

    // ساخت کلاینت و در دسترس قرار دادن برای سایر اسکریپت‌ها (مثل backup.js)
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // نمونه‌ی ساده‌ی بررسی اتصال و نمایش نقطه سبز/خاکستری
    const dot = document.querySelector('.okdot');
    const ping = () => navigator.onLine ? dot.style.background = '#18c964' : dot.style.background = '#999';
    window.addEventListener('online', ping);
    window.addEventListener('offline', ping);
    ping();
  </script>

  <!-- ثبت سرویس‌ورکر (مسیر نسبی + آپدیت خودکار + جلوگیری از تداخل پروژه‌های دیگر) -->
  <script>
  (async () => {
    if (!('serviceWorker' in navigator)) return;

    // 1) اگر قبلاً سرویس‌ورکرِ ریشهٔ دامنه ثبت شده، آن‌را آزاد کن (تا برنامهٔ دیگری لود نشود)
    try {
      const regs = await navigator.serviceWorker.getRegistrations();
      regs.forEach(r => {
        // سرویس‌ورکرهایی که scope ریشه دارند را حذف کن
        const u = new URL(r.scope);
        if (u.pathname === '/' || u.pathname === '/index.html') r.unregister();
      });
    } catch(e){/*ignore*/}

    // 2) ثبت سرویس‌ورکر همین پروژه با اسکوپ نسبی
    try {
      const reg = await navigator.serviceWorker.register('./service-worker.js', { scope: './' });

      // آپدیت خودکار
      function activateNow(worker){
        if (worker) worker.postMessage({ type: 'SKIP_WAITING' });
      }
      if (reg.waiting) activateNow(reg.waiting);

      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            activateNow(nw);
          }
        });
      });

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // وقتی ورکر جدید کنترل صفحه را گرفت، یک بار رفرش نرم
        location.reload();
      });
    } catch(e){
      console.warn('SW register failed:', e);
    }
  })();
  </script>

  <!-- بکاپ/همگام‌سازی آفلاین → فایل‌هایی که قبلاً ساختیم -->
  <script type="module" src="./backup.js"></script>
</body>
</html>
